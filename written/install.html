
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Installation &#8212; pwtools  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Tutorial" href="tutorial.html" />
    <link rel="prev" title="Features" href="features.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/logo.png" alt="Logo"/>
    
    <h1 class="logo logo-name">pwtools</h1>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=elcorto&repo=pwtools&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../generated/api/index.html">API Reference</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="features.html">Features</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#quick-start">Quick start</a></li>
<li class="toctree-l2"><a class="reference internal" href="#detailed-instructions">Detailed instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-tests">Running tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#python-versions">Python versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fortran-extensions-and-openmp-notes">Fortran extensions and OpenMP notes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="background/index.html">Background, details, special topics</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">&lt;no title&gt;</a><ul>
      <li>Previous: <a href="features.html" title="previous chapter">Features</a></li>
      <li>Next: <a href="tutorial.html" title="next chapter">Tutorial</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="installation">
<h1>Installation<a class="headerlink" href="#installation" title="Permalink to this heading">¶</a></h1>
<section id="quick-start">
<h2>Quick start<a class="headerlink" href="#quick-start" title="Permalink to this heading">¶</a></h2>
<p>Debian and derivatives: Fortran compiler, Python headers, lapack</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ sudo apt install python3-dev gfortran liblapack-dev
</pre></div>
</div>
<p>Then</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># &lt;&lt;probably make a venv&gt;&gt;</span>
$ pip install git+https://github.com/elcorto/pwtools
</pre></div>
</div>
<p>or</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/elcorto/pwtools
$ <span class="nb">cd</span> pwtools
$ pip install <span class="o">[</span>-e<span class="o">]</span> .
</pre></div>
</div>
</section>
<section id="detailed-instructions">
<h2>Detailed instructions<a class="headerlink" href="#detailed-instructions" title="Permalink to this heading">¶</a></h2>
<p>To build the extension modules and install all Python dependencies via
<code class="docutils literal notranslate"><span class="pre">pip</span></code></p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/elcorto/pwtools
$ pip install .
</pre></div>
</div>
<p>or the setuptools “development install” (no copy of files)</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ pip install -e .
</pre></div>
</div>
<p>In both cases we build the extension modules via</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> src <span class="o">&amp;&amp;</span> make clean <span class="o">&amp;&amp;</span> make <span class="nv">$PWTOOLS_EXT_MAKE_TARGET</span> <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ..
</pre></div>
</div>
<p>in the background, where <code class="docutils literal notranslate"><span class="pre">$PWTOOLS_EXT_MAKE_TARGET</span></code> is optional (more details
in the <a class="reference internal" href="#extensions"><span class="std std-ref">Fortran extensions and OpenMP notes</span></a> section).</p>
<p>If all dependencies are installed, e.g. by a package manager such as <code class="docutils literal notranslate"><span class="pre">apt</span></code>,
then recent <code class="docutils literal notranslate"><span class="pre">pip</span></code> versions should pick those up. Alternatively force <code class="docutils literal notranslate"><span class="pre">pip</span></code>
to install only the package without installing dependencies from pypi</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ pip install --no-deps .
</pre></div>
</div>
<p>When using a virtual environment, you can map in the system site-packages (here
we use <a class="reference external" href="https://virtualenvwrapper.readthedocs.io">virtualenvwrapper</a>)</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ mkvirtualenv --system-site-packages -p /usr/bin/python3 pwtools
<span class="o">(</span>pwtools<span class="o">)</span> $ pip install .
</pre></div>
</div>
<p>Alternatively, you may also simply build the extensions and set <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code></p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> src <span class="o">&amp;&amp;</span> make clean <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ..
$ <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$PYTHONPATH</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">pp</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>:<span class="nv">$PYTHONPATH</span> <span class="o">||</span> <span class="nv">pp</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>
$ <span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span><span class="nv">$pp</span>
</pre></div>
</div>
</section>
<section id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this heading">¶</a></h2>
<p>Python dependencies: see <code class="docutils literal notranslate"><span class="pre">requirements*.txt</span></code>. You can use
<code class="docutils literal notranslate"><span class="pre">test/check_dependencies.py</span></code> to find out what your system has installed</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ ./check_dependencies.py
requirements_test.txt
  pytest               ... ok <span class="o">(</span>import<span class="o">)</span>
  pytest-xdist         ... ok <span class="o">(</span>pip list<span class="o">)</span>
  pytest-timeout       ... ok <span class="o">(</span>pip list<span class="o">)</span>
requirements.txt
  PyCifRW              ... ok <span class="o">(</span>pip list<span class="o">)</span>
  h5py                 ... ok <span class="o">(</span>import<span class="o">)</span>
  matplotlib           ... ok <span class="o">(</span>import<span class="o">)</span>
  numpy                ... ok <span class="o">(</span>import<span class="o">)</span>
  scipy                ... ok <span class="o">(</span>import<span class="o">)</span>
  spglib               ... ok <span class="o">(</span>import<span class="o">)</span>
requirements_optional.txt
  ase                  ... ok <span class="o">(</span>import<span class="o">)</span>
  sklearn              ... ok <span class="o">(</span>import<span class="o">)</span>
requirements_doc.txt
  sphinx               ... ok <span class="o">(</span>import<span class="o">)</span>
optional executables:
  eos.x                ... NOT FOUND
</pre></div>
</div>
<p>Optional packages (<code class="docutils literal notranslate"><span class="pre">ase</span></code>, <code class="docutils literal notranslate"><span class="pre">sklearn</span></code>) are only used in corner cases and are
therefore not hard dependencies. Importing modules that use them (e.g. <code class="docutils literal notranslate"><span class="pre">crys</span></code>
might use <code class="docutils literal notranslate"><span class="pre">ase</span></code>) won’t fail at import time, but later at runtime when e.g.
<code class="docutils literal notranslate"><span class="pre">crys.Structure.get_ase_atoms()</span></code> is called. What packages are optional might
change depending on usage.</p>
<p>You also need the following to compile extensions. On a Debian-ish system</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># apt</span>
python3-dev     <span class="c1"># for compiling extensions</span>
gfortran        <span class="c1"># or ifort, see src/Makefile</span>
liblapack-dev
</pre></div>
</div>
<p>Also note that you can get may Python packages via your system’s package
manager</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python3-ase
python3-h5py
python3-matplotlib
python3-numpy
python3-pytest
python3-pytest-timeout
python3-pytest-xdist
python3-scipy
python3-sklearn
python3-sphinx
</pre></div>
</div>
<p>But usually not <code class="docutils literal notranslate"><span class="pre">PyCifRW</span></code> and <code class="docutils literal notranslate"><span class="pre">spglib</span></code>.</p>
<section id="optional-dependencies">
<h3>Optional dependencies<a class="headerlink" href="#optional-dependencies" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="http://www.ks.uiuc.edu/Research/vmd/">VMD</a> (<code class="docutils literal notranslate"><span class="pre">examples/rpdf/</span></code>, <a class="reference internal" href="../generated/api/pwtools.crys.call_vmd_measure_gofr.html#pwtools.crys.call_vmd_measure_gofr" title="pwtools.crys.call_vmd_measure_gofr"><code class="xref py py-func docutils literal notranslate"><span class="pre">call_vmd_measure_gofr()</span></code></a>,
<a class="reference internal" href="../generated/api/pwtools.visualize.view_vmd_axsf.html#pwtools.visualize.view_vmd_axsf" title="pwtools.visualize.view_vmd_axsf"><code class="xref py py-func docutils literal notranslate"><span class="pre">view_vmd_axsf()</span></code></a>,
<a class="reference internal" href="../generated/api/pwtools.visualize.view_vmd_xyz.html#pwtools.visualize.view_vmd_xyz" title="pwtools.visualize.view_vmd_xyz"><code class="xref py py-func docutils literal notranslate"><span class="pre">view_vmd_xyz()</span></code></a>), must register before download</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">fourier.x</span></code> tool from the <a class="reference external" href="http://www.cpmd.org">CPMD</a> contrib sources (for
<code class="docutils literal notranslate"><span class="pre">examples/</span></code>). Need to register before download.</p></li>
<li><p>eos (for <a class="reference internal" href="../generated/api/__sphinx_autodoc_module__pwtools.eos.html#module-pwtools.eos" title="pwtools.eos"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eos</span></code></a>): The tool “eos” from the <a class="reference external" href="http://elk.sourceforge.net">Elk</a> code must
be on your path. Note that the executable is assumed to be named <code class="docutils literal notranslate"><span class="pre">eos.x</span></code>
instead of the default name “eos”. See <a class="reference internal" href="../generated/api/pwtools.eos.ElkEOSFit.html#pwtools.eos.ElkEOSFit" title="pwtools.eos.ElkEOSFit"><code class="xref py py-class docutils literal notranslate"><span class="pre">ElkEOSFit</span></code></a> for
usage.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="../generated/api/pwtools.eos.ElkEOSFit.html#pwtools.eos.ElkEOSFit" title="pwtools.eos.ElkEOSFit"><code class="xref py py-class docutils literal notranslate"><span class="pre">ElkEOSFit</span></code></a> is deprecated, you don’t
really need the Elk code’s eos tool anymore. It was used to generate
reference EOS fit data for unit tests, which is stored in test/files/, but
there is no use of eos.x in pwtools anymore.</p>
</div>
</section>
</section>
<section id="running-tests">
<h2>Running tests<a class="headerlink" href="#running-tests" title="Permalink to this heading">¶</a></h2>
<p>See test/README. Actually, all of these are good examples, too!</p>
</section>
<section id="python-versions">
<h2>Python versions<a class="headerlink" href="#python-versions" title="Permalink to this heading">¶</a></h2>
<p>Only Python3 is supported, tested: Python 3.6-3.10</p>
<p>The package was developed mostly with Python 2.5-2.7 and ported using 2to3 +
manual changes. Therefore, you might find some crufty Python 2 style code
fragments in lesser used parts of the code base.</p>
</section>
<section id="fortran-extensions-and-openmp-notes">
<span id="extensions"></span><h2>Fortran extensions and OpenMP notes<a class="headerlink" href="#fortran-extensions-and-openmp-notes" title="Permalink to this heading">¶</a></h2>
<p>Use <code class="docutils literal notranslate"><span class="pre">src/Makefile</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ make <span class="nb">help</span>
make gfortran            <span class="c1"># gfortran, default</span>
make gfortran-omp        <span class="c1"># gfortran + OpenMP</span>
make gfortran-mkl        <span class="c1"># gfortran, Intel MKL lapack, set MKL_LIB</span>
make ifort               <span class="c1"># ifort</span>
make ifort-omp           <span class="c1"># ifort + OpenMP</span>
make ifort-mkl           <span class="c1"># ifort, Intel MKL lapack, set MKL_LIB</span>
</pre></div>
</div>
<p>Generates <code class="docutils literal notranslate"><span class="pre">*.so</span></code> and <code class="docutils literal notranslate"><span class="pre">*.pyf</span></code> (f2py interface) files.</p>
<p>You need:</p>
<ul class="simple">
<li><p>numpy for f2py</p></li>
<li><p>a Fortran compiler</p></li>
<li><p>Python headers (Debian/Ubuntu: python-dev)</p></li>
<li><p>Lapack (Debian: liblapack-dev)</p></li>
</ul>
<p>The module is compiled with f2py (currently part of numpy, tested with numpy
1.1.0 .. 1.21.x).</p>
<p>The default <code class="docutils literal notranslate"><span class="pre">make</span></code> target is “gfortran” which tries to build a serial version
using system BLAS and LAPACK (e.g. from <code class="docutils literal notranslate"><span class="pre">liblapack-dev</span></code>). If you want another
target (e.g. <code class="docutils literal notranslate"><span class="pre">ifort-mkl</span></code>), then</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> src
$ make clean
$ make ifort-mkl
</pre></div>
</div>
</div></blockquote>
<p>or when using <code class="docutils literal notranslate"><span class="pre">pip</span></code> (or anything calling <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>) set
<code class="docutils literal notranslate"><span class="pre">$PWTOOLS_EXT_MAKE_TARGET</span></code>.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ <span class="nv">PWTOOLS_EXT_MAKE_TARGET</span><span class="o">=</span>ifort-mkl pip install ...
</pre></div>
</div>
<p>This will use the Intel <code class="docutils literal notranslate"><span class="pre">ifort</span></code> compiler instead fo the default <code class="docutils literal notranslate"><span class="pre">gfortran</span></code> and
link against the MKL.</p>
<p>In the MKL case, the Makefile uses the env var <code class="docutils literal notranslate"><span class="pre">$MKL_LIB</span></code> which sould point
to the location where things like <code class="docutils literal notranslate"><span class="pre">libmkl_core.so</span></code> live. You may need to set
this. On a HPC cluster, that could look like this.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># module only sets MKL_ROOT=/path/to/intel/20.4/mkl</span>
$ module load intel/20.4
$ <span class="nv">MKL_LIB</span><span class="o">=</span><span class="nv">$MKL_ROOT</span>/lib/intel64 <span class="nv">PWTOOLS_EXT_MAKE_TARGET</span><span class="o">=</span>ifort-mkl pip install ...
</pre></div>
</div>
<p>See <code class="docutils literal notranslate"><span class="pre">src/Makefile</span></code> for more details.</p>
<section id="compiler-f2py">
<h3>Compiler / f2py<a class="headerlink" href="#compiler-f2py" title="Permalink to this heading">¶</a></h3>
<p>Instead of letting numpy.distutils pick a compiler + special flags, which is
not trivial and therefore almost never works, it is much easier to simply
define the compiler to use + architecture-specific flags. See F90 and ARCH in
the Makefile.</p>
<p>Also, numpy.distutils has default -03 for fcompiler. <code class="docutils literal notranslate"><span class="pre">--f90flags=&quot;-02&quot;</span></code> does NOT
override this. We get <code class="docutils literal notranslate"><span class="pre">-O3</span> <span class="pre">-O2</span></code> and a compiler warning. We have to use f2py’s
<code class="docutils literal notranslate"><span class="pre">--opt=</span></code> flag.</p>
<p>On some systems (Debian), you may have:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>/usr/bin/f2py -&gt; f2py2.6
/usr/bin/f2py2.5
/usr/bin/f2py2.6
</pre></div>
</div>
<p>and such. But usually <code class="docutils literal notranslate"><span class="pre">F2PY=f2py</span></code> is fine.</p>
</section>
<section id="openmp">
<h3>OpenMP<a class="headerlink" href="#openmp" title="Permalink to this heading">¶</a></h3>
<p>We managed to speed up the calculations by sprinkling some OpenMP
pragmas in <code class="docutils literal notranslate"><span class="pre">*.f90</span></code>. Use <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">ifort-omp</span></code> or <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">gfortran-omp</span></code> in that
case.</p>
<p>If all went well, <code class="docutils literal notranslate"><span class="pre">_flib.so</span></code> should be linked to <code class="docutils literal notranslate"><span class="pre">libgomp</span></code> (or <code class="docutils literal notranslate"><span class="pre">libiomp</span></code>
for <code class="docutils literal notranslate"><span class="pre">ifort</span></code>). Check with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ ldd _flib.so
</pre></div>
</div>
<p>Setting the number of threads:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">2</span>
$ python -c <span class="s2">&quot;import numpy as np; from pwtools.pydos import fvacf; \</span>
<span class="s2">             fvacf(np.random.rand(5000,1000,3))&quot;</span>
</pre></div>
</div>
<p>If this env var is NOT set, then OpenMP uses all available cores (e.g. 4 on a
quad-core box).</p>
<dl class="simple">
<dt>IMPORTANT:</dt><dd><p>Note that we may have found a f2py bug (see test/test_f2py_flib_openmp.py)
re. OMP_NUM_THREADS. We have a workaround for that in pydos.fvacf().</p>
</dd>
</dl>
<p>There is also an optional arg ‘nthreads’ to _flib.vacf(). If this is
supplied, then it will override OMP_NUM_THREADS. Currently, this is the
safest way to set the number of threads.</p>
</section>
<section id="tests">
<h3>Tests<a class="headerlink" href="#tests" title="Permalink to this heading">¶</a></h3>
<p>When developing OpenMP code, you may find that code doesn’t produce correct
results, even if it runs, if OpenMP is used incorrectly :) The test script
<code class="docutils literal notranslate"><span class="pre">test/runtests.sh</span></code> calls <cite>make gfortran-omp</cite>, so if code is broken by OpenMP,
all test using the Fortran extensions might fail. To run tests with other
builds, use one of</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ make gfortran
$ make ifort
$ make ifort-omp
</pre></div>
</div>
<p>and</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nb">test</span>
$ ./runtests.sh --nobuild
</pre></div>
</div>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2022, Steve Schmerler.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/written/install.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>