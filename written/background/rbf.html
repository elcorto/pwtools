
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Radial Basis Function interpolation an regression &#8212; pwtools  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Pwscf" href="pwscf.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo.png" alt="Logo"/>
    
    <h1 class="logo logo-name">pwtools</h1>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=elcorto&repo=pwtools&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../generated/api/index.html">API Reference</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">Tutorial</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Background, details, special topics</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ase.html">Relation to ASE</a></li>
<li class="toctree-l2"><a class="reference internal" href="coord_trans.html">Coordinate transformation</a></li>
<li class="toctree-l2"><a class="reference internal" href="param_study.html">Parameter studies</a></li>
<li class="toctree-l2"><a class="reference internal" href="parsing.html">Parsing code output and using containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="phonon_dos.html">Velocity autocorrelation function and phonon DOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="pwscf.html">Pwscf</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Radial Basis Function interpolation an regression</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">&lt;no title&gt;</a><ul>
  <li><a href="index.html">Background, details, special topics</a><ul>
      <li>Previous: <a href="pwscf.html" title="previous chapter">Pwscf</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="radial-basis-function-interpolation-an-regression">
<span id="rbf"></span><h1>Radial Basis Function interpolation an regression<a class="headerlink" href="#radial-basis-function-interpolation-an-regression" title="Permalink to this headline">¶</a></h1>
<p>Some background information on the method implemented in <code class="xref py py-mod docutils literal notranslate"><span class="pre">rbf</span></code>.
For code examples, see the doc string of <a class="reference internal" href="../../generated/api/pwtools.rbf.core.Rbf.html#pwtools.rbf.core.Rbf" title="pwtools.rbf.core.Rbf"><code class="xref py py-class docutils literal notranslate"><span class="pre">Rbf</span></code></a> and
<code class="docutils literal notranslate"><span class="pre">examples/rbf</span></code>.</p>
<section id="theory">
<h2>Theory<a class="headerlink" href="#theory" title="Permalink to this headline">¶</a></h2>
<p>The goal is to interpolate or fit an unordered set of <span class="math notranslate nohighlight">\(M\)</span> ND data points
<span class="math notranslate nohighlight">\(\mathbf x_i\)</span> and values <span class="math notranslate nohighlight">\(z_i\)</span> so as to obtain <span class="math notranslate nohighlight">\(z=f(\mathbf
x)\)</span>. In radial basis function (RBF) interpolation, the interpolating function
<span class="math notranslate nohighlight">\(f(\mathbf x)\)</span> is a linear combination of RBFs <span class="math notranslate nohighlight">\(\phi(r)\)</span></p>
<div class="math notranslate nohighlight">
\[f(\mathbf x) = \sum_j w_j\,\phi(|\mathbf x - \mathbf c_j|)\]</div>
<p>with the weights <span class="math notranslate nohighlight">\(w_j\)</span> and the center points <span class="math notranslate nohighlight">\(\mathbf c_j\)</span>.</p>
<p>An RBF <span class="math notranslate nohighlight">\(\phi(r)\)</span> is a function of the distance <span class="math notranslate nohighlight">\(r=|\mathbf x -
\mathbf c_j|\)</span> between <span class="math notranslate nohighlight">\(\mathbf x\)</span> and a center point. Common functions
include</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align}
    &amp; \phi(r) = \exp\left(-\frac{r^2}{2\,p^2}\right) &amp;&amp; \text{Gaussian}\\
    &amp; \phi(r) = \sqrt{r^2 + p^2} &amp;&amp; \text{multiquadric}\\
    &amp; \phi(r) = \frac{1}{\sqrt{r^2 + p^2}} &amp;&amp; \text{inverse multiquadric}
\end{align}\end{split}\]</div>
<p>All RBFs contain a single parameter <span class="math notranslate nohighlight">\(p\)</span> which defines the length scale of the
function.</p>
<img alt="../../_images/rbfs.png" src="../../_images/rbfs.png" />
<p>In interpolation the center points <span class="math notranslate nohighlight">\(\mathbf c_j\)</span> are equal to the data points
<span class="math notranslate nohighlight">\(\mathbf x_j\)</span> such that</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{gather}
    z_i = f(\mathbf x_i) = \sum_j w_j\,\phi(|\mathbf x_i - \mathbf x_j|) = \sum_j w_j\,K_{ij}\\
    \mathbf K\,\mathbf w = \mathbf z\\
\end{gather}\end{split}\]</div>
<p>with <span class="math notranslate nohighlight">\(\mathbf K\)</span> the <span class="math notranslate nohighlight">\(M\times M\)</span> matrix of RBF function values. The
weights <span class="math notranslate nohighlight">\(\mathbf w = (w_j)\)</span> are found by solving the linear system
<span class="math notranslate nohighlight">\(\mathbf K\,\mathbf w = \mathbf z\)</span>.</p>
<p>Note that for certain values of <span class="math notranslate nohighlight">\(p\)</span>, <span class="math notranslate nohighlight">\(\mathbf K\)</span> may become
singular. Then one should solve a regression problem instead (see below).</p>
</section>
<section id="rbf-parameter-p">
<h2>RBF parameter <span class="math notranslate nohighlight">\(p\)</span><a class="headerlink" href="#rbf-parameter-p" title="Permalink to this headline">¶</a></h2>
<p>Each RBF has a single “length scale” parameter <span class="math notranslate nohighlight">\(p\)</span> (<code class="docutils literal notranslate"><span class="pre">Rbf(p=...)</span></code>,
attribute <code class="docutils literal notranslate"><span class="pre">Rbf.p</span></code>). While <span class="math notranslate nohighlight">\(f(\mathbf x)\)</span> goes through all points
(<span class="math notranslate nohighlight">\(\mathbf x_i\)</span>, <span class="math notranslate nohighlight">\(z_i\)</span>) by definition in interpolation, the behavior
between points is determined by <span class="math notranslate nohighlight">\(p\)</span> where e.g. very narrow functions
<span class="math notranslate nohighlight">\(\phi\)</span> can lead to oscillations between points. Therefore <span class="math notranslate nohighlight">\(p\)</span> must
be optimized for the data set at hand, which should be done by cross-validation
as explained below.</p>
<p>Nevertheless we provide two methods to estimate reasonable start values.</p>
<p>The scipy implementation <span class="math notranslate nohighlight">\(p_{\text{scipy}}\)</span> in
<code class="xref py py-class docutils literal notranslate"><span class="pre">scipy.interpolate.Rbf</span></code> uses something like the mean nearest neighbor
distance. We provide this as <code class="docutils literal notranslate"><span class="pre">Rbf(points,</span> <span class="pre">values,</span> <span class="pre">p='scipy')</span></code> or
<code class="docutils literal notranslate"><span class="pre">rbf.estimate_p(points,</span> <span class="pre">'scipy')</span></code>. The default in <code class="xref py py-class docutils literal notranslate"><span class="pre">pwtools.rbf.Rbf</span></code>
however is the mean distance of all points</p>
<div class="math notranslate nohighlight">
\[p_{\text{pwtools}}=1/M^2\,\sum_{ij} |\mathbf x_i - \mathbf x_j|\]</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">Rbf(points,</span> <span class="pre">values,</span> <span class="pre">p='mean')</span></code> or <code class="docutils literal notranslate"><span class="pre">rbf.estimate_p(points,</span> <span class="pre">'mean')</span></code>.
This is always bigger than <span class="math notranslate nohighlight">\(p_{\text{scipy}}\)</span> and can be a better start
guess for <span class="math notranslate nohighlight">\(p\)</span>, especially in case of regression.</p>
</section>
<section id="interpolation-vs-regression-regularization-and-numerical-stability">
<h2>Interpolation vs. regression, regularization and numerical stability<a class="headerlink" href="#interpolation-vs-regression-regularization-and-numerical-stability" title="Permalink to this headline">¶</a></h2>
<p>In case of noisy data, we may want to do regression. Similar to the <cite>s</cite>
parameter of <code class="xref py py-func docutils literal notranslate"><span class="pre">scipy.interpolate.bisplrep()</span></code> or the <cite>smooth</cite> parameter for
regularization in <code class="xref py py-class docutils literal notranslate"><span class="pre">scipy.interpolate.Rbf</span></code>, we solve a regularized
version of the linear system</p>
<div class="math notranslate nohighlight">
\[(\mathbf K + r\,\mathbf I)\,\mathbf w = \mathbf z\]</div>
<p>using, for instance, <code class="docutils literal notranslate"><span class="pre">Rbf(points,</span> <span class="pre">values,</span> <span class="pre">r=1e-8)</span></code> (attribute <code class="docutils literal notranslate"><span class="pre">Rbf.r</span></code>).
This creates a more “stiff” (low curvature) function <span class="math notranslate nohighlight">\(f(\mathbf x)\)</span> which
does not necessarily interpolate all points. If the RBF happens to imply a
Mercer kernel (which the Gaussian one does), then this is equal to Kernel Ridge
Regression.</p>
<p>Apart from smoothing, the regularization also deals with the numerical
instability of <span class="math notranslate nohighlight">\(\mathbf K\,\mathbf w = \mathbf z\)</span>.</p>
<p>One can also switch from <code class="xref py py-func docutils literal notranslate"><span class="pre">scipy.linalg.solve()</span></code> to
<code class="xref py py-func docutils literal notranslate"><span class="pre">scipy.linalg.lstsq()</span></code> and solve the system in a least squares sense
without regularization. You can do that by setting <code class="docutils literal notranslate"><span class="pre">Rbf(...,</span> <span class="pre">r=None</span></code>) which
is also the default, since we don’t like to set a specific value for
<span class="math notranslate nohighlight">\(r&gt;0\)</span> because that depends entirely on the data set. In
<a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.kernel_ridge.KernelRidge.html#sklearn.kernel_ridge.KernelRidge" title="(in scikit-learn v1.0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">sklearn.kernel_ridge.KernelRidge</span></code></a> the switch to least squares is done
automatically when a singular <span class="math notranslate nohighlight">\(\mathbf K\)</span> is detected. However, we
observed that in some cases this results in small numerical noise in the
solution, so test before using and maybe switch to regularization in that case.</p>
</section>
<section id="how-to-determine-p-and-r">
<h2>How to determine <span class="math notranslate nohighlight">\(p\)</span> and <span class="math notranslate nohighlight">\(r\)</span><a class="headerlink" href="#how-to-determine-p-and-r" title="Permalink to this headline">¶</a></h2>
<p><span class="math notranslate nohighlight">\(p\)</span> (and <span class="math notranslate nohighlight">\(r\)</span>) should always be tuned to the data set at hand by
minimization of a cross validation (CV) score. You can do this with
<a class="reference internal" href="../../generated/api/pwtools.rbf.hyperopt.fit_opt.html#pwtools.rbf.hyperopt.fit_opt" title="pwtools.rbf.hyperopt.fit_opt"><code class="xref py py-func docutils literal notranslate"><span class="pre">pwtools.rbf.hyperopt.fit_opt()</span></code></a>. Here is an example where we optimize only
<span class="math notranslate nohighlight">\(p\)</span>, with <span class="math notranslate nohighlight">\(r\)</span> constant and very small such as <code class="docutils literal notranslate"><span class="pre">1e-11</span></code> or
<code class="docutils literal notranslate"><span class="pre">r=None</span></code> (least squares solver). See <code class="docutils literal notranslate"><span class="pre">examples/rbf/overfit.py</span></code>.</p>
<img alt="../../_images/overfit_reg.png" src="../../_images/overfit_reg.png" />
<p>We observe a flat CV score above <span class="math notranslate nohighlight">\(p&gt;1\)</span> without a pronounced global
minimimum, even though we find a shallow one at around <span class="math notranslate nohighlight">\(p=13\)</span>, while the
MSE loss (fit error) would suggest a very small <span class="math notranslate nohighlight">\(p\)</span> value (i.e.
interpolation or “zero training loss” in ML terms).</p>
<p>Now we investigate <span class="math notranslate nohighlight">\(p\)</span> and <span class="math notranslate nohighlight">\(r\)</span> (see
<code class="docutils literal notranslate"><span class="pre">examples/rbf/crossval_map_p_r.py</span></code>) by plotting the CV score as function both.
This is the result for the Gaussian RBF.</p>
<img alt="../../_images/crossval_pr_gauss.png" src="../../_images/crossval_pr_gauss.png" />
<p>When <span class="math notranslate nohighlight">\(r &lt; 10^{-6}\)</span>, it basically doesn’t matter which <span class="math notranslate nohighlight">\(p\)</span> we use,
as long as it is big enough to not overfit, i.e. <span class="math notranslate nohighlight">\(p&gt;1\)</span>. In these regions,
both <span class="math notranslate nohighlight">\(p\)</span> and <span class="math notranslate nohighlight">\(r\)</span> provide stiffness. The large <span class="math notranslate nohighlight">\(p\)</span>-<span class="math notranslate nohighlight">\(r\)</span>
valley of low CV score is flat and a bit rugged such that there is no
pronounced global optimum, as shown above for <span class="math notranslate nohighlight">\(r=10^{-11}\)</span>. As we incease
<span class="math notranslate nohighlight">\(r\)</span> (stronger regularization = stronger smoothing) we are restricted to
lower <span class="math notranslate nohighlight">\(p\)</span> (narrow RBFs which can overfit) since the now higher
<span class="math notranslate nohighlight">\(r\)</span> already provides enough stiffness to prevent overfitting.</p>
</section>
<section id="data-scaling">
<h2>Data scaling<a class="headerlink" href="#data-scaling" title="Permalink to this headline">¶</a></h2>
<p>In <a class="reference internal" href="../../generated/api/pwtools.num.PolyFit.html#pwtools.num.PolyFit" title="pwtools.num.PolyFit"><code class="xref py py-class docutils literal notranslate"><span class="pre">pwtools.num.PolyFit</span></code></a> (see the <cite>scale</cite> keyword) we scale
<span class="math notranslate nohighlight">\(\mathbf x\)</span> and <span class="math notranslate nohighlight">\(z\)</span> to <span class="math notranslate nohighlight">\([0,1]\)</span>. Here we don’t have that
implemented but suggest to always scale at least <span class="math notranslate nohighlight">\(z\)</span>. Since in contrast
to polynomials, the model here has no constant bias term, one should instead
normalize to zero mean using something like
<a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.StandardScaler.html#sklearn.preprocessing.StandardScaler" title="(in scikit-learn v1.0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">sklearn.preprocessing.StandardScaler</span></code></a>.</p>
</section>
<section id="other-implementations">
<h2>Other implementations<a class="headerlink" href="#other-implementations" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">scipy.interpolate.Rbf</span></code></p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2022, Steve Schmerler.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/written/background/rbf.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>