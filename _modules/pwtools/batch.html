<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pwtools.batch &#8212; pwtools  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=3b47c8d5" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo.png" alt="Logo" />
    
    <h1 class="logo logo-name">pwtools</h1>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=elcorto&repo=pwtools&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../generated/api/index.html">API Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../written/features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../written/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../written/tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../written/background/index.html">Background, details, special topics</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pwtools.batch</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Callable</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">pwtools</span> <span class="kn">import</span> <span class="n">common</span>
<span class="kn">from</span> <span class="nn">pwtools.sql</span> <span class="kn">import</span> <span class="n">SQLEntry</span><span class="p">,</span> <span class="n">SQLiteDB</span>
<span class="kn">from</span> <span class="nn">pwtools.verbose</span> <span class="kn">import</span> <span class="n">verbose</span>

<span class="n">pj</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span>


<div class="viewcode-block" id="Machine">
<a class="viewcode-back" href="../../generated/api/pwtools.batch.Machine.html#pwtools.batch.Machine">[docs]</a>
<span class="k">class</span> <span class="nc">Machine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Container for machine-specific stuff.</span>

<span class="sd">    Most of the machine-specific settings can (and should) be placed in the</span>
<span class="sd">    corresponding job template file. But some settings need to be in sync</span>
<span class="sd">    between files like the scratch dir, the $HOME etc.</span>

<span class="sd">    Useful to predefine commonly used machines.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Machine.__init__">
<a class="viewcode-back" href="../../generated/api/pwtools.batch.Machine.html#pwtools.batch.Machine.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subcmd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scratch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">home</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hostname : st</span>
<span class="sd">            machine name (&#39;mars&#39;, &#39;local&#39;, ...)</span>
<span class="sd">        subcmd : str</span>
<span class="sd">            shell command to submit jobfiles (e.g. &#39;bsub &lt;&#39;, &#39;qsub&#39;)</span>
<span class="sd">        scratch : str</span>
<span class="sd">            scratch dir (like &#39;/scratch&#39;)</span>
<span class="sd">        home : str</span>
<span class="sd">            $HOME</span>
<span class="sd">        template : FileTemplate</span>
<span class="sd">        filename : str</span>
<span class="sd">            full jobfile name for FileTemplate (e.g.</span>
<span class="sd">            &#39;calc.templ/job.local&#39;), use either this or `template`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">[</span><span class="n">filename</span><span class="p">,</span> <span class="n">template</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;use either `filename` &quot;</span>
                                              <span class="s2">&quot;or `template`&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">hostname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subcmd</span> <span class="o">=</span> <span class="n">subcmd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scratch</span> <span class="o">=</span> <span class="n">scratch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">home</span> <span class="o">=</span> <span class="n">home</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_lst</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subcmd&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;scratch&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;home&#39;</span><span class="p">,</span>
                         <span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">FileTemplate</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="Machine.get_jobfile_basename">
<a class="viewcode-back" href="../../generated/api/pwtools.batch.Machine.get_jobfile_basename.html#pwtools.batch.Machine.get_jobfile_basename">[docs]</a>
    <span class="k">def</span> <span class="nf">get_jobfile_basename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">basename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;cannot get job file name&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Machine.get_sql_record">
<a class="viewcode-back" href="../../generated/api/pwtools.batch.Machine.get_sql_record.html#pwtools.batch.Machine.get_sql_record">[docs]</a>
    <span class="k">def</span> <span class="nf">get_sql_record</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a dict of SQLEntry instances. Each key is a attr name from</span>
<span class="sd">        self.attr_lst. &quot;&quot;&quot;</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_lst</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">SQLEntry</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">sqlval</span><span class="o">=</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dct</span></div>
</div>



<div class="viewcode-block" id="FileTemplate">
<a class="viewcode-back" href="../../generated/api/pwtools.batch.FileTemplate.html#pwtools.batch.FileTemplate">[docs]</a>
<span class="k">class</span> <span class="nc">FileTemplate</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class to represent a template file in parameter studies.</span>

<span class="sd">    Each template file is supposed to contain a number of placeholder strings</span>
<span class="sd">    (e.g. XXXFOO or @foo@ or whatever other form). The `dct` passed to</span>
<span class="sd">    self.write() is a dict which contains key-value pairs for replacement (e.g.</span>
<span class="sd">    {&#39;foo&#39;: 1.0, &#39;bar&#39;: &#39;say-what&#39;}, keys=dct.keys()). Each key is converted to</span>
<span class="sd">    a placeholder by `func`.</span>

<span class="sd">    We use common.template_replace(..., mode=&#39;txt&#39;). dict-style placeholders</span>
<span class="sd">    like &quot;%(foo)s %(bar)i&quot; will not work.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    This will take a template file calc.templ/pw.in, replace the placeholders</span>
<span class="sd">    &quot;@prefix@&quot; and &quot;@ecutwfc@&quot; with some values and write the file to</span>
<span class="sd">    calc/0/pw.in .</span>

<span class="sd">    Fist, set up a dictionary which maps placeholder to values. Remember,</span>
<span class="sd">    that the placeholders in the files will be obtained by processing the</span>
<span class="sd">    dictionary keys with `func`. In the example, this will be::</span>

<span class="sd">        &#39;prefix&#39; -&gt; &#39;@prefix@&#39;</span>
<span class="sd">        &#39;ecutwfc&#39; -&gt; &#39;@ecutwfc@&#39;</span>

<span class="sd">    ::</span>

<span class="sd">        &gt;&gt;&gt; dct = {}</span>
<span class="sd">        &gt;&gt;&gt; dct[&#39;prefix&#39;] = &#39;foo_run_1&#39;</span>
<span class="sd">        &gt;&gt;&gt; dct[&#39;ecutwfc&#39;] = 23.0</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Not specifying the `keys` agrument to FileTemplate will instruct the</span>
<span class="sd">        &gt;&gt;&gt; # write() method to replace all placeholders in the template file which</span>
<span class="sd">        &gt;&gt;&gt; # match the placeholders defined by dct.keys(). This is the most simple</span>
<span class="sd">        &gt;&gt;&gt; # case.</span>
<span class="sd">        &gt;&gt;&gt; #</span>
<span class="sd">        &gt;&gt;&gt; templ = FileTemplate(filename=&#39;calc.templ/pw.in&#39;,</span>
<span class="sd">        ...                      func=lambda x: &quot;@%s@&quot; %x)</span>
<span class="sd">        &gt;&gt;&gt; templ.write(dct, &#39;calc/0&#39;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Now with `keys` explicitely.</span>
<span class="sd">        &gt;&gt;&gt; templ = FileTemplate(filename=&#39;calc.templ/pw.in&#39;,</span>
<span class="sd">        ...                      keys=[&#39;prefix&#39;, &#39;ecutwfc&#39;],</span>
<span class="sd">        ...                      func=lambda x: &quot;@%s@&quot; %x)</span>
<span class="sd">        &gt;&gt;&gt; templ.write(dct, &#39;calc/0&#39;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # or with SQL foo in a parameter study</span>
<span class="sd">        &gt;&gt;&gt; from sql import SQLEntry</span>
<span class="sd">        &gt;&gt;&gt; dct = {}</span>
<span class="sd">        &gt;&gt;&gt; dct[&#39;prefix&#39;]  = SQLEntry(sqlval=&#39;foo_run_1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; sct[&#39;ecutwfc&#39;] = SQLEntry(sqlval=23.0)</span>
<span class="sd">        &gt;&gt;&gt; templ.writesql(dct, &#39;calc/0&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="FileTemplate.__init__">
<a class="viewcode-back" href="../../generated/api/pwtools.batch.FileTemplate.html#pwtools.batch.FileTemplate.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">txt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">templ_dir</span><span class="o">=</span><span class="s1">&#39;calc.templ&#39;</span><span class="p">,</span>
                 <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="s1">&#39;XXX&#39;</span><span class="o">+</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        basename : string</span>
<span class="sd">            | The name of the template file and target file.</span>
<span class="sd">            | example: basename = pw.in</span>
<span class="sd">            |     template = calc.templ/pw.in</span>
<span class="sd">            |     target   = calc/0/pw.in</span>
<span class="sd">        txt : string, optional</span>
<span class="sd">            Text of the template file. If None, then we assume a file</span>
<span class="sd">            ``templ_dir/basename`` and read that.</span>
<span class="sd">        keys : {None, list of strings, []}</span>
<span class="sd">            | keys=None: All keys dct.keys() in self.write() are used. This is</span>
<span class="sd">            |     useful if you have a dict holding many keys, whose placeholders</span>
<span class="sd">            |     are spread across files. Then this will just replace every</span>
<span class="sd">            |     match in each file. This is what most people want.</span>
<span class="sd">            | keys=[&lt;key1&gt;, &lt;key2&gt;, ...] : Each string is a key. Each key is</span>
<span class="sd">            |     connected to a placeholder in the template. See func. This is</span>
<span class="sd">            |     for binding keys to template files, i.e. replace only these</span>
<span class="sd">            |     keys.</span>
<span class="sd">            | keys=[]: The template file is simply copied to `calc_dir` (see</span>
<span class="sd">            |     self.write()).</span>
<span class="sd">        templ_dir : dir where the template lives (e.g. &#39;calc.templ&#39;)</span>
<span class="sd">        filename : str</span>
<span class="sd">            full file name of the template, then templ_dir=os.path.dirname(filename)</span>
<span class="sd">            and basename=os.path.basename(filename)</span>
<span class="sd">        func : callable</span>
<span class="sd">            | A function which takes a string (key) and returns a string, which</span>
<span class="sd">            | is the placeholder corresponding to that key.</span>
<span class="sd">            | example: (this is actually default)</span>
<span class="sd">            |     key = &quot;lala&quot;</span>
<span class="sd">            |     placeholder = &quot;XXXLALA&quot;</span>
<span class="sd">            |     func = lambda x: &quot;XXX&quot; + x.upper()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">basename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> \
               <span class="p">(</span><span class="s2">&quot;use either `filename` or `templ_dir` + `basename`&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span>
        <span class="c1"># We hardcode the convention that template and target files live in</span>
        <span class="c1"># different dirs and have the same name (&quot;basename&quot;) there.</span>
        <span class="c1">#   template = &lt;templ_dir&gt;/&lt;basename&gt;</span>
        <span class="c1">#   target   = &lt;calc_dir&gt;/&lt;basename&gt;</span>
        <span class="c1"># e.g.</span>
        <span class="c1">#   template = calc.templ/pw.in</span>
        <span class="c1">#   target   = calc/0/pw.in</span>
        <span class="c1"># Something like</span>
        <span class="c1">#   template = ./pw.in.templ</span>
        <span class="c1">#   target   = ./pw.in</span>
        <span class="c1"># is not possible.</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">templ_dir</span> <span class="o">=</span> <span class="n">templ_dir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basename</span> <span class="o">=</span> <span class="n">basename</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">pj</span><span class="p">(</span><span class="n">templ_dir</span><span class="p">,</span> <span class="n">basename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">templ_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span></div>


<div class="viewcode-block" id="FileTemplate.write">
<a class="viewcode-back" href="../../generated/api/pwtools.batch.FileTemplate.write.html#pwtools.batch.FileTemplate.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dct</span><span class="p">,</span> <span class="n">calc_dir</span><span class="o">=</span><span class="s1">&#39;calc&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;dct&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write file self.filename (e.g. calc/0/pw.in) by replacing</span>
<span class="sd">        placeholders in the template (e.g. calc.templ/pw.in).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dct : dict</span>
<span class="sd">            key-value pairs, dct.keys() are converted to placeholders with</span>
<span class="sd">            self.func()</span>
<span class="sd">        calc_dir : str</span>
<span class="sd">            the dir where to write the target file to</span>
<span class="sd">        mode : str, {&#39;dct&#39;, &#39;sql&#39;}</span>
<span class="sd">            | mode=&#39;dct&#39;: replacement values are dct[&lt;key&gt;]</span>
<span class="sd">            | mode=&#39;sql&#39;: replacement values are dct[&lt;key&gt;].fileval and every</span>
<span class="sd">            |     dct[&lt;key&gt;] is an SQLEntry instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dct&#39;</span><span class="p">,</span> <span class="s1">&#39;sql&#39;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;Wrong &#39;mode&#39; kwarg, use &#39;dct&#39; &quot;</span>
                                        <span class="s2">&quot;or &#39;sql&#39;&quot;</span><span class="p">)</span>
        <span class="c1"># copy_only : bypass reading the file and passing the text thru the</span>
        <span class="c1"># replacement machinery and getting the text back, unchanged. While</span>
        <span class="c1"># this works, it is slower and useless.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">_keys</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">copy_only</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_keys</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">warn_not_found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span>
                <span class="n">warn_not_found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">txt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">file_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">txt</span>
            <span class="n">copy_only</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">tgt</span> <span class="o">=</span> <span class="n">pj</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;write: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">tgt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">copy_only</span><span class="p">:</span>
            <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;write: ignoring input, just copying file to </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">tgt</span><span class="p">))</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">tgt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;dct&#39;</span><span class="p">:</span>
                    <span class="n">rules</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;sql&#39;</span><span class="p">:</span>
                    <span class="c1"># dct = sql_record, a list of SQLEntry&#39;s</span>
                    <span class="n">rules</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">fileval</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;mode&#39; must be wrong&quot;</span><span class="p">)</span>
            <span class="n">new_txt</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">template_replace</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span>
                                              <span class="n">rules</span><span class="p">,</span>
                                              <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;txt&#39;</span><span class="p">,</span>
                                              <span class="n">conv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">warn_not_found</span><span class="o">=</span><span class="n">warn_not_found</span><span class="p">,</span>
                                              <span class="n">warn_mult_found</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                              <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">common</span><span class="o">.</span><span class="n">file_write</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">new_txt</span><span class="p">)</span></div>


<div class="viewcode-block" id="FileTemplate.writesql">
<a class="viewcode-back" href="../../generated/api/pwtools.batch.FileTemplate.writesql.html#pwtools.batch.FileTemplate.writesql">[docs]</a>
    <span class="k">def</span> <span class="nf">writesql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql_record</span><span class="p">,</span> <span class="n">calc_dir</span><span class="o">=</span><span class="s1">&#39;calc&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sql_record</span><span class="p">,</span> <span class="n">calc_dir</span><span class="o">=</span><span class="n">calc_dir</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;sql&#39;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Calculation">
<a class="viewcode-back" href="../../generated/api/pwtools.batch.Calculation.html#pwtools.batch.Calculation">[docs]</a>
<span class="k">class</span> <span class="nc">Calculation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represent a single calculation.</span>

<span class="sd">    The calculation data will be placed, e.g., in dir calc_foo/0/. A</span>
<span class="sd">    Calculation is bound to one Machine. This class is usually not used on it&#39;s</span>
<span class="sd">    own, but only by ParameterStudy.</span>

<span class="sd">    The dir where file templates live is defined in the FileTemplates (usually</span>
<span class="sd">    &#39;calc.templ&#39;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># XXX ATM, the `params` argument is a list of SQLEntry instances which is</span>
    <span class="c1"># converted to a dict self.sql_record. This is fine in the context of</span>
    <span class="c1"># ParameterStudy (esp. with helper functions like sql.sql_column()) and</span>
    <span class="c1"># also necessary b/c ParameterStudy must know about sqlite types. (The fact</span>
    <span class="c1"># that it is a list rather then a dict in the first place is that the</span>
    <span class="c1"># parameter set usually comes from comb.nested_loops(), which returns</span>
    <span class="c1"># lists.)</span>
    <span class="c1">#</span>
    <span class="c1"># But this may be overly complicated if this class is used alone, where a</span>
    <span class="c1"># single Calculation will not write a sqlite database, just deal with</span>
    <span class="c1"># `templates`. Then a simple dict (without SQLEntry instances) to pass in</span>
    <span class="c1"># the params might do it. Keep in mind that in this situation, Calculation</span>
    <span class="c1"># should have no kowledge of sql at all. This is kept strictly in</span>
    <span class="c1"># ParameterStudy. Maybe allow `params` to be either a dict or a list of</span>
    <span class="c1"># SQLEntry instances. In the dict case, let get_sql_record() raise a</span>
    <span class="c1"># warning.</span>
<div class="viewcode-block" id="Calculation.__init__">
<a class="viewcode-back" href="../../generated/api/pwtools.batch.Calculation.html#pwtools.batch.Calculation.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">templates</span><span class="o">=</span><span class="p">[],</span> <span class="n">params</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">calc_dir</span><span class="o">=</span><span class="s1">&#39;calc_dir&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        machine : Machine, optional</span>
<span class="sd">            Used to add machine specific attributes. Pulled from</span>
<span class="sd">            Machine.get_sql_record(). Used for FileTemplate replacement.</span>
<span class="sd">        templates : sequence</span>
<span class="sd">            Sequence of FileTemplate instances.</span>
<span class="sd">        params : sequence of SQLEntry instances</span>
<span class="sd">            A single &quot;parameter set&quot;. The `key` attribute (=sql column name) of</span>
<span class="sd">            each SQLEntry will be converted to a placeholder in each</span>
<span class="sd">            FileTemplate and an attempt to replacement in the template files is</span>
<span class="sd">            made.</span>
<span class="sd">        calc_dir : str, optional</span>
<span class="sd">            Calculation directory to which input files are written (e.g.</span>
<span class="sd">            &#39;calc_foo/0/&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machine</span> <span class="o">=</span> <span class="n">machine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">templates</span> <span class="o">=</span> <span class="n">templates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_dir</span> <span class="o">=</span> <span class="n">calc_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sql_record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">sqlentry</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">sqlentry</span><span class="p">)</span> \
                                <span class="k">for</span> <span class="n">sqlentry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="c1"># add machine-specific stuff only for replacement, doesn&#39;t go into</span>
        <span class="c1"># database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sql_record_write</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_record</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sql_record_write</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">get_sql_record</span><span class="p">())</span>
            <span class="c1"># use machine.template if it has one</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">template</span><span class="p">)</span></div>


<div class="viewcode-block" id="Calculation.get_sql_record">
<a class="viewcode-back" href="../../generated/api/pwtools.batch.Calculation.get_sql_record.html#pwtools.batch.Calculation.get_sql_record">[docs]</a>
    <span class="k">def</span> <span class="nf">get_sql_record</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a dict of SQLEntry instances. Each key is a candidate</span>
<span class="sd">        placeholder for the FileTemplates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_record</span></div>


<div class="viewcode-block" id="Calculation.write_input">
<a class="viewcode-back" href="../../generated/api/pwtools.batch.Calculation.write_input.html#pwtools.batch.Calculation.write_input">[docs]</a>
    <span class="k">def</span> <span class="nf">write_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For each template in ``self.templates``, write an input file to</span>
<span class="sd">        ``self.calc_dir``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_dir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">templ</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">:</span>
            <span class="n">templ</span><span class="o">.</span><span class="n">writesql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_record_write</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_dir</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ParameterStudy">
<a class="viewcode-back" href="../../generated/api/pwtools.batch.ParameterStudy.html#pwtools.batch.ParameterStudy">[docs]</a>
<span class="k">class</span> <span class="nc">ParameterStudy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class to represent a parameter study (a number of Calculations,</span>
<span class="sd">    based on template files).</span>

<span class="sd">    The basic idea is to assemble all to-be-varied parameters in a script</span>
<span class="sd">    outside (`params_lst`) and pass these to this class along with a list of</span>
<span class="sd">    `templates` files, usually software input files. Then, a simple loop over</span>
<span class="sd">    the parameter sets is done and input files are written.</span>

<span class="sd">    Calculation dirs are numbered automatically. The default is</span>

<span class="sd">        ``calc_dir = &lt;calc_root&gt;/&lt;calc_dir_prefix&gt;_&lt;machine.hostname&gt;``, e.g.</span>
<span class="sd">        ``./calc_foo``</span>

<span class="sd">    and each calculation for each parameter set</span>

<span class="sd">        | ``./calc_foo/0``</span>
<span class="sd">        | ``./calc_foo/1``</span>
<span class="sd">        | ``./calc_foo/2``</span>
<span class="sd">        | ``...``</span>

<span class="sd">    A sqlite database ``calc_dir_root/&lt;db_name&gt;`` is written. If this class</span>
<span class="sd">    operates on a `calc_dir_root` where such a database already exists, then</span>
<span class="sd">    the default is to append new calculations. The numbering of calc dirs</span>
<span class="sd">    continues at the end. This can be changed with the `mode` kwarg of</span>
<span class="sd">    :meth:`~ParameterStudy.write_input`. By default, a sql column &quot;revision&quot; is</span>
<span class="sd">    added which numbers each addition.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; # Here are some examples for constructing `params_lst`.</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; # Vary two (three, ...) parameters on a 2d (3d, ...) grid: In fact, the</span>
<span class="sd">    &gt;&gt;&gt; # way you are constructing params_lst is only a matter of zip() and</span>
<span class="sd">    &gt;&gt;&gt; # comb.nested_loops()</span>
<span class="sd">    &gt;&gt;&gt; par1 = sql.sql_column(&#39;par1&#39;, [1,2,3])</span>
<span class="sd">    &gt;&gt;&gt; par2 = sql.sql_column(&#39;par2&#39;, [&#39;a&#39;,&#39;b&#39;])</span>
<span class="sd">    &gt;&gt;&gt; par3 = ...</span>
<span class="sd">    &gt;&gt;&gt; # 3d grid</span>
<span class="sd">    &gt;&gt;&gt; params_lst = comb.nested_loops([par1, par2, par3])</span>
<span class="sd">    &gt;&gt;&gt; # which is the same as:</span>
<span class="sd">    &gt;&gt;&gt; params_lst = []</span>
<span class="sd">    &gt;&gt;&gt; for par1 in [1,2,3]:</span>
<span class="sd">    ...     for par2 in [&#39;a&#39;,&#39;b&#39;]:</span>
<span class="sd">    ...         for par3 in [...]:</span>
<span class="sd">    ...             params_lst.append([sql.SQLEntry(key=&#39;par1&#39;, sqlval=par1),</span>
<span class="sd">    ...                                sql.SQLEntry(key=&#39;par2&#39;, sqlval=par2),</span>
<span class="sd">    ...                                sql.SQLEntry(key=&#39;par3&#39;, sqlval=par3),</span>
<span class="sd">    ...                                ])</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; # vary par1 and par2 together, and par3 -&gt; 2d grid w/ par1+par2 on one</span>
<span class="sd">    &gt;&gt;&gt; # axis and par3 on the other</span>
<span class="sd">    &gt;&gt;&gt; params_lst = comb.nested_loops([zip(par1, par2), par3], flatten=True)</span>

<span class="sd">    See ``examples/parameter_study/`` for complete examples, as well as</span>
<span class="sd">    ``test/test_parameter_study.py``.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    itertools.product</span>
<span class="sd">    :func:`pwtools.comb.nested_loops`</span>
<span class="sd">    :func:`pwtools.sql.sql_column`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># more notes</span>
    <span class="c1"># ----------</span>
    <span class="c1"># The `params_lst` list of lists is a &quot;matrix&quot; which in fact represents the</span>
    <span class="c1"># sqlite database table.</span>
    <span class="c1">#</span>
    <span class="c1"># The most simple case is when we vary only one parameter::</span>
    <span class="c1">#</span>
    <span class="c1">#     [[SQLEntry(key=&#39;foo&#39;, sqlval=1.0)],</span>
    <span class="c1">#      [SQLEntry(key=&#39;foo&#39;, sqlval=2.0)]]</span>
    <span class="c1">#</span>
    <span class="c1"># The sqlite database would have one column and look like this::</span>
    <span class="c1">#</span>
    <span class="c1">#     foo</span>
    <span class="c1">#     ---</span>
    <span class="c1">#     1.0   # calc_foo/0</span>
    <span class="c1">#     2.0   # calc_foo/1</span>
    <span class="c1">#</span>
    <span class="c1"># Note that you have one entry per row [[...], [...]], like in a</span>
    <span class="c1"># column vector, b/c &quot;foo&quot; is a *column* in the database and b/c each</span>
    <span class="c1"># calculation is represented by one row (record).</span>
    <span class="c1">#</span>
    <span class="c1"># Another example is a 2x2 setup (vary 2 parameters &#39;foo&#39; and &#39;bar&#39;)::</span>
    <span class="c1">#</span>
    <span class="c1">#     [[SQLEntry(key=&#39;foo&#39;, sqlval=1.0), SQLEntry(key=&#39;bar&#39;, sqlval=&#39;lala&#39;)],</span>
    <span class="c1">#      [SQLEntry(key=&#39;foo&#39;, sqlval=2.0), SQLEntry(key=&#39;bar&#39;, sqlval=&#39;huhu&#39;)]]</span>
    <span class="c1">#</span>
    <span class="c1"># Here we have 2 parameters &quot;foo&quot; and &quot;bar&quot; and the sqlite db would</span>
    <span class="c1"># thus have two columns::</span>
    <span class="c1">#</span>
    <span class="c1">#     foo   bar</span>
    <span class="c1">#     ---   ---</span>
    <span class="c1">#     1.0   lala  # calc_foo/0</span>
    <span class="c1">#     2.0   huhu  # calc_foo/1</span>
    <span class="c1">#</span>
    <span class="c1"># Each row (or record in sqlite) will be one Calculation, getting</span>
    <span class="c1"># it&#39;s own dir.</span>
<div class="viewcode-block" id="ParameterStudy.__init__">
<a class="viewcode-back" href="../../generated/api/pwtools.batch.ParameterStudy.html#pwtools.batch.ParameterStudy.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machines</span><span class="o">=</span><span class="p">[],</span> <span class="n">templates</span><span class="o">=</span><span class="p">[],</span> <span class="n">params_lst</span><span class="o">=</span><span class="p">[],</span> <span class="n">study_name</span><span class="o">=</span><span class="s1">&#39;calc&#39;</span><span class="p">,</span>
                 <span class="n">db_name</span><span class="o">=</span><span class="s1">&#39;calc.db&#39;</span><span class="p">,</span> <span class="n">db_table</span><span class="o">=</span><span class="s1">&#39;calc&#39;</span><span class="p">,</span> <span class="n">calc_root</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span>
                 <span class="n">calc_dir_prefix</span><span class="o">=</span><span class="s1">&#39;calc&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        machines : sequence or Machine</span>
<span class="sd">            List of Machine instances or a single Machine</span>
<span class="sd">        templates : see Calculation</span>
<span class="sd">        params_lst : list of lists</span>
<span class="sd">            The &quot;parameter sets&quot;. Each sublist is a set of calculation</span>
<span class="sd">            parameters as SQLEntry instances::</span>

<span class="sd">                [[SQLEntry(...), SQLEntry(...), ...], # calc_foo/0</span>
<span class="sd">                 [SQLEntry(...), SQLEntry(...), ...], # calc_foo/1</span>
<span class="sd">                 ...</span>
<span class="sd">                ]</span>

<span class="sd">            For each sublist, a separate calculation dir is created and</span>
<span class="sd">            populated with files based on `templates`. The `key` attribute of</span>
<span class="sd">            each SQLEntry will be converted to a placeholder in each</span>
<span class="sd">            FileTemplate and an attempt to replacement in the template files is</span>
<span class="sd">            made. Thus, the way placeholders are created is defined in</span>
<span class="sd">            FileTemplate, not here!</span>
<span class="sd">            Note: Each sublist (parameter set) is flattened, so that it</span>
<span class="sd">            can in fact be a nested list, e.g. params_lst = the result of a</span>
<span class="sd">            complex comb.nested_loops() call. Also, sublists need not have the</span>
<span class="sd">            same length or `key` attributes per entry (&quot;incomplete parameter</span>
<span class="sd">            sets&quot;). The sqlite table header is compiled from all distinct</span>
<span class="sd">            `key`s found.</span>
<span class="sd">        study_name : str, optional</span>
<span class="sd">            Name for the parameter study. From this, the `calc_name` for input</span>
<span class="sd">            files and job name etc. will be built. By default, a string</span>
<span class="sd">            &quot;_run&lt;idx&gt;&quot; is appended to create a unique name.</span>
<span class="sd">        db_name : str, optional</span>
<span class="sd">            Basename of the sqlite database.</span>
<span class="sd">        db_table : str, optional</span>
<span class="sd">            Name of the sqlite database table.</span>
<span class="sd">        calc_root : str, optional</span>
<span class="sd">            Root of all calc dirs.</span>
<span class="sd">        calc_dir_prefix : str, optional</span>
<span class="sd">            Prefix for the top calculation dir (e.g. &#39;calc&#39; for &#39;calc_foo&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machines</span> <span class="o">=</span> <span class="n">machines</span> <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">([])</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">machines</span><span class="p">))</span> <span class="k">else</span> <span class="p">[</span><span class="n">machines</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">templates</span> <span class="o">=</span> <span class="n">templates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_lst</span> <span class="o">=</span> <span class="n">params_lst</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">study_name</span> <span class="o">=</span> <span class="n">study_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_name</span> <span class="o">=</span> <span class="n">db_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_table</span> <span class="o">=</span> <span class="n">db_table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_root</span> <span class="o">=</span> <span class="n">calc_root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_dir_prefix</span> <span class="o">=</span> <span class="n">calc_dir_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbfn</span> <span class="o">=</span> <span class="n">pj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="ParameterStudy.write_input">
<a class="viewcode-back" href="../../generated/api/pwtools.batch.ParameterStudy.write_input.html#pwtools.batch.ParameterStudy.write_input">[docs]</a>
    <span class="k">def</span> <span class="nf">write_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sleep</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">excl</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create calculation dir(s) for each parameter set and write input files</span>
<span class="sd">        based on ``templates``. Write sqlite database storing all relevant</span>
<span class="sd">        parameters. Write (bash) shell script to start all calculations (run</span>
<span class="sd">        locally or submitt batch job file, depending on ``machine.subcmd``).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mode : str, optional</span>
<span class="sd">            Fine tune how to write input files (based on ``templates``) to calc</span>
<span class="sd">            dirs calc_foo/0/, calc_foo/1/, ... . Note that this doesn&#39;t change</span>
<span class="sd">            the base dir calc_foo at all, only the subdirs for each calc.</span>
<span class="sd">            {&#39;a&#39;, &#39;w&#39;}</span>

<span class="sd">            | &#39;a&#39;: Append mode (default). If a previous database is found, then</span>
<span class="sd">            |     subsequent calculations are numbered based on the last &#39;idx&#39;.</span>
<span class="sd">            |     calc_foo/0 # old</span>
<span class="sd">            |     calc_foo/1 # old</span>
<span class="sd">            |     calc_foo/2 # new</span>
<span class="sd">            |     calc_foo/3 # new</span>
<span class="sd">            | &#39;w&#39;: Write mode. The target dirs are purged and overwritten. Also,</span>
<span class="sd">            |     the database (self.dbfn) is overwritten. Use this to</span>
<span class="sd">            |     iteratively tune your inputs, NOT for working on already</span>
<span class="sd">            |     present results!</span>
<span class="sd">            |     calc_foo/0 # new</span>
<span class="sd">            |     calc_foo/1 # new</span>
<span class="sd">        backup : bool, optional</span>
<span class="sd">            Before writing anything, do a backup of self.calc_dir if it already</span>
<span class="sd">            exists.</span>
<span class="sd">        sleep : int, optional</span>
<span class="sd">            For the script to start (submitt) all jobs: time in seconds for the</span>
<span class="sd">            shell sleep(1) commmand.</span>
<span class="sd">        excl : bool</span>
<span class="sd">            If in append mode, a file &lt;calc_root&gt;/excl_push with all indices of</span>
<span class="sd">            calculations from old revisions is written. Can be used with</span>
<span class="sd">            ``rsync --exclude-from=excl_push`` when pushing appended new</span>
<span class="sd">            calculations to a cluster.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">],</span> <span class="s2">&quot;Unknown mode: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span><span class="n">mode</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfn</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">backup</span><span class="p">:</span>
                <span class="n">common</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfn</span><span class="p">)</span>
        <span class="n">have_new_db</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfn</span><span class="p">)</span>
        <span class="n">common</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_root</span><span class="p">)</span>
        <span class="c1"># this call creates a file ``self.dbfn`` if it doesn&#39;t exist</span>
        <span class="n">sqldb</span> <span class="o">=</span> <span class="n">SQLiteDB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfn</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_table</span><span class="p">)</span>
        <span class="c1"># max_idx: counter for calc dir numbering</span>
        <span class="n">revision</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">have_new_db</span><span class="p">:</span>
            <span class="n">max_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sqldb</span><span class="o">.</span><span class="n">has_column</span><span class="p">(</span><span class="s1">&#39;idx&#39;</span><span class="p">):</span>
                    <span class="n">max_idx</span> <span class="o">=</span> <span class="n">sqldb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select max(idx) from </span><span class="si">%s</span><span class="s2">&quot;</span> \
                    <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">db_table</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;database &#39;</span><span class="si">%s</span><span class="s2">&#39;: table &#39;</span><span class="si">%s</span><span class="s2">&#39; has no &quot;</span>
                          <span class="s2">&quot;column &#39;idx&#39;, don&#39;t know how to number calcs&quot;</span>
                          <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_table</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">sqldb</span><span class="o">.</span><span class="n">has_column</span><span class="p">(</span><span class="s1">&#39;revision&#39;</span><span class="p">):</span>
                    <span class="n">revision</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sqldb</span><span class="o">.</span><span class="n">get_single</span><span class="p">(</span><span class="s2">&quot;select max(revision) </span><span class="se">\</span>
<span class="s2">                        from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">db_table</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span>
                <span class="n">max_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">sql_records</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hostnames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">imach</span><span class="p">,</span> <span class="n">machine</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">machines</span><span class="p">):</span>
            <span class="n">hostnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span>
            <span class="n">calc_dir</span> <span class="o">=</span> <span class="n">pj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_dir_prefix</span> <span class="o">+</span> \
                          <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">machine</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">backup</span><span class="p">:</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -r </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">calc_dir</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">run_txt</span> <span class="o">=</span> <span class="s2">&quot;here=$(pwd)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">_idx</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_lst</span><span class="p">):</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">max_idx</span> <span class="o">+</span> <span class="n">_idx</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">calc_subdir</span> <span class="o">=</span> <span class="n">pj</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
                <span class="n">extra_dct</span> <span class="o">=</span> \
                    <span class="p">{</span><span class="s1">&#39;revision&#39;</span><span class="p">:</span> <span class="n">revision</span><span class="p">,</span>
                     <span class="s1">&#39;study_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">study_name</span><span class="p">,</span>
                     <span class="s1">&#39;idx&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span>
                     <span class="s1">&#39;calc_name&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">study_name</span> <span class="o">+</span> <span class="s2">&quot;_run</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">idx</span><span class="p">,</span>
                     <span class="p">}</span>
                <span class="n">extra_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQLEntry</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">sqlval</span><span class="o">=</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> \
                                <span class="n">extra_dct</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
                <span class="c1"># templates[:] to copy b/c they may be modified in Calculation</span>
                <span class="n">calc</span> <span class="o">=</span> <span class="n">Calculation</span><span class="p">(</span><span class="n">machine</span><span class="o">=</span><span class="n">machine</span><span class="p">,</span>
                                   <span class="n">templates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[:],</span>
                                   <span class="n">params</span><span class="o">=</span><span class="n">params</span> <span class="o">+</span> <span class="n">extra_params</span><span class="p">,</span>
                                   <span class="n">calc_dir</span><span class="o">=</span><span class="n">calc_subdir</span><span class="p">,</span>
                                   <span class="p">)</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">calc_subdir</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">calc_subdir</span><span class="p">)</span>
                <span class="n">calc</span><span class="o">.</span><span class="n">write_input</span><span class="p">()</span>
                <span class="n">run_txt</span> <span class="o">+=</span> <span class="s2">&quot;cd </span><span class="si">%i</span><span class="s2"> &amp;&amp; </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> &amp;&amp; cd $here &amp;&amp; sleep </span><span class="si">%i</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span>\
                            <span class="n">machine</span><span class="o">.</span><span class="n">subcmd</span><span class="p">,</span> <span class="n">machine</span><span class="o">.</span><span class="n">get_jobfile_basename</span><span class="p">(),</span> <span class="n">sleep</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">imach</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sql_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">get_sql_record</span><span class="p">())</span>
            <span class="n">common</span><span class="o">.</span><span class="n">file_write</span><span class="p">(</span><span class="n">pj</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">,</span> <span class="s1">&#39;run.sh&#39;</span><span class="p">),</span> <span class="n">run_txt</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">sql_records</span><span class="p">:</span>
            <span class="n">record</span><span class="p">[</span><span class="s1">&#39;hostname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SQLEntry</span><span class="p">(</span><span class="n">sqlval</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hostnames</span><span class="p">))</span>
        <span class="c1"># for incomplete parameters: collect header parts from all records and</span>
        <span class="c1"># make a set = unique entries</span>
        <span class="n">raw_header</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">sqltype</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">sql_records</span> \
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">raw_header</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">have_new_db</span><span class="p">:</span>
            <span class="n">sqldb</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">sql_records</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sqldb</span><span class="o">.</span><span class="n">has_column</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                        <span class="n">sqldb</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">sqltype</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">sql_records</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;insert into </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) values (</span><span class="si">%s</span><span class="s2">)&quot;</span>\
                <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_table</span><span class="p">,</span>
                  <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span>
                  <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;?&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
            <span class="n">sqldb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">sqlval</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">excl</span> <span class="ow">and</span> <span class="n">revision</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sqldb</span><span class="o">.</span><span class="n">has_column</span><span class="p">(</span><span class="s1">&#39;revision&#39;</span><span class="p">):</span>
            <span class="n">old_idx_lst</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="ow">in</span> <span class="n">sqldb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select idx from calc where </span><span class="se">\</span>
<span class="s2">                                                          revision &lt; ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">revision</span><span class="p">,))]</span>
            <span class="n">common</span><span class="o">.</span><span class="n">file_write</span><span class="p">(</span><span class="n">pj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_root</span><span class="p">,</span> <span class="s1">&#39;excl_push&#39;</span><span class="p">),</span>
                              <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">old_idx_lst</span><span class="p">))</span>
        <span class="n">sqldb</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="conv_table">
<a class="viewcode-back" href="../../generated/api/pwtools.batch.conv_table.html#pwtools.batch.conv_table">[docs]</a>
<span class="k">def</span> <span class="nf">conv_table</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">ffmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%15.4f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sfmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%15s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">,</span> <span class="n">orig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">absdiff</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convergence table. Assume that quantity `xx` was varied, resulting in</span>
<span class="sd">    `yy` values. Return a string (table) listing::</span>

<span class="sd">        x, dy1, dy2, ...</span>

<span class="sd">    Useful for quickly viewing the results of a convergence study, where we</span>
<span class="sd">    assume that the sequence of `yy` values converges to a constant value.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xx : 1d sequence</span>
<span class="sd">    yy : 1d sequence, nested 1d sequences, 2d array</span>
<span class="sd">        Values varied with `xx`. Each row is one parameter.</span>
<span class="sd">    ffmt, sfmt : str</span>
<span class="sd">        Format strings for floats (`ffmt`) and strings (`sfmt`)</span>
<span class="sd">    mode : str</span>
<span class="sd">        &#39;next&#39; or &#39;last&#39;. Difference to the next value ``y[i+1] - y[i]`` or to</span>
<span class="sd">        the last ``y[-1] - y[i]``.</span>
<span class="sd">    orig : bool</span>
<span class="sd">        Print original `yy` data as well.</span>
<span class="sd">    absdiff : bool</span>
<span class="sd">        absolute values of differences</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; kpoints = [&#39;2 2 2&#39;, &#39;4 4 4&#39;, &#39;8 8 8&#39;]</span>
<span class="sd">    &gt;&gt;&gt; etot = [-300.0, -310.0, -312.0]</span>
<span class="sd">    &gt;&gt;&gt; forces_rms = [0.3, 0.2, 0.1]</span>
<span class="sd">    &gt;&gt;&gt; print(batch.conv_table(kpoints, etot, mode=&#39;last&#39;))</span>
<span class="sd">          2 2 2       -12.0000</span>
<span class="sd">          4 4 4        -2.0000</span>
<span class="sd">          8 8 8         0.0000</span>
<span class="sd">    &gt;&gt;&gt; print(batch.conv_table(kpoints, [etot,forces_rms], mode=&#39;last&#39;))</span>
<span class="sd">          2 2 2       -12.0000        -0.2000</span>
<span class="sd">          4 4 4        -2.0000        -0.1000</span>
<span class="sd">          8 8 8         0.0000         0.0000</span>
<span class="sd">    &gt;&gt;&gt; print(batch.conv_table(kpoints, [etot,forces_rms], mode=&#39;last&#39;, orig=True))</span>
<span class="sd">          2 2 2       -12.0000      -300.0000        -0.2000         0.3000</span>
<span class="sd">          4 4 4        -2.0000      -310.0000        -0.1000         0.2000</span>
<span class="sd">          8 8 8         0.0000      -312.0000         0.0000         0.1000</span>
<span class="sd">    &gt;&gt;&gt; print(batch.conv_table(kpoints, np.array([etot,forces_rms]), mode=&#39;next&#39;))</span>
<span class="sd">          2 2 2       -10.0000        -0.1000</span>
<span class="sd">          4 4 4        -2.0000        -0.1000</span>
<span class="sd">          8 8 8         0.0000         0.0000</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">npoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">yy</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">T</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dyy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;next&#39;</span><span class="p">:</span>
            <span class="n">dyy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">iy</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">dyy</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">iy</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">yy</span><span class="p">[:,</span><span class="n">iy</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;last&#39;</span><span class="p">:</span>
            <span class="n">dyy</span><span class="p">[:,</span><span class="n">iy</span><span class="p">]</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">iy</span><span class="p">]</span> <span class="o">-</span> <span class="n">yy</span><span class="p">[:,</span><span class="n">iy</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unknown mode&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">absdiff</span><span class="p">:</span>
        <span class="n">dyy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dyy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">orig</span><span class="p">:</span>
        <span class="n">fmtstr</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span><span class="p">((</span><span class="n">sfmt</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ffmt</span><span class="p">,)</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">ny</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fmtstr</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">*</span><span class="p">(</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span><span class="p">((</span><span class="n">sfmt</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ffmt</span><span class="p">,)</span><span class="o">*</span><span class="n">ny</span><span class="p">)</span>
    <span class="n">st</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npoints</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">orig</span><span class="p">:</span>
            <span class="n">repl</span> <span class="o">=</span> <span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">idx</span><span class="p">],)</span> <span class="o">+</span> \
                <span class="nb">tuple</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">dyy</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">iy</span><span class="p">],</span><span class="n">yy</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">iy</span><span class="p">]]</span> <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">repl</span> <span class="o">=</span> <span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">idx</span><span class="p">],)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dyy</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">iy</span><span class="p">]</span> <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">))</span>
        <span class="n">st</span> <span class="o">+=</span> <span class="n">fmtstr</span> <span class="o">%</span><span class="n">repl</span>
    <span class="k">return</span> <span class="n">st</span></div>



<div class="viewcode-block" id="default_repl_keys">
<a class="viewcode-back" href="../../generated/api/pwtools.batch.default_repl_keys.html#pwtools.batch.default_repl_keys">[docs]</a>
<span class="k">def</span> <span class="nf">default_repl_keys</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a dict of default keys for replacement in a</span>
<span class="sd">    :class:`ParameterStudy`. Each key will in practice be processed by</span>
<span class="sd">    :class:`FileTemplate`, such that e.g. the key &#39;foo&#39; becomes the placeholder</span>
<span class="sd">    &#39;XXXFOO&#39;.</span>

<span class="sd">    Each of these placeholders can be used in any parameter study in any file</span>
<span class="sd">    template, indenpendent from `params_lst` to :class:`ParameterStudy`.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If this function is called, dummy files are written to a temp dir, the</span>
<span class="sd">    datsbase is read, and the file are deleted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># HACK!!! Due to the way ParameterStudy.write_input() is coded, we really</span>
    <span class="c1"># need to set up a dummy ParameterStudy and read out the database to get</span>
    <span class="c1"># the replacement keys :-)</span>
    <span class="kn">import</span> <span class="nn">tempfile</span>
    <span class="n">calc_root</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="n">jobfn_templ</span> <span class="o">=</span> <span class="n">pj</span><span class="p">(</span><span class="n">calc_root</span><span class="p">,</span> <span class="s1">&#39;foo.job&#39;</span><span class="p">)</span>
    <span class="n">common</span><span class="o">.</span><span class="n">file_write</span><span class="p">(</span><span class="n">jobfn_templ</span><span class="p">,</span> <span class="s1">&#39;dummy job template, go away!&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                <span class="n">template</span><span class="o">=</span><span class="n">FileTemplate</span><span class="p">(</span><span class="n">basename</span><span class="o">=</span><span class="s1">&#39;foo.job&#39;</span><span class="p">,</span>
                                      <span class="n">templ_dir</span><span class="o">=</span><span class="n">calc_root</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;writing test files to: </span><span class="si">%s</span><span class="s2">, will be deleted&quot;</span> <span class="o">%</span><span class="n">calc_root</span><span class="p">)</span>
    <span class="n">params_lst</span> <span class="o">=</span> <span class="p">[[</span><span class="n">SQLEntry</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;dummy&#39;</span><span class="p">,</span> <span class="n">sqlval</span><span class="o">=</span><span class="mi">1</span><span class="p">)]]</span>
    <span class="n">study</span> <span class="o">=</span> <span class="n">ParameterStudy</span><span class="p">(</span><span class="n">machines</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">params_lst</span><span class="o">=</span><span class="n">params_lst</span><span class="p">,</span>
                           <span class="n">calc_root</span><span class="o">=</span><span class="n">calc_root</span><span class="p">)</span>
    <span class="n">study</span><span class="o">.</span><span class="n">write_input</span><span class="p">()</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">SQLiteDB</span><span class="p">(</span><span class="n">study</span><span class="o">.</span><span class="n">dbfn</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="s1">&#39;calc&#39;</span><span class="p">)</span>
    <span class="n">db_keys</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">get_header</span><span class="p">()]</span>
    <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dummy&#39;</span><span class="p">,</span> <span class="s1">&#39;hostname&#39;</span><span class="p">]:</span>
        <span class="n">db_keys</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">db_keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">kk</span><span class="p">))</span>
    <span class="n">db</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ParameterStudy&#39;</span> <span class="p">:</span> <span class="n">db_keys</span><span class="p">,</span>
           <span class="s1">&#39;Machine&#39;</span> <span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">get_sql_record</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">calc_root</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span></div>



<div class="viewcode-block" id="Case">
<a class="viewcode-back" href="../../generated/api/pwtools.batch.Case.html#pwtools.batch.Case">[docs]</a>
<span class="k">class</span> <span class="nc">Case</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;General purpose container class, supporting only keywords in the</span>
<span class="sd">    constructor. This is essentially the same as a dictionary, just with</span>
<span class="sd">    another syntax for attribute access, i.e. ``case.foo`` instead of</span>
<span class="sd">    ``case[&#39;foo&#39;]``.</span>

<span class="sd">    Sometimes you want to do more than storing values. Then, you need to</span>
<span class="sd">    subclass Case and do stuff in ``__init__``. But don&#39;t call</span>
<span class="sd">    ``Case.__init__`` as in ::</span>

<span class="sd">        class MyCase(Case):</span>
<span class="sd">            def __init__(self, *args, **kwds):</span>
<span class="sd">                super(Case, self).__init__(*args, **kwds)</span>
<span class="sd">                    self.z = self.x + self.y</span>

<span class="sd">    Instead, define a method called ``init``, which is automatically called if</span>
<span class="sd">    it exists. ::</span>

<span class="sd">        class MyCase(Case):</span>
<span class="sd">            def init(self):</span>
<span class="sd">                self.z = self.x + self.y</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from pwtools.batch import Case</span>
<span class="sd">    &gt;&gt;&gt; case1 = Case(x=1, y=2)</span>
<span class="sd">    &gt;&gt;&gt; case2 = Case(x=11, y=22)</span>
<span class="sd">    &gt;&gt;&gt; for case in [case1, case2]: print(case.x, case.y)</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Case.__init__">
<a class="viewcode-back" href="../../generated/api/pwtools.batch.Case.html#pwtools.batch.Case.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kwds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">,</span> <span class="n">Callable</span><span class="p">):</span>
            <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;self.init()&#39;</span><span class="p">)</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;Steve Schmerler.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.4.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>