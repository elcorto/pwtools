
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pwtools.parse &#8212; pwtools  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo.png" alt="Logo"/>
    
    <h1 class="logo logo-name">pwtools</h1>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=elcorto&repo=pwtools&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../generated/api/index.html">API Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../written/features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../written/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../written/tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../written/background/index.html">Background, details, special topics</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pwtools.parse</h1><div class="highlight"><pre>
<span></span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Parser classes for different file formats. Input- and output files.</span>
<span class="sd">===================================================================</span>

<span class="sd">We need the following basic Unix tools installed:</span>

<span class="sd">| grep/egrep</span>
<span class="sd">| sed</span>
<span class="sd">| awk (better mawk)</span>
<span class="sd">| tail</span>
<span class="sd">| wc</span>
<span class="sd">| ...</span>

<span class="sd">The tested egrep versions don&#39;t know the ``\s`` character class for</span>
<span class="sd">whitespace as sed, Perl, Python or any other sane regex implementation</span>
<span class="sd">does. Use ``[ ]`` instead.</span>

<span class="sd">Using Parsing classes</span>
<span class="sd">---------------------</span>

<span class="sd">All parsing classes::</span>

<span class="sd">    Pw*OutputFile</span>
<span class="sd">    Cpmd*OutputFile</span>
<span class="sd">    Cp2k*OutputFile</span>
<span class="sd">    Lammps*OutputFile</span>

<span class="sd">are derived from FlexibleGetters -&gt; UnitsHandler -&gt;  {Structure,Trajectory}FileParser</span>

<span class="sd">As a general rule: If a getter (self.get_&lt;attr&gt;() or self._get_&lt;attr&gt;_raw()</span>
<span class="sd">cannot find anything in the file, it returns None. All getters which depend</span>
<span class="sd">on it will also return None.</span>

<span class="sd">* After initialization</span>
<span class="sd">      pp = SomeParsingClass(&lt;filename&gt;)</span>
<span class="sd">  all attrs whoose name is in pp.attr_lst will be set to None.</span>

<span class="sd">* parse() will invoke self.try_set_attr(&lt;attr&gt;), which does</span>
<span class="sd">      self.&lt;attr&gt; = self.get_&lt;attr&gt;()</span>
<span class="sd">  for each &lt;attr&gt; in self.attr_lst, thus setting self.&lt;attr&gt; to a defined</span>
<span class="sd">  value: None if nothing was found in the file or not None else</span>

<span class="sd">* All getters get_&lt;attr&gt;() will do their parsing, possibly</span>
<span class="sd">  looking for a file self.filename, regardless of the fact that the attribute</span>
<span class="sd">  self.&lt;attr&gt; may already be defined (e.g. if parse() has been called before).</span>

<span class="sd">* For interactive use (you need &lt;attr&gt; only once), prefer get_&lt;attr&gt;() over</span>
<span class="sd">  parse().</span>

<span class="sd">* Use dump(&#39;foo.pk&#39;) only for temporary storage and fast re-reading. Use</span>
<span class="sd">  pwtool.io.read_pickle(&#39;foo.pk&#39;). See also the *FileParser.load() docstring.</span>

<span class="sd">* Use relative paths in &lt;filename&gt;.</span>

<span class="sd">* If loading a dump()&#39;ed pickle file from disk,</span>
<span class="sd">      pp=io.read_pickle(...)</span>
<span class="sd">  then use direct attr access</span>
<span class="sd">      pp.&lt;attr&gt;</span>
<span class="sd">  instead of</span>
<span class="sd">      pp.get_&lt;attr&gt;()</span>
<span class="sd">  b/c latter would simply parse self.filname again.</span>

<span class="sd">For debugging, we still have many getters which produce redundant</span>
<span class="sd">information, e.g.</span>

<span class="sd">    | cell + cryst_const</span>
<span class="sd">    | _&lt;attr&gt;_raw + &lt;attr&gt; (where &lt;attr&gt; = cell, forces, ...)</span>
<span class="sd">    | ...</span>

<span class="sd">especially in MD parsers, not so much in StructureFileParser drived</span>
<span class="sd">classes. If parse() is used, all this information retrieved and stored.</span>

<span class="sd">* All parsers try to return the default units of the program output, e.g. Ry,</span>
<span class="sd">  Bohr, tryd for PWscf; Ha, Bohr, thart for Abinit and CPMD.</span>

<span class="sd">* Use get_struct() / get_traj() to get a Structure / Trajectory object with</span>
<span class="sd">  pwtools standard units (eV, Ang, fs).</span>

<span class="sd">Using parse():</span>

<span class="sd">Pro:</span>

<span class="sd">* Simplicity. *All* getters are called when parse() is</span>
<span class="sd">  invoked. You get it all.</span>
<span class="sd">* In theory, you can delete the file pointed to by self.filename, assuming</span>
<span class="sd">  all getters have extracted all information that you need.</span>

<span class="sd">Con:</span>

<span class="sd">* The object is full of (potentially big) arrays holding redundant</span>
<span class="sd">  information. Thus, the dump()&#39;ed file may be large. Use the compress()</span>
<span class="sd">  method.</span>
<span class="sd">* Parsing may be slow if each getter (of possibly many) is called.</span>

<span class="sd">Using get_&lt;attr&gt;():</span>

<span class="sd">Pro:</span>

<span class="sd">* You only parse what you really need.</span>

<span class="sd">Con:</span>

<span class="sd">* self.&lt;attr&gt; will NOT be set, since get_&lt;attr&gt;() only returns &lt;attr&gt; but</span>
<span class="sd">  doesn&#39;t set self.&lt;attr&gt; = self.get_&lt;attr&gt;(), so dump() would save an</span>
<span class="sd">  &quot;empty&quot; file.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">acos</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sqrt</span>

<span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># fail if missing, functionas which use that will fail later</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">CifFile</span> <span class="k">as</span> <span class="nn">pycifrw_CifFile</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">from</span> <span class="nn">pwtools</span> <span class="k">import</span> <span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">constants</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">crys</span><span class="p">,</span> <span class="n">atomic_data</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span>
    <span class="n">arrayio</span><span class="p">,</span> <span class="n">dcd</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pwtools.verbose</span> <span class="k">import</span> <span class="n">verbose</span>
<span class="kn">from</span> <span class="nn">pwtools.base</span> <span class="k">import</span> <span class="n">FlexibleGetters</span>
<span class="kn">from</span> <span class="nn">pwtools.constants</span> <span class="k">import</span> <span class="n">Ry</span><span class="p">,</span> <span class="n">Ha</span><span class="p">,</span> <span class="n">eV</span><span class="p">,</span> <span class="n">Bohr</span><span class="p">,</span> <span class="n">Angstrom</span><span class="p">,</span> <span class="n">thart</span><span class="p">,</span> <span class="n">Ang</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">ps</span>
<span class="kn">from</span> <span class="nn">pwtools.crys</span> <span class="k">import</span> <span class="n">UnitsHandler</span>
<span class="n">com</span> <span class="o">=</span> <span class="n">common</span>
<span class="n">pj</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span>

<span class="c1"># mawk is _much_ faster than GNU awk, which is ususlly /usr/bin/awk on linux.</span>
<span class="c1"># This test is pretty simple-minded but very fast. Maybe add more paths if</span>
<span class="c1"># needed (e.g. /usr/local/bin&#39;) or use a more elaborate thing such as</span>
<span class="c1">#</span>
<span class="c1">#   1) distutils.spawn.find_executable</span>
<span class="c1">#   2) shutil.which # python 3.3</span>
<span class="c1">#   3) try:</span>
<span class="c1">#          subprocess.call(...) # or subprocess.Popen(...)</span>
<span class="c1">#      except OSError:</span>
<span class="c1">#          ...</span>
<span class="c1"># See</span>
<span class="c1"># http://stackoverflow.com/questions/377017/test-if-executable-exists-in-python</span>
<span class="c1"># http://stackoverflow.com/questions/11210104/check-if-a-program-exists-from-a-python-script</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;/usr/bin/mawk&#39;</span><span class="p">):</span>
    <span class="n">AWK</span> <span class="o">=</span> <span class="s1">&#39;mawk&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">AWK</span> <span class="o">=</span> <span class="s1">&#39;awk&#39;</span>


<span class="c1">#-----------------------------------------------------------------------------</span>
<span class="c1"># General helpers</span>
<span class="c1">#-----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="int_from_txt"><a class="viewcode-back" href="../../generated/api/pwtools.parse.int_from_txt.html#pwtools.parse.int_from_txt">[docs]</a><span class="k">def</span> <span class="nf">int_from_txt</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">txt</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span></div>

<div class="viewcode-block" id="float_from_txt"><a class="viewcode-back" href="../../generated/api/pwtools.parse.float_from_txt.html#pwtools.parse.float_from_txt">[docs]</a><span class="k">def</span> <span class="nf">float_from_txt</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">txt</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span></div>

<div class="viewcode-block" id="nstep_from_txt"><a class="viewcode-back" href="../../generated/api/pwtools.parse.nstep_from_txt.html#pwtools.parse.nstep_from_txt">[docs]</a><span class="k">def</span> <span class="nf">nstep_from_txt</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">txt</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span></div>

<div class="viewcode-block" id="traj_from_txt"><a class="viewcode-back" href="../../generated/api/pwtools.parse.traj_from_txt.html#pwtools.parse.traj_from_txt">[docs]</a><span class="k">def</span> <span class="nf">traj_from_txt</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Used for 3d trajectories where the exact shape of the array as written</span>
<span class="sd">    by the MD code must be known, e.g. (nstep,N,3) where N=3 (cell, stress) or</span>
<span class="sd">    N=natoms (coords, forces, ...).</span>

<span class="sd">    We use np.fromstring for speed, so `txt` can only contain numbers and</span>
<span class="sd">    separators (white space), no comments (like &quot;# this is the header&quot;), which</span>
<span class="sd">    numpy.loadtxt() would handle.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    txt : string</span>
<span class="sd">        Text containing numbers (e.g. from ``common.backtick(&quot;grep ...&quot;)``)</span>
<span class="sd">    shape : tuple</span>
<span class="sd">        The 3d shape of the array when written along `axis` (see also</span>
<span class="sd">        arrayio.writetxt()) to text as 2d chunks and read back in as 3d array.</span>
<span class="sd">        Used to reconstruct the array.</span>
<span class="sd">    axis : int</span>
<span class="sd">        Axis along which the array was written in 2d chunks to text. (see</span>
<span class="sd">        also `axis` in arrayio.writetxt()).</span>
<span class="sd">        Used to reconstruct the array.</span>
<span class="sd">        Only axis=0 implemented.</span>
<span class="sd">    dtype, sep : passed to np.fromstring</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">txt</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;only 3d arrays supported&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;only axis=0 implemented&quot;</span><span class="p">)</span>
        <span class="c1"># Works only for axis = 0, but this is the only case we have when</span>
        <span class="c1"># parsing MD code output. Else, some rollaxis would be needed. E.g. if</span>
        <span class="c1"># shape=(natoms,nstep,3) and therefore axis=1, then we would do</span>
        <span class="c1"># np.rollaxis(fromstring(...).reshape(shape), axis=1, start=0) -&gt;</span>
        <span class="c1"># (nstep,natoms,3)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span></div>

<div class="viewcode-block" id="arr1d_from_txt"><a class="viewcode-back" href="../../generated/api/pwtools.parse.arr1d_from_txt.html#pwtools.parse.arr1d_from_txt">[docs]</a><span class="k">def</span> <span class="nf">arr1d_from_txt</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">txt</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">txt</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="arr2d_from_txt"><a class="viewcode-back" href="../../generated/api/pwtools.parse.arr2d_from_txt.html#pwtools.parse.arr2d_from_txt">[docs]</a><span class="k">def</span> <span class="nf">arr2d_from_txt</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">txt</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">txt</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="axis_lens"><a class="viewcode-back" href="../../generated/api/pwtools.parse.axis_lens.html#pwtools.parse.axis_lens">[docs]</a><span class="k">def</span> <span class="nf">axis_lens</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return length of `axis` of all arrays in `seq`.</span>

<span class="sd">    If an entry in `seq` is None instead of an array, return 0. All arrays must</span>
<span class="sd">    have at least axis+1 dimensions, of course (i.e. axis=1 -&gt; all arrays at</span>
<span class="sd">    least 2d).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; axis_lens([arange(100), np.array([1,2,3]), None, rand(5,3)])</span>
<span class="sd">    [100, 3, 0, 5]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># handle None</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span></div>


<span class="c1">#-----------------------------------------------------------------------------</span>
<span class="c1"># Parsers</span>
<span class="c1">#-----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="StructureFileParser"><a class="viewcode-back" href="../../generated/api/pwtools.parse.StructureFileParser.html#pwtools.parse.StructureFileParser">[docs]</a><span class="k">class</span> <span class="nc">StructureFileParser</span><span class="p">(</span><span class="n">UnitsHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for single-structure parsers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Container</span> <span class="o">=</span> <span class="n">crys</span><span class="o">.</span><span class="n">Structure</span>
    <span class="n">default_units</span> <span class="o">=</span> <span class="p">{}</span>
<div class="viewcode-block" id="StructureFileParser.__init__"><a class="viewcode-back" href="../../generated/api/pwtools.parse.StructureFileParser.html#pwtools.parse.StructureFileParser.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_called</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="c1"># Some parsers do</span>
        <span class="c1">#   self._foo_file = os.path.join(self.basedir,&#39;foo&#39;)</span>
        <span class="c1"># in their __init__. That should not fail if we create an instance</span>
        <span class="c1"># without passing a filename, like parser=SomeParsingClass(). So</span>
        <span class="c1"># instead of setting basedir=None by default, we set it to &#39;.&#39; .</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span>
            <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;.&#39;</span>
        <span class="n">UnitsHandler</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Each derived parser class has `default_units`, with which self.units</span>
        <span class="c1"># is updated. Then, self.units is updated from user input if we are</span>
        <span class="c1"># called as ``SomeParser(...,units=...)``. Last, self.units is passed</span>
        <span class="c1"># to Container(..., units=self.units) and units are applied there.</span>
        <span class="c1"># Clear? :)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_units</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cont</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Container</span><span class="p">(</span><span class="n">set_all_auto</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_attr_lst</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cont</span><span class="o">.</span><span class="n">attr_lst</span><span class="p">)</span></div>

<div class="viewcode-block" id="StructureFileParser.parse"><a class="viewcode-back" href="../../generated/api/pwtools.parse.StructureFileParser.parse.html#pwtools.parse.StructureFileParser.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_called</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="StructureFileParser.get_cont"><a class="viewcode-back" href="../../generated/api/pwtools.parse.StructureFileParser.get_cont.html#pwtools.parse.StructureFileParser.get_cont">[docs]</a>    <span class="k">def</span> <span class="nf">get_cont</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auto_calc</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate and return a Container object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        auto_calc : bool</span>
<span class="sd">            Auto-calculation of missing attributes in Container after passing</span>
<span class="sd">            parsed data by calling ``set_all()``.</span>

<span class="sd">            | True:  call ``Container.set_all()`` =</span>
<span class="sd">            |           ``Container._extend_arrays_apply_units()`` +</span>
<span class="sd">            |           ``FlexibleGetters.set_all()``</span>
<span class="sd">            | False: call only ``Container._extend_arrays_apply_units()``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_called</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cont</span><span class="o">.</span><span class="n">attr_lst</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cont</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">auto_calc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cont</span><span class="o">.</span><span class="n">set_all</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cont</span><span class="o">.</span><span class="n">_extend_arrays_apply_units</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cont</span><span class="o">.</span><span class="n">units_applied</span><span class="p">,</span> <span class="s2">&quot;Container units not applied&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cont</span></div>

<div class="viewcode-block" id="StructureFileParser.apply_units"><a class="viewcode-back" href="../../generated/api/pwtools.parse.StructureFileParser.apply_units.html#pwtools.parse.StructureFileParser.apply_units">[docs]</a>    <span class="k">def</span> <span class="nf">apply_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;don&#39;t use that in parsers&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="StructureFileParser.get_struct"><a class="viewcode-back" href="../../generated/api/pwtools.parse.StructureFileParser.get_struct.html#pwtools.parse.StructureFileParser.get_struct">[docs]</a>    <span class="k">def</span> <span class="nf">get_struct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cont</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TrajectoryFileParser"><a class="viewcode-back" href="../../generated/api/pwtools.parse.TrajectoryFileParser.html#pwtools.parse.TrajectoryFileParser">[docs]</a><span class="k">class</span> <span class="nc">TrajectoryFileParser</span><span class="p">(</span><span class="n">StructureFileParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for MD-like parsers.&quot;&quot;&quot;</span>
    <span class="n">Container</span> <span class="o">=</span> <span class="n">crys</span><span class="o">.</span><span class="n">Trajectory</span>
    <span class="c1"># timeaxis in Trajectory defined before __init__, so we don&#39;t need to</span>
    <span class="c1"># instantiate the object</span>
    <span class="n">timeaxis</span> <span class="o">=</span> <span class="n">Container</span><span class="o">.</span><span class="n">timeaxis</span>

<div class="viewcode-block" id="TrajectoryFileParser.get_struct"><a class="viewcode-back" href="../../generated/api/pwtools.parse.TrajectoryFileParser.get_struct.html#pwtools.parse.TrajectoryFileParser.get_struct">[docs]</a>    <span class="k">def</span> <span class="nf">get_struct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;use get_traj()&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrajectoryFileParser.get_traj"><a class="viewcode-back" href="../../generated/api/pwtools.parse.TrajectoryFileParser.get_traj.html#pwtools.parse.TrajectoryFileParser.get_traj">[docs]</a>    <span class="k">def</span> <span class="nf">get_traj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cont</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CifFile"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CifFile.html#pwtools.parse.CifFile">[docs]</a><span class="k">class</span> <span class="nc">CifFile</span><span class="p">(</span><span class="n">StructureFileParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse Cif file. Uses PyCifRW [1]_.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] https://bitbucket.org/jamesrhester/pycifrw</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="CifFile.__init__"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CifFile.html#pwtools.parse.CifFile.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : name of the input file</span>
<span class="sd">        block : data block name (i.e. &#39;data_foo&#39; in the Cif file -&gt; &#39;foo&#39;</span>
<span class="sd">            here). If None then the first data block in the file is used.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span>
        <span class="n">StructureFileParser</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="c1"># only the ones for which we have getters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_lst</span> <span class="o">=</span> <span class="p">[</span>\
            <span class="s1">&#39;coords_frac&#39;</span><span class="p">,</span>
            <span class="s1">&#39;coords&#39;</span><span class="p">,</span>
            <span class="s1">&#39;symbols&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cryst_const&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_attr_lst</span><span class="p">()</span></div>

<div class="viewcode-block" id="CifFile.cif_str2float"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CifFile.cif_str2float.html#pwtools.parse.CifFile.cif_str2float">[docs]</a>    <span class="k">def</span> <span class="nf">cif_str2float</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">st</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&#39;7.3782(7)&#39; -&gt; 7.3782&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;(&#39;</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">regex</span><span class="o">.</span><span class="n">float_re</span>  <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)(\(.*)&#39;</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">st</span><span class="p">)</span></div>

<div class="viewcode-block" id="CifFile.cif_clear_atom_symbol"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CifFile.cif_clear_atom_symbol.html#pwtools.parse.CifFile.cif_clear_atom_symbol">[docs]</a>    <span class="k">def</span> <span class="nf">cif_clear_atom_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">rex</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([a-zA-Z]+)([0-9+-]*)&#39;</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;Remove digits and &quot;+,-&quot; from atom names.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; cif_clear_atom_symbol(&#39;Al1&#39;)</span>
<span class="sd">        &#39;Al&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">rex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">st</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_cif_dct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># celldm from a,b,c and alpha,beta,gamma</span>
        <span class="c1"># alpha = angbe between b,c</span>
        <span class="c1"># beta  = angbe between a,c</span>
        <span class="c1"># gamma = angbe between a,b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_set_attr</span><span class="p">(</span><span class="s1">&#39;_cif_block&#39;</span><span class="p">)</span>
        <span class="n">cif_dct</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]:</span>
            <span class="n">what</span> <span class="o">=</span> <span class="s1">&#39;_cell_length_&#39;</span> <span class="o">+</span> <span class="n">x</span>
            <span class="n">cif_dct</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cif_str2float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cif_block</span><span class="p">[</span><span class="n">what</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;gamma&#39;</span><span class="p">]:</span>
            <span class="n">what</span> <span class="o">=</span> <span class="s1">&#39;_cell_angle_&#39;</span> <span class="o">+</span> <span class="n">x</span>
            <span class="n">cif_dct</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cif_str2float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cif_block</span><span class="p">[</span><span class="n">what</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">cif_dct</span>

    <span class="k">def</span> <span class="nf">_get_cif_block</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cf</span> <span class="o">=</span> <span class="n">pycifrw_CifFile</span><span class="o">.</span><span class="n">ReadCif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cif_block</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">first_block</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cif_block</span> <span class="o">=</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;data_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">cif_block</span>

<div class="viewcode-block" id="CifFile.get_coords_frac"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CifFile.get_coords_frac.html#pwtools.parse.CifFile.get_coords_frac">[docs]</a>    <span class="k">def</span> <span class="nf">get_coords_frac</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_cif_block&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;_atom_site_fract_x&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cif_block</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cif_str2float</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">]))</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_cif_block</span><span class="p">[</span><span class="s1">&#39;_atom_site_fract_x&#39;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_cif_block</span><span class="p">[</span><span class="s1">&#39;_atom_site_fract_y&#39;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_cif_block</span><span class="p">[</span><span class="s1">&#39;_atom_site_fract_z&#39;</span><span class="p">])])</span>
                <span class="k">return</span> <span class="n">arr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CifFile.get_coords"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CifFile.get_coords.html#pwtools.parse.CifFile.get_coords">[docs]</a>    <span class="k">def</span> <span class="nf">get_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_cif_block&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;_atom_site_Cartn_x&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cif_block</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cif_str2float</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">]))</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_cif_block</span><span class="p">[</span><span class="s1">&#39;_atom_site_Cartn_x&#39;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_cif_block</span><span class="p">[</span><span class="s1">&#39;_atom_site_Cartn_y&#39;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_cif_block</span><span class="p">[</span><span class="s1">&#39;_atom_site_Cartn_z&#39;</span><span class="p">])])</span>
                <span class="k">return</span> <span class="n">arr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CifFile.get_symbols"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CifFile.get_symbols.html#pwtools.parse.CifFile.get_symbols">[docs]</a>    <span class="k">def</span> <span class="nf">get_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_set_attr</span><span class="p">(</span><span class="s1">&#39;_cif_block&#39;</span><span class="p">)</span>
        <span class="n">try_lst</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_atom_site_type_symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;_atom_site_label&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">try_lst</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cif_block</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cif_clear_atom_symbol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cif_block</span><span class="p">[</span><span class="n">entry</span><span class="p">]))</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CifFile.get_cryst_const"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CifFile.get_cryst_const.html#pwtools.parse.CifFile.get_cryst_const">[docs]</a>    <span class="k">def</span> <span class="nf">get_cryst_const</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_set_attr</span><span class="p">(</span><span class="s1">&#39;_cif_dct&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_cif_dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> \
            <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;gamma&#39;</span><span class="p">]])</span></div></div>


<div class="viewcode-block" id="PDBFile"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PDBFile.html#pwtools.parse.PDBFile">[docs]</a><span class="k">class</span> <span class="nc">PDBFile</span><span class="p">(</span><span class="n">StructureFileParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Very very simple pdb file parser.</span>

<span class="sd">    Extract only ATOM/HETATM and CRYST1 (if present) records. If you want smth</span>
<span class="sd">    serious, check biopython or openbabel.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    self.cryst_const :</span>
<span class="sd">        If no CRYST1 record is found, this is None.</span>

<span class="sd">    parsing:</span>
<span class="sd">        We use regexes which may not work for more complicated ATOM records. We</span>
<span class="sd">        don&#39;t use the strict column numbers for each field as stated in the PDB</span>
<span class="sd">        spec.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Notes:</span>
    <span class="c1">#</span>
    <span class="c1"># Grep atom symbols and coordinates in Angstrom ([A]) from PDB file.</span>
    <span class="c1"># Note that for the atom symbols, we do NOT use the columns 77-78</span>
    <span class="c1"># (&quot;Element symbol&quot;), b/c that is apparently not present in all the</span>
    <span class="c1"># files which we currently use. Instead, we use the columns 13-16, i.e.</span>
    <span class="c1"># &quot;Atom name&quot;. Note that in general this is not the element symbol.</span>
    <span class="c1">#</span>
    <span class="c1"># From the PDB spec v3.20:</span>
    <span class="c1">#</span>
    <span class="c1"># ATOM record:</span>
    <span class="c1">#</span>
    <span class="c1"># COLUMNS       DATA  TYPE    FIELD        DEFINITION</span>
    <span class="c1"># -------------------------------------------------------------------------------------</span>
    <span class="c1">#  1 -  6       Record name   &quot;ATOM  &quot;</span>
    <span class="c1">#  7 - 11       Integer       serial       Atom  serial number.</span>
    <span class="c1">#  13 - 16      Atom          name         Atom name.</span>
    <span class="c1">#  17           Character     altLoc       Alternate location indicator.</span>
    <span class="c1">#  18 - 20      Residue name  resName      Residue name.</span>
    <span class="c1">#  22           Character     chainID      Chain identifier.</span>
    <span class="c1">#  23 - 26      Integer       resSeq       Residue sequence number.</span>
    <span class="c1">#  27           AChar         iCode        Code for insertion of residues.</span>
    <span class="c1">#  31 - 38      Real(8.3)     x            Orthogonal coordinates for X in Angstroms.</span>
    <span class="c1">#  39 - 46      Real(8.3)     y            Orthogonal coordinates for Y in Angstroms.</span>
    <span class="c1">#  47 - 54      Real(8.3)     z            Orthogonal coordinates for Z in Angstroms.</span>
    <span class="c1">#  55 - 60      Real(6.2)     occupancy    Occupancy.</span>
    <span class="c1">#  61 - 66      Real(6.2)     tempFactor   Temperature  factor.</span>
    <span class="c1">#  77 - 78      LString(2)    element      Element symbol, right-justified.</span>
    <span class="c1">#  79 - 80      LString(2)    charge       Charge  on the atom.</span>
    <span class="c1">#</span>
    <span class="c1"># CRYST1 record:</span>
    <span class="c1">#</span>
    <span class="c1"># COLUMNS       DATA  TYPE    FIELD          DEFINITION</span>
    <span class="c1"># -------------------------------------------------------------</span>
    <span class="c1">#  1 -  6       Record name   &quot;CRYST1&quot;</span>
    <span class="c1">#  7 - 15       Real(9.3)     a              a (Angstroms).</span>
    <span class="c1"># 16 - 24       Real(9.3)     b              b (Angstroms).</span>
    <span class="c1"># 25 - 33       Real(9.3)     c              c (Angstroms).</span>
    <span class="c1"># 34 - 40       Real(7.2)     alpha          alpha (degrees).</span>
    <span class="c1"># 41 - 47       Real(7.2)     beta           beta (degrees).</span>
    <span class="c1"># 48 - 54       Real(7.2)     gamma          gamma (degrees).</span>
    <span class="c1"># 56 - 66       LString       sGroup         Space  group.</span>
    <span class="c1"># 67 - 70       Integer       z              Z value.</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="PDBFile.__init__"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PDBFile.html#pwtools.parse.PDBFile.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="n">StructureFileParser</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="c1"># only the ones for which we have getters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_lst</span> <span class="o">=</span> <span class="p">[</span>\
            <span class="s1">&#39;coords&#39;</span><span class="p">,</span>
            <span class="s1">&#39;symbols&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cryst_const&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_attr_lst</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">txt</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">file_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_coords_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pat</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(ATOM|HETATM)[\s0-9]+([A-Za-z]+)[\sa-zA-Z0-9]*&#39;</span> <span class="o">+</span> \
            <span class="sa">r</span><span class="s1">&#39;[\s0-9]+((\s+&#39;</span><span class="o">+</span> <span class="n">regex</span><span class="o">.</span><span class="n">float_re</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)</span><span class="si">{3}</span><span class="s1">?)&#39;</span>
        <span class="c1"># array of string type</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> \
                         <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">txt</span><span class="p">)])</span>

<div class="viewcode-block" id="PDBFile.get_symbols"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PDBFile.get_symbols.html#pwtools.parse.PDBFile.get_symbols">[docs]</a>    <span class="k">def</span> <span class="nf">get_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># list of strings (system:nat,)</span>
        <span class="c1"># Fix atom names, e.g. &quot;AL&quot; -&gt; Al. Note that this is only needed b/c we</span>
        <span class="c1"># use the &quot;wrong&quot; column &quot;Atom name&quot;.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_set_attr</span><span class="p">(</span><span class="s1">&#39;_coords_data&#39;</span><span class="p">)</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords_data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sym</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">sym</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">symbols</span></div>

<div class="viewcode-block" id="PDBFile.get_coords"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PDBFile.get_coords.html#pwtools.parse.PDBFile.get_coords">[docs]</a>    <span class="k">def</span> <span class="nf">get_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_set_attr</span><span class="p">(</span><span class="s1">&#39;_coords_data&#39;</span><span class="p">)</span>
        <span class="c1"># float array, (system:nat, 3)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords_data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span></div>

<div class="viewcode-block" id="PDBFile.get_cryst_const"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PDBFile.get_cryst_const.html#pwtools.parse.PDBFile.get_cryst_const">[docs]</a>    <span class="k">def</span> <span class="nf">get_cryst_const</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># grep CRYST1 record, extract only crystallographic constants</span>
        <span class="c1"># example:</span>
        <span class="c1"># CRYST1   52.000   58.600   61.900  90.00  90.00  90.00  P 21 21 21   8</span>
        <span class="c1">#          a        b        c       alpha  beta   gamma  |space grp|  z-value</span>
        <span class="n">pat</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;CRYST1\s+((\s+&#39;</span> <span class="o">+</span> <span class="n">regex</span><span class="o">.</span><span class="n">float_re</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)</span><span class="si">{6}</span><span class="s1">).*&#39;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">txt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PwSCFOutputFile"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwSCFOutputFile.html#pwtools.parse.PwSCFOutputFile">[docs]</a><span class="k">class</span> <span class="nc">PwSCFOutputFile</span><span class="p">(</span><span class="n">StructureFileParser</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Parse a pw.x SCF output file (calculation=&#39;scf&#39;).</span>

<span class="sd">    Some getters (_get_&lt;attr&gt;_raw) work for MD-like output, too. Here in the</span>
<span class="sd">    SCF case, only the first item along the time axis is returned and should</span>
<span class="sd">    only be used on calculation=&#39;scf&#39; output.</span>

<span class="sd">    SCF output files don&#39;t have an ATOMIC_POSITIONS block. We need to parse the</span>
<span class="sd">    block below, which can be found at the top the file (cartesian, divided by</span>
<span class="sd">    alat). From that, we also get symbols::</span>

<span class="sd">        Cartesian axes</span>

<span class="sd">          site n.     atom                  positions (a_0 units)</span>
<span class="sd">              1           Al  tau(  1) = (  -0.0000050   0.5773532   0.0000000  )</span>
<span class="sd">              2           Al  tau(  2) = (   0.5000050   0.2886722   0.8000643  )</span>
<span class="sd">              3           N   tau(  3) = (  -0.0000050   0.5773532   0.6208499  )</span>
<span class="sd">              4           N   tau(  4) = (   0.5000050   0.2886722   1.4209142  )</span>

<span class="sd">    Many quantities in PWscf&#39;s output files are always in units of the lattice</span>
<span class="sd">    vector &quot;a&quot; (= a_0 = celldm1 = &quot;alat&quot; [Bohr]), i.e. divided by that value,</span>
<span class="sd">    which is usually printed in the output in low precision::</span>

<span class="sd">         lattice parameter (a_0)   =       5.8789  a.u.</span>

<span class="sd">    You can parse that value with ``get_alat(use_alat=True)``. We do that by</span>
<span class="sd">    default: ``PwSCFOutputFile(filename, use_alat=True)`` b/c this is what most</span>
<span class="sd">    people will expect if they just call the parser on some file. Then, we</span>
<span class="sd">    multiply all relevent quantities with dimension length with the alat value</span>
<span class="sd">    from pw.out automatically.</span>

<span class="sd">    If ``use_alat=False``, we use ``alat=1.0``, i.e. all length quantities</span>
<span class="sd">    which are &quot;in alat units&quot; are returned exactly as found in the file, which</span>
<span class="sd">    is the same behavior as in all other parsers. Unit conversion happens only</span>
<span class="sd">    when we pass things to Structure / Trajectory using self.units.</span>

<span class="sd">    If you need/want to use another alat (i.e. a value with more precision),</span>
<span class="sd">    then you need to explicitly provide that value and use ``use_alat=False``::</span>

<span class="sd">    &gt;&gt;&gt; alat = 1.23456789 # high precision value in Bohr</span>
<span class="sd">    &gt;&gt;&gt; pp = PwSCFOutputFile(&#39;pw.out&#39;, use_alat=False, units={&#39;length&#39;: alat*Bohr/Ang})</span>
<span class="sd">    &gt;&gt;&gt; st = pp.get_struct()</span>

<span class="sd">    ``use_alat=False`` will prevent parsing the low precision value from</span>
<span class="sd">    &#39;pw.out&#39;. The option ``units=...`` will overwrite ``default_units[&#39;length&#39;]</span>
<span class="sd">    = Bohr/Ang``, which is used to convert all PWscf length [Bohr] to [Ang]</span>
<span class="sd">    when passing things to Trajectory.</span>

<span class="sd">    In either case, all quantities with a length unit or derived from such a</span>
<span class="sd">    quantitiy, e.g.</span>

<span class="sd">        | cell</span>
<span class="sd">        | cryst_const</span>
<span class="sd">        | coords</span>
<span class="sd">        | coords_frac</span>
<span class="sd">        | volume</span>
<span class="sd">        | ...</span>

<span class="sd">    will be correct (up to alat&#39;s precision).</span>

<span class="sd">    All getters return PWscf standard units (Ry, Bohr, ...).</span>

<span class="sd">    It is a special case for PWscf that a parser class may modify values parsed</span>
<span class="sd">    from a file (multiply by alat if use_alat=True, etc) *before* they are</span>
<span class="sd">    passed over to Structure / Trajectory  b/c otherwise the numbers would be</span>
<span class="sd">    pretty useless, unless you use `units` explicitely. To get an object with</span>
<span class="sd">    pwtools standard units (eV, Angstrom, ...), use :meth:`get_struct`.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Total force: Pwscf writes a &quot;Total Force&quot; after the &quot;Forces acting on</span>
<span class="sd">    atoms&quot; section . This value a UNnormalized RMS of the force matrix</span>
<span class="sd">    (f_ij, i=1,natoms j=1,2,3) printed. According to .../PW/forces.f90,</span>
<span class="sd">    variable &quot;sumfor&quot;, the &quot;Total Force&quot; is ``sqrt(sum_ij f_ij^2)``.</span>
<span class="sd">    Use ``crys.rms(self.forces)`` (for PwSCFOutputFile) or</span>
<span class="sd">    ``crys.rms3d(self.forces, axis=self.timeaxis)`` (for PwMDOutputFile)</span>
<span class="sd">    instead.</span>

<span class="sd">    Verbose force printing: When using van der Waals (``london=.true.``) or</span>
<span class="sd">    ``verbosity=&#39;high&#39;``, then more than one force block (natoms,3) is printed.</span>
<span class="sd">    In that case, we assume the first block to be the sum of all force</span>
<span class="sd">    contributions and that will end up in ``self.forces``. Each subsequent</span>
<span class="sd">    block is discarded from ``self.forces``. However, you may use</span>
<span class="sd">    ``self._forces_raw`` (see ``self._get_forces_raw()``) to obtain all forces,</span>
<span class="sd">    which will have the shape (N*natoms). The forces blocks will be in the</span>
<span class="sd">    following order:</span>

<span class="sd">    =====================   =====================     =======================</span>
<span class="sd">    ``london=.true.``       ``verbosity=&#39;high&#39;``      ``verbosity=&#39;high&#39;`` +</span>
<span class="sd">                                                      ``london=.true.``</span>
<span class="sd">    =====================   =====================     =======================</span>
<span class="sd">    sum                     sum                       sum</span>
<span class="sd">    vdw                     non-local                 non-local</span>
<span class="sd">    \                       ionic                     ionic</span>
<span class="sd">    \                       local                     local</span>
<span class="sd">    \                       core                      core</span>
<span class="sd">    \                       Hubbard                   Hubbard</span>
<span class="sd">    \                       SCF correction            SCF correction</span>
<span class="sd">    \                       \                         vdw</span>
<span class="sd">    =====================   =====================     =======================</span>

<span class="sd">    Note that this order may change with QE versions, check your output file!</span>
<span class="sd">    Tested w/ QE 4.3.2 .</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># self.timeaxis: This is the hardcoded time axis. It must be done</span>
    <span class="c1">#     this way b/c getters returning a &gt;2d array cannot determine the shape</span>
    <span class="c1">#     of the returned array auttomatically based on the self.timeaxis</span>
    <span class="c1">#     setting alone. If you want to change this, then manually fix the</span>
    <span class="c1">#     &quot;shape&quot; kwarg to arrayio.readtxt() in all getters which return a 3d array.</span>
    <span class="n">default_units</span> <span class="o">=</span> \
        <span class="p">{</span><span class="s1">&#39;energy&#39;</span><span class="p">:</span> <span class="n">Ry</span> <span class="o">/</span> <span class="n">eV</span><span class="p">,</span> <span class="c1"># Ry -&gt; eV</span>
         <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="n">Bohr</span> <span class="o">/</span> <span class="n">Angstrom</span><span class="p">,</span> <span class="c1"># Bohr -&gt; Angstrom</span>
         <span class="s1">&#39;forces&#39;</span><span class="p">:</span> <span class="n">Ry</span> <span class="o">/</span> <span class="n">eV</span> <span class="o">*</span> <span class="n">Angstrom</span> <span class="o">/</span> <span class="n">Bohr</span><span class="p">,</span> <span class="c1"># Ry / Bohr -&gt; eV / Angstrom</span>
         <span class="s1">&#39;stress&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="c1"># kbar -&gt; GPa</span>
        <span class="p">}</span>
<div class="viewcode-block" id="PwSCFOutputFile.__init__"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwSCFOutputFile.html#pwtools.parse.PwSCFOutputFile.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_alat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="n">StructureFileParser</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeaxis</span> <span class="o">=</span> <span class="n">crys</span><span class="o">.</span><span class="n">Trajectory</span><span class="p">(</span><span class="n">set_all_auto</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">timeaxis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_lst</span> <span class="o">=</span> <span class="p">[</span>\
            <span class="s1">&#39;coords&#39;</span><span class="p">,</span>
            <span class="s1">&#39;symbols&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stress&#39;</span><span class="p">,</span>
            <span class="s1">&#39;etot&#39;</span><span class="p">,</span>
            <span class="s1">&#39;forces&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nstep_scf&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
            <span class="s1">&#39;natoms&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nkpoints&#39;</span><span class="p">,</span>
            <span class="s1">&#39;scf_converged&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_alat</span> <span class="o">=</span> <span class="n">use_alat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_attr_lst</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_get_stress_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting _stress_raw&quot;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;P=&#39;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;grep -c </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">nstep</span> <span class="o">=</span> <span class="n">nstep_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nstep</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;grep -A3 &#39;</span><span class="si">%s</span><span class="s2">&#39; </span><span class="si">%s</span><span class="s2"> | grep -v -e </span><span class="si">%s</span><span class="s2"> -e &#39;--&#39;| </span><span class="se">\</span>
<span class="s2">                  </span><span class="si">%s</span><span class="s2"> &#39;{print $4</span><span class="se">\&quot;</span><span class="s2">  </span><span class="se">\&quot;</span><span class="s2">$5</span><span class="se">\&quot;</span><span class="s2">  </span><span class="se">\&quot;</span><span class="s2">$6}&#39;&quot;</span> \
                  <span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">AWK</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">traj_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
                                 <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nstep</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                                 <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeaxis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_etot_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting _etot_raw&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span>  <span class="sa">r</span><span class="s2">&quot;grep &#39;^!&#39; </span><span class="si">%s</span><span class="s2"> | </span><span class="si">%s</span><span class="s2"> &#39;{print $5}&#39;&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">AWK</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arr1d_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_forces_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting _forces_raw&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;natoms&#39;</span><span class="p">):</span>
            <span class="c1"># nstep: get it from outfile b/c the value in any input file will be</span>
            <span class="c1"># wrong if the output file is a concatenation of multiple smaller files</span>
            <span class="n">key</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Forces\s+acting\s+on\s+atoms.*$&#39;</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;egrep -c &#39;</span><span class="si">%s</span><span class="s2">&#39; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;[ ]&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">nstep</span> <span class="o">=</span> <span class="n">nstep_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">nstep</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Need to split traj_from_txt() up into loadtxt() + arr2d_to_3d() b/c</span>
                <span class="c1"># we need to get `nlines` first without an additional &quot;grep -c</span>
                <span class="c1"># ...&quot;</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;grep &#39;atom.*type.*force&#39; </span><span class="si">%s</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                    | </span><span class="si">%s</span><span class="s2"> &#39;{print $7</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">$8</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">$9}&#39;&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">AWK</span><span class="p">)</span>
                <span class="n">arr2d</span> <span class="o">=</span> <span class="n">arr2d_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
                <span class="n">nlines</span> <span class="o">=</span> <span class="n">arr2d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># nlines_block = number of force lines per step = N*natoms</span>
                <span class="n">nlines_block</span> <span class="o">=</span> <span class="n">nlines</span> <span class="o">//</span> <span class="n">nstep</span>
                <span class="k">assert</span> <span class="n">nlines_block</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span>  <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;nlines_block forces doesn&#39;t &quot;</span>
                    <span class="s2">&quot;match natoms&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">arrayio</span><span class="o">.</span><span class="n">arr2d_to_3d</span><span class="p">(</span><span class="n">arr2d</span><span class="p">,</span>
                                           <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nstep</span><span class="p">,</span><span class="n">nlines_block</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                                           <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeaxis</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_nstep_scf_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting _nstep_scf_raw&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep &#39;convergence has been achieved in&#39; </span><span class="si">%s</span><span class="s2"> | </span><span class="si">%s</span><span class="s2"> &#39;{print $6}&#39;&quot;</span> \
            <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">AWK</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arr1d_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_coords_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Grep start coords and symbols from pw.out header. This is always in</span>
<span class="sd">        cartesian alat units (i.e. divided by alat) and printed with low</span>
<span class="sd">        precision.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting start coords&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_set_attr</span><span class="p">(</span><span class="s1">&#39;natoms&#39;</span><span class="p">)</span>
        <span class="n">natoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span>
        <span class="c1"># coords</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;egrep -m1 -A</span><span class="si">%i</span><span class="s2"> &#39;site.*atom.*positions.*units.*\)&#39; </span><span class="si">%s</span><span class="s2"> | tail -n</span><span class="si">%i</span><span class="s2"> | </span><span class="se">\</span>
<span class="s2">              sed -re &#39;s/.*\((.*)\)/\1/g&#39;&quot;</span> \
              <span class="o">%</span><span class="p">(</span><span class="n">natoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">natoms</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">arr2d_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;egrep -m1 -A</span><span class="si">%i</span><span class="s2"> &#39;site.*atom.*positions.*units.*\)&#39; </span><span class="si">%s</span><span class="s2"> | tail -n</span><span class="si">%i</span><span class="s2"> | </span><span class="se">\</span>
<span class="s2">              </span><span class="si">%s</span><span class="s2"> &#39;{print $2}&#39;&quot;</span> \
              <span class="o">%</span><span class="p">(</span><span class="n">natoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="n">AWK</span><span class="p">)</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="n">coords</span><span class="p">,</span> <span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="n">symbols</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_get_cell_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start 2d cell in alat units.</span>

<span class="sd">        Grep start cell from pw.out. Multiplication by alat in</span>
<span class="sd">        :meth:`get_cell`.</span>

<span class="sd">        The cell in pw.out is always in alat units (divided by alat) but</span>
<span class="sd">        printed with much less precision compared to the input file. If you</span>
<span class="sd">        need this information for further calculations, use the input file</span>
<span class="sd">        value.&quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;egrep -m1 -A3 &#39;crystal.*axes.*units.*(a_0|alat)&#39; </span><span class="si">%s</span><span class="s2"> | tail -n3 | </span><span class="se">\</span>
<span class="s2">               </span><span class="si">%s</span><span class="s2"> &#39;{print $4</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">$5</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">$6}&#39;&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">AWK</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arr2d_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>

<div class="viewcode-block" id="PwSCFOutputFile.get_alat"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwSCFOutputFile.get_alat.html#pwtools.parse.PwSCFOutputFile.get_alat">[docs]</a>    <span class="k">def</span> <span class="nf">get_alat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_alat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lattice parameter &quot;alat&quot; [Bohr]. If use_alat or self.use_alat is</span>
<span class="sd">        False, return 1.0, i.e. disbale alat.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        use_alat : bool</span>
<span class="sd">            Set use_alat and override self.use_alat.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">use_alat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_alat</span> <span class="k">if</span> <span class="n">use_alat</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">use_alat</span>
        <span class="k">if</span> <span class="n">use_alat</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep -m1 &#39;lattice parameter&#39; </span><span class="si">%s</span><span class="s2"> | </span><span class="se">\</span>
<span class="s2">                sed -re &#39;s/.*=(.*)\s+a\.u\./\1/&#39;&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
            <span class="k">return</span> <span class="n">float_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span></div>

<div class="viewcode-block" id="PwSCFOutputFile.get_coords"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwSCFOutputFile.get_coords.html#pwtools.parse.PwSCFOutputFile.get_coords">[docs]</a>    <span class="k">def</span> <span class="nf">get_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cartesian start coords [Bohr] if self.alat in [Bohr].&quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting coords&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr_lst</span><span class="p">([</span><span class="s1">&#39;_coords_symbols&#39;</span><span class="p">,</span> <span class="s1">&#39;alat&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords_symbols</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PwSCFOutputFile.get_symbols"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwSCFOutputFile.get_symbols.html#pwtools.parse.PwSCFOutputFile.get_symbols">[docs]</a>    <span class="k">def</span> <span class="nf">get_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting symbols&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_coords_symbols&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords_symbols</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PwSCFOutputFile.get_stress"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwSCFOutputFile.get_stress.html#pwtools.parse.PwSCFOutputFile.get_stress">[docs]</a>    <span class="k">def</span> <span class="nf">get_stress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stress tensor [kbar].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_slice_get</span><span class="p">(</span><span class="s1">&#39;stress&#39;</span><span class="p">,</span> <span class="n">sl</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeaxis</span><span class="p">)</span></div>

<div class="viewcode-block" id="PwSCFOutputFile.get_etot"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwSCFOutputFile.get_etot.html#pwtools.parse.PwSCFOutputFile.get_etot">[docs]</a>    <span class="k">def</span> <span class="nf">get_etot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Total enery [Ry].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_slice_get</span><span class="p">(</span><span class="s1">&#39;etot&#39;</span><span class="p">,</span> <span class="n">sl</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="PwSCFOutputFile.get_forces"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwSCFOutputFile.get_forces.html#pwtools.parse.PwSCFOutputFile.get_forces">[docs]</a>    <span class="k">def</span> <span class="nf">get_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Forces [Ry / Bohr].&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;natoms&#39;</span><span class="p">):</span>
            <span class="c1"># Assume that the first forces block printed are the forces on the</span>
            <span class="c1"># ions. Skip vdw forces or whatever else is printed after that.</span>
            <span class="c1"># Users can use self._forces_raw if they want and know what is</span>
            <span class="c1"># printed in which order in the output file.</span>
            <span class="n">forces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_slice_get</span><span class="p">(</span><span class="s1">&#39;forces&#39;</span><span class="p">,</span> <span class="n">sl</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeaxis</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">forces</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">forces</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">,:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PwSCFOutputFile.get_nstep_scf"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwSCFOutputFile.get_nstep_scf.html#pwtools.parse.PwSCFOutputFile.get_nstep_scf">[docs]</a>    <span class="k">def</span> <span class="nf">get_nstep_scf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_slice_get</span><span class="p">(</span><span class="s1">&#39;nstep_scf&#39;</span><span class="p">,</span> <span class="n">sl</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="PwSCFOutputFile.get_cell"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwSCFOutputFile.get_cell.html#pwtools.parse.PwSCFOutputFile.get_cell">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start cell [Bohr].</span>

<span class="sd">        Apply self.alat unit to _cell_2d.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr_lst</span><span class="p">([</span><span class="s1">&#39;_cell_2d&#39;</span><span class="p">,</span> <span class="s1">&#39;alat&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_2d</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PwSCFOutputFile.get_natoms"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwSCFOutputFile.get_natoms.html#pwtools.parse.PwSCFOutputFile.get_natoms">[docs]</a>    <span class="k">def</span> <span class="nf">get_natoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting natoms&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep -m 1 &#39;number.*atoms/cell&#39; </span><span class="si">%s</span><span class="s2"> | </span><span class="se">\</span>
<span class="s2">              sed -re &#39;s/.*=\s+([0-9]+).*/\1/&#39;&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">return</span> <span class="n">int_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span></div>

<div class="viewcode-block" id="PwSCFOutputFile.get_nkpoints"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwSCFOutputFile.get_nkpoints.html#pwtools.parse.PwSCFOutputFile.get_nkpoints">[docs]</a>    <span class="k">def</span> <span class="nf">get_nkpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting nkpoints&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep -m 1 &#39;number of k points=&#39; </span><span class="si">%s</span><span class="s2"> | </span><span class="se">\</span>
<span class="s2">            sed -re &#39;s/.*points=\s*([0-9]+)\s*.*/\1/&#39;&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">return</span> <span class="n">int_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span></div>

<div class="viewcode-block" id="PwSCFOutputFile.get_scf_converged"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwSCFOutputFile.get_scf_converged.html#pwtools.parse.PwSCFOutputFile.get_scf_converged">[docs]</a>    <span class="k">def</span> <span class="nf">get_scf_converged</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting scf_converged&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;grep &#39;convergence has been achieved in.*iterations&#39; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">if</span> <span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="PwMDOutputFile"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwMDOutputFile.html#pwtools.parse.PwMDOutputFile">[docs]</a><span class="k">class</span> <span class="nc">PwMDOutputFile</span><span class="p">(</span><span class="n">TrajectoryFileParser</span><span class="p">,</span> <span class="n">PwSCFOutputFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse pw.x MD-like output.</span>

<span class="sd">    Tested so far: md, relax, vc-relax. For vc-md, see PwVCMDOutputFile.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Units: Notes on units for PwSCFOutputFile, esp. alat, apply here as well.</span>
<span class="sd">    Additionally, the ATOMIC_POSITIONS and CELL_PARAMETERS blocks can have an</span>
<span class="sd">    optional unit, which we account for. See get_cell(), get_coords() and</span>
<span class="sd">    methods called in there.</span>

<span class="sd">        | ATOMIC_POSITIONS &lt;empty&gt; | bohr | angstrom | alat | crystal</span>
<span class="sd">        | CELL_PARAMETERS &lt;empty&gt; | (alat=...) | bohr | angstrom | alat</span>

<span class="sd">    In each case, the quantity is multiplied by alat if applicable and</span>
<span class="sd">    converted to Bohr, which is PWscf&#39;s default length, and later to Ang by</span>
<span class="sd">    default (or whatever self.units[&#39;length&#39;] does).</span>

<span class="sd">    Initial SCF run: A special &quot;feature&quot; of pwscf is that SCF coords+cell</span>
<span class="sd">    output is printed differently from MD-like output (where we have</span>
<span class="sd">    ATOMIC_POSITIONS and CELL_PARAMETERS blocks). Since this parser uses only</span>
<span class="sd">    the latter, the first etot+coords+cell+stress+... is skipped, i.e. the</span>
<span class="sd">    complete iteration=0 = initial SCF run. Therefore, if you use</span>
<span class="sd">    ``tr=io.read_pw_md(&#39;pw.out&#39;)``, ``tr[0]`` is actually NOT your start input</span>
<span class="sd">    structure! It is the first structure of the MD/relax. This may be a problem</span>
<span class="sd">    if you need to accurately calculate differences between initial and final</span>
<span class="sd">    relax structs, for instance. Then use::</span>

<span class="sd">    &gt;&gt;&gt; st = io.read_pw_scf(&#39;pw.out&#39;) # parse initial SCF output only: step=0</span>
<span class="sd">    &gt;&gt;&gt; tr_md = io.read_pw_md(&#39;pw.out&#39;) # parse MD-like output: step=1...end</span>
<span class="sd">    &gt;&gt;&gt; tr = crys.concatenate((st, tr_md))</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="PwMDOutputFile.__init__"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwMDOutputFile.html#pwtools.parse.PwMDOutputFile.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_alat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="c1"># update default_units *before* calling base class&#39; __init__, where</span>
        <span class="c1"># self.units is assembled from default_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_units</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">tryd</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">fs</span><span class="p">})</span>
        <span class="n">TrajectoryFileParser</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_lst</span> <span class="o">=</span> <span class="p">[</span>\
            <span class="s1">&#39;coords&#39;</span><span class="p">,</span>
            <span class="s1">&#39;coords_frac&#39;</span><span class="p">,</span>
            <span class="s1">&#39;symbols&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stress&#39;</span><span class="p">,</span>
            <span class="s1">&#39;etot&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ekin&#39;</span><span class="p">,</span>
            <span class="s1">&#39;temperature&#39;</span><span class="p">,</span>
            <span class="s1">&#39;forces&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nstep_scf&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
            <span class="s1">&#39;natoms&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nkpoints&#39;</span><span class="p">,</span>
            <span class="s1">&#39;timestep&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_attr_lst</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_alat</span> <span class="o">=</span> <span class="n">use_alat</span></div>


    <span class="k">def</span> <span class="nf">_get_block_header_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse things like</span>

<span class="sd">            ATOMIC_POSITIONS            -&gt; None</span>
<span class="sd">            ATOMIC_POSITIONS unit       -&gt; unit</span>
<span class="sd">            ATOMIC_POSITIONS (unit)     -&gt; unit</span>
<span class="sd">            ATOMIC_POSITIONS {unit}     -&gt; unit</span>
<span class="sd">            CELL_PARAMETERS (alat=1.23) -&gt; alat</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : str (e.g. &#39;ATOMIC_POSITIONS&#39;)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str : unit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="s2">&quot;got illegal string&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;grep -m1 </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">]:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse ATOMIC_POSITIONS block. Unit is handled by get_coords_unit().&quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting _coords&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;natoms&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">try_set_attr</span><span class="p">(</span><span class="s1">&#39;natoms&#39;</span><span class="p">)</span>
            <span class="n">natoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span>
            <span class="c1"># nstep: get it from outfile b/c the value in any input file will be</span>
            <span class="c1"># wrong if the output file is a concatenation of multiple smaller files</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;ATOMIC_POSITIONS&#39;</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;grep -c </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">nstep</span> <span class="o">=</span> <span class="n">nstep_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
            <span class="c1"># coords</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;grep -A</span><span class="si">%i</span><span class="s2"> &#39;</span><span class="si">%s</span><span class="s2">&#39; </span><span class="si">%s</span><span class="s2"> | grep -v -e </span><span class="si">%s</span><span class="s2"> -e &#39;--&#39; | </span><span class="se">\</span>
<span class="s2">                  </span><span class="si">%s</span><span class="s2"> &#39;{print $2</span><span class="se">\&quot;</span><span class="s2">  </span><span class="se">\&quot;</span><span class="s2">$3</span><span class="se">\&quot;</span><span class="s2">  </span><span class="se">\&quot;</span><span class="s2">$4}&#39;&quot;</span> \
                  <span class="o">%</span><span class="p">(</span><span class="n">natoms</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">AWK</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">traj_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
                                 <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nstep</span><span class="p">,</span><span class="n">natoms</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                                 <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeaxis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_cell_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse CELL_PARAMETERS block.</span>

<span class="sd">        The block unit is ignored here. Only the content of the block is parsed</span>
<span class="sd">        (i.e. the CELL_PARAMETERS as they are in the file). See also</span>
<span class="sd">        ``_get_block_header_unit()`` and ``get_cell``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting _cell_3d&quot;</span><span class="p">)</span>
        <span class="c1"># nstep</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;CELL_PARAMETERS&#39;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;grep -c </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">nstep</span> <span class="o">=</span> <span class="n">nstep_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="c1"># cell</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;grep -A3 </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> | grep -v -e </span><span class="si">%s</span><span class="s2"> -e &#39;--&#39;&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">traj_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
                             <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nstep</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                             <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeaxis</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_cell_3d_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse CELL_PARAMETERS unit factor printed at each time step.</span>

<span class="sd">        ::</span>
<span class="sd">            CELL_PARAMETERS (alat= 22.75306514)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        alat_values : 1d array (nstep,) or None</span>
<span class="sd">            1d array with alat for each time step if &#39;CELL_PARAMETERS.*alat&#39; is</span>
<span class="sd">            found; None if not found or if use_alat=False.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        During one run, that alat value doesn&#39;t change and is the same as alat</span>
<span class="sd">        returned by ``get_alat()``. But it is needed if you parse an output</span>
<span class="sd">        file which is a concatenation of multiple smaller files from vc-md runs</span>
<span class="sd">        where that alat value has changed. This happens if a vc-md is</span>
<span class="sd">        restarted. Then the new alat in the restart run is that of the last</span>
<span class="sd">        cell of the old run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;grep -m1 CELL_PARAMETERS.*alat.*= </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">if</span> <span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_alat</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep CELL_PARAMETERS </span><span class="si">%s</span><span class="s2"> | sed -re &#39;s/.*alat.*=\s*(&quot;</span> \
                    <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="n">regex</span><span class="o">.</span><span class="n">float_re</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)\)*.*/\1/g&#39;&quot;</span>
                <span class="k">return</span> <span class="n">arr1d_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_match_nstep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get nstep from _coords.shape[0] and return the last nstep steps from</span>
<span class="sd">        the array `arr` along self.timeaxis.</span>

<span class="sd">        Used to match forces,stress,... etc to coords b/c for MDs, the former</span>
<span class="sd">        ones are always one step longer b/c of stuff printed in the first SCF</span>
<span class="sd">        loop before the MD starts.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">arr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_coords&#39;</span><span class="p">):</span>
                <span class="n">nstep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">timeaxis</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">timeaxis</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nstep</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">slicetake</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="n">nstep</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span>
                                         <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeaxis</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">arr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="PwMDOutputFile.get_coords_unit"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwMDOutputFile.get_coords_unit.html#pwtools.parse.PwMDOutputFile.get_coords_unit">[docs]</a>    <span class="k">def</span> <span class="nf">get_coords_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting coords_unit&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_block_header_unit</span><span class="p">(</span><span class="s1">&#39;ATOMIC_POSITIONS&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PwMDOutputFile.get_cell_unit"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwMDOutputFile.get_cell_unit.html#pwtools.parse.PwMDOutputFile.get_cell_unit">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting cell_unit&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_block_header_unit</span><span class="p">(</span><span class="s1">&#39;CELL_PARAMETERS&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PwMDOutputFile.get_coords"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwMDOutputFile.get_coords.html#pwtools.parse.PwMDOutputFile.get_coords">[docs]</a>    <span class="k">def</span> <span class="nf">get_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cartesian coords [Bohr]. If coords_unit=&#39;alat&#39;, then [Bohr] if</span>
<span class="sd">        self.alat in [Bohr].&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr_lst</span><span class="p">([</span><span class="s1">&#39;_coords&#39;</span><span class="p">,</span> <span class="s1">&#39;coords_unit&#39;</span><span class="p">,</span> <span class="s1">&#39;alat&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bohr&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span> <span class="o">==</span> <span class="s1">&#39;alat&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alat</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span> <span class="o">==</span> <span class="s1">&#39;angstrom&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span> <span class="o">*</span> <span class="n">Angstrom</span> <span class="o">/</span> <span class="n">Bohr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PwMDOutputFile.get_cell"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwMDOutputFile.get_cell.html#pwtools.parse.PwMDOutputFile.get_cell">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cell [Bohr]. Return 3d array from CELL_PARAMETERS or 2d array</span>
<span class="sd">        self._cell_2d. Beware: complicated units logic ahead!&quot;&quot;&quot;</span>
        <span class="c1"># From the manual, regarding the unit of CELL_PARAMETERS in the input</span>
        <span class="c1"># file:</span>
        <span class="c1">#</span>
        <span class="c1"># bohr / angstrom: lattice vectors in bohr radii / angstrom.</span>
        <span class="c1"># alat or nothing specified: if a lattice constant (celldm(1)</span>
        <span class="c1"># or a) is present, lattice vectors are in units of the lattice</span>
        <span class="c1"># constant; otherwise, in bohr radii or angstrom, as specified.</span>
        <span class="c1">#</span>
        <span class="c1"># .. yo!</span>

        <span class="c1"># MD-like case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_cell_3d&#39;</span><span class="p">):</span>
            <span class="c1"># CELL_PARAMETERS (alat=...) | bohr | angstrom | alat</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;cell_unit&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_unit</span> <span class="o">==</span> <span class="s1">&#39;bohr&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_3d</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_unit</span> <span class="o">==</span> <span class="s1">&#39;alat&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_cell_3d_factors&#39;</span><span class="p">):</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_3d</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_3d_factors</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;alat&#39;</span><span class="p">):</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_3d</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alat</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_unit</span> <span class="o">==</span> <span class="s1">&#39;angstrom&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_3d</span> <span class="o">*</span> <span class="n">Angstrom</span> <span class="o">/</span> <span class="n">Bohr</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="c1"># CELL_PARAMETERS &lt;empty&gt;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;alat&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_3d</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alat</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># return start cell 2d, will be broadcast to 3d in Trajectory</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr_lst</span><span class="p">([</span><span class="s1">&#39;_cell_2d&#39;</span><span class="p">,</span> <span class="s1">&#39;alat&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_2d</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PwMDOutputFile.get_coords_frac"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwMDOutputFile.get_coords_frac.html#pwtools.parse.PwMDOutputFile.get_coords_frac">[docs]</a>    <span class="k">def</span> <span class="nf">get_coords_frac</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fractional coords.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr_lst</span><span class="p">([</span><span class="s1">&#39;_coords&#39;</span><span class="p">,</span> <span class="s1">&#39;coords_unit&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span> <span class="o">==</span> <span class="s1">&#39;crystal&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PwMDOutputFile.get_ekin"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwMDOutputFile.get_ekin.html#pwtools.parse.PwMDOutputFile.get_ekin">[docs]</a>    <span class="k">def</span> <span class="nf">get_ekin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ion kinetic energy [Ry].&quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting ekin&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep &#39;kinetic energy&#39; </span><span class="si">%s</span><span class="s2"> | </span><span class="si">%s</span><span class="s2"> &#39;{print $5}&#39;&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                                                              <span class="n">AWK</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arr1d_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span></div>

<div class="viewcode-block" id="PwMDOutputFile.get_temperature"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwMDOutputFile.get_temperature.html#pwtools.parse.PwMDOutputFile.get_temperature">[docs]</a>    <span class="k">def</span> <span class="nf">get_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Temperature [K]&quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting temperature&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;egrep &#39;temperature[ ]*=&#39; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> \
              <span class="sa">r</span><span class="s2">&quot;| sed -re &#39;s/.*temp.*=\s*(&quot;</span> <span class="o">+</span> <span class="n">regex</span><span class="o">.</span><span class="n">float_re</span> <span class="o">+</span> \
              <span class="sa">r</span><span class="s2">&quot;)\s*K/\1/&#39;&quot;</span>
        <span class="k">return</span> <span class="n">arr1d_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span></div>

<div class="viewcode-block" id="PwMDOutputFile.get_timestep"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwMDOutputFile.get_timestep.html#pwtools.parse.PwMDOutputFile.get_timestep">[docs]</a>    <span class="k">def</span> <span class="nf">get_timestep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Time step [tryd].&quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep -m1 &#39;Time.*step&#39; </span><span class="si">%s</span><span class="s2"> | sed -re </span><span class="se">\</span>
<span class="s2">              &#39;s/.*step\s+=\s+(.*)a.u..*/\1/&#39;&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">return</span> <span class="n">float_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span></div>

<div class="viewcode-block" id="PwMDOutputFile.get_stress"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwMDOutputFile.get_stress.html#pwtools.parse.PwMDOutputFile.get_stress">[docs]</a>    <span class="k">def</span> <span class="nf">get_stress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stress tensor [kbar].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_nstep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_return</span><span class="p">(</span><span class="s1">&#39;stress&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="PwMDOutputFile.get_etot"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwMDOutputFile.get_etot.html#pwtools.parse.PwMDOutputFile.get_etot">[docs]</a>    <span class="k">def</span> <span class="nf">get_etot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[Ry] &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_nstep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_return</span><span class="p">(</span><span class="s1">&#39;etot&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="PwMDOutputFile.get_forces"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwMDOutputFile.get_forces.html#pwtools.parse.PwMDOutputFile.get_forces">[docs]</a>    <span class="k">def</span> <span class="nf">get_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[Ry / Bohr] &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;natoms&#39;</span><span class="p">):</span>
            <span class="n">forces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_nstep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_return</span><span class="p">(</span><span class="s1">&#39;forces&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">forces</span><span class="p">[:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">,:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PwMDOutputFile.get_nstep_scf"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwMDOutputFile.get_nstep_scf.html#pwtools.parse.PwMDOutputFile.get_nstep_scf">[docs]</a>    <span class="k">def</span> <span class="nf">get_nstep_scf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_return</span><span class="p">(</span><span class="s1">&#39;nstep_scf&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PwVCMDOutputFile"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwVCMDOutputFile.html#pwtools.parse.PwVCMDOutputFile">[docs]</a><span class="k">class</span> <span class="nc">PwVCMDOutputFile</span><span class="p">(</span><span class="n">PwMDOutputFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse only calculation=&#39;vc-md&#39;.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="PwVCMDOutputFile.__init__"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwVCMDOutputFile.html#pwtools.parse.PwVCMDOutputFile.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="n">PwMDOutputFile</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_attr_lst</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attr_lst</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;econst&#39;</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">_get_datadct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting _datadct&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;grep &#39;Ekin.*T.*Etot&#39; </span><span class="si">%s</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">              | </span><span class="si">%s</span><span class="s2"> &#39;{print $3</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">$7</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">$11}&#39;&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">AWK</span><span class="p">)</span>
        <span class="n">ret_str</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ret_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">ret_str</span><span class="p">)))</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;ekin&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s1">&#39;econst&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]}</span>

<div class="viewcode-block" id="PwVCMDOutputFile.get_ekin"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwVCMDOutputFile.get_ekin.html#pwtools.parse.PwVCMDOutputFile.get_ekin">[docs]</a>    <span class="k">def</span> <span class="nf">get_ekin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting ekin&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_set_attr</span><span class="p">(</span><span class="s1">&#39;_datadct&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datadct</span><span class="p">[</span><span class="s1">&#39;ekin&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="PwVCMDOutputFile.get_econst"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwVCMDOutputFile.get_econst.html#pwtools.parse.PwVCMDOutputFile.get_econst">[docs]</a>    <span class="k">def</span> <span class="nf">get_econst</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting econst&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_set_attr</span><span class="p">(</span><span class="s1">&#39;_datadct&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datadct</span><span class="p">[</span><span class="s1">&#39;econst&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="PwVCMDOutputFile.get_temperature"><a class="viewcode-back" href="../../generated/api/pwtools.parse.PwVCMDOutputFile.get_temperature.html#pwtools.parse.PwVCMDOutputFile.get_temperature">[docs]</a>    <span class="k">def</span> <span class="nf">get_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting temperature&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_set_attr</span><span class="p">(</span><span class="s1">&#39;_datadct&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datadct</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="CpmdSCFOutputFile"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdSCFOutputFile.html#pwtools.parse.CpmdSCFOutputFile">[docs]</a><span class="k">class</span> <span class="nc">CpmdSCFOutputFile</span><span class="p">(</span><span class="n">StructureFileParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse output from a CPMD &quot;single point calculation&quot; (wave function</span>
<span class="sd">    optimization).</span>

<span class="sd">    Some extra files are assumed to be in the same directory as self.filename.</span>

<span class="sd">    extra files::</span>

<span class="sd">        GEOMETRY.scale</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    * The SYSTEM section must have SCALE such that a file GEOMETRY.scale is</span>
<span class="sd">      written.</span>
<span class="sd">    * To have forces in the output, use PRINT ON FORCES COORDINATES in the CPMD</span>
<span class="sd">      section::</span>

<span class="sd">        &amp;CPMD</span>
<span class="sd">            OPTIMIZE WAVEFUNCTION</span>
<span class="sd">            CONVERGENCE ORBITALS</span>
<span class="sd">                1.0d-7</span>
<span class="sd">            PRINT ON FORCES COORDINATES</span>
<span class="sd">            STRESS TENSOR</span>
<span class="sd">                1</span>
<span class="sd">            ODIIS NO_RESET=10</span>
<span class="sd">                20</span>
<span class="sd">            MAXITER</span>
<span class="sd">                100</span>
<span class="sd">            FILEPATH</span>
<span class="sd">                /tmp</span>
<span class="sd">        &amp;END</span>
<span class="sd">        &amp;SYSTEM</span>
<span class="sd">            SCALE</span>
<span class="sd">            ....</span>
<span class="sd">        &amp;END</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_units</span> <span class="o">=</span> \
        <span class="p">{</span><span class="s1">&#39;energy&#39;</span><span class="p">:</span> <span class="n">Ha</span> <span class="o">/</span> <span class="n">eV</span><span class="p">,</span> <span class="c1"># Ha -&gt; eV</span>
         <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="n">Bohr</span> <span class="o">/</span> <span class="n">Angstrom</span><span class="p">,</span> <span class="c1"># Bohr -&gt; Angstrom</span>
         <span class="s1">&#39;forces&#39;</span><span class="p">:</span> <span class="n">Ha</span> <span class="o">/</span> <span class="n">eV</span> <span class="o">*</span> <span class="n">Angstrom</span> <span class="o">/</span> <span class="n">Bohr</span><span class="p">,</span> <span class="c1"># Ha / Bohr -&gt; eV / Angstrom</span>
         <span class="s1">&#39;stress&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="c1"># kbar -&gt; GPa</span>
        <span class="p">}</span>
<div class="viewcode-block" id="CpmdSCFOutputFile.__init__"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdSCFOutputFile.html#pwtools.parse.CpmdSCFOutputFile.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="n">StructureFileParser</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_lst</span> <span class="o">=</span> <span class="p">[</span>\
            <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stress&#39;</span><span class="p">,</span>
            <span class="s1">&#39;etot&#39;</span><span class="p">,</span>
            <span class="s1">&#39;coords_frac&#39;</span><span class="p">,</span>
            <span class="s1">&#39;symbols&#39;</span><span class="p">,</span>
            <span class="s1">&#39;forces&#39;</span><span class="p">,</span>
            <span class="s1">&#39;natoms&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nkpoints&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nstep_scf&#39;</span><span class="p">,</span>
            <span class="s1">&#39;scf_converged&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_attr_lst</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_get_coords_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Low precision cartesian coords [Bohr] + forces [Ha / Bohr] I guess.</span>
<span class="sd">        Only printed in this form if we use</span>
<span class="sd">        &amp;CPMD</span>
<span class="sd">            PRINT ON COORDINATES FORCES</span>
<span class="sd">        &amp;END</span>
<span class="sd">        Forces with more precision are printed in the files TRAJECTORY or</span>
<span class="sd">        FTRAJECTORY, but only for MD runs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting _coords_forces&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_set_attr</span><span class="p">(</span><span class="s1">&#39;natoms&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_set_attr</span><span class="p">(</span><span class="s1">&#39;natoms&#39;</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;egrep -A</span><span class="si">%i</span><span class="s2"> &#39;ATOM[ ]+COORDINATES[ ]+GRADIENTS&#39; </span><span class="si">%s</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                  | tail -n</span><span class="si">%i</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                  | </span><span class="si">%s</span><span class="s2"> &#39;{print $3</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">$4</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">$5</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">$6</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">$7</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">$8}&#39;&quot;</span> \
                  <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span> <span class="n">AWK</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">arr2d_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_scale_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read GEOMETRY.scale file with fractional coords.&quot;&quot;&quot;</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;GEOMETRY.scale&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;grep -A3 &#39;CELL MATRIX (BOHR)&#39; </span><span class="si">%s</span><span class="s2"> | tail -n3&quot;</span> <span class="o">%</span><span class="n">fn</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">arr2d_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assert_set_attr</span><span class="p">(</span><span class="s1">&#39;natoms&#39;</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;grep -A</span><span class="si">%i</span><span class="s2"> &#39;SCALED ATOMIC COORDINATES&#39; </span><span class="si">%s</span><span class="s2"> | tail -n</span><span class="si">%i</span><span class="s2">&quot;</span> \
                  <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr2d_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">coords_frac</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">symbols</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;coords_frac&#39;</span><span class="p">:</span> <span class="n">coords_frac</span><span class="p">,</span>
                    <span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="n">symbols</span><span class="p">,</span>
                    <span class="s1">&#39;cell&#39;</span><span class="p">:</span> <span class="n">cell</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_cell_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;2d array `cell` [Bohr] for fixed-cell MD or SCF from GEOMETRY.scale</span>
<span class="sd">        file.&quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting _cell_2d&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_scale_file&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_file</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="CpmdSCFOutputFile.get_cell"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdSCFOutputFile.get_cell.html#pwtools.parse.CpmdSCFOutputFile.get_cell">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;2d cell [Bohr]&quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting cell&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_return_attr</span><span class="p">(</span><span class="s1">&#39;_cell_2d&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CpmdSCFOutputFile.get_stress"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdSCFOutputFile.get_stress.html#pwtools.parse.CpmdSCFOutputFile.get_stress">[docs]</a>    <span class="k">def</span> <span class="nf">get_stress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[kbar]&quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting stress&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;grep -A3 &#39;TOTAL STRESS TENSOR&#39; </span><span class="si">%s</span><span class="s2"> | tail -n3&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">return</span> <span class="n">arr2d_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span></div>

<div class="viewcode-block" id="CpmdSCFOutputFile.get_etot"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdSCFOutputFile.get_etot.html#pwtools.parse.CpmdSCFOutputFile.get_etot">[docs]</a>    <span class="k">def</span> <span class="nf">get_etot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[Ha]&quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting etot&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span>  <span class="sa">r</span><span class="s2">&quot;grep &#39;TOTAL ENERGY =&#39; </span><span class="si">%s</span><span class="s2"> | tail -n1 | </span><span class="si">%s</span><span class="s2"> &#39;{print $5}&#39;&quot;</span> \
        <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">AWK</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">float_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span></div>

<div class="viewcode-block" id="CpmdSCFOutputFile.get_coords_frac"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdSCFOutputFile.get_coords_frac.html#pwtools.parse.CpmdSCFOutputFile.get_coords_frac">[docs]</a>    <span class="k">def</span> <span class="nf">get_coords_frac</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting coords_frac&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_scale_file&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_file</span><span class="p">[</span><span class="s1">&#39;coords_frac&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CpmdSCFOutputFile.get_symbols"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdSCFOutputFile.get_symbols.html#pwtools.parse.CpmdSCFOutputFile.get_symbols">[docs]</a>    <span class="k">def</span> <span class="nf">get_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting symbols&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_scale_file&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_file</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CpmdSCFOutputFile.get_forces"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdSCFOutputFile.get_forces.html#pwtools.parse.CpmdSCFOutputFile.get_forces">[docs]</a>    <span class="k">def</span> <span class="nf">get_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[Ha / Bohr]&quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting forces&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_coords_forces&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords_forces</span><span class="p">[:,</span><span class="mi">3</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CpmdSCFOutputFile.get_natoms"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdSCFOutputFile.get_natoms.html#pwtools.parse.CpmdSCFOutputFile.get_natoms">[docs]</a>    <span class="k">def</span> <span class="nf">get_natoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of atoms. Apparently only printed as &quot;NUMBER OF ATOMS ...&quot; in</span>
<span class="sd">        the SCF case, not in MD. So we use &quot;grep -c&quot; on the GEOMETRY file, which</span>
<span class="sd">        has `natoms` lines (normally) and 6 colunms. Sometimes (so far seen in</span>
<span class="sd">        variable cell calcs) there are some additional lines w/ 3 columns,</span>
<span class="sd">        which we skip.&quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting natoms&quot;</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;GEOMETRY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;egrep -c &#39;([0-9][ ]+.*){5,}&#39; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">fn</span>
            <span class="k">return</span> <span class="n">int_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CpmdSCFOutputFile.get_nkpoints"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdSCFOutputFile.get_nkpoints.html#pwtools.parse.CpmdSCFOutputFile.get_nkpoints">[docs]</a>    <span class="k">def</span> <span class="nf">get_nkpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting nkpoints&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep &#39;NUMBER OF SPECIAL K POINTS&#39; </span><span class="si">%s</span><span class="s2"> | </span><span class="se">\</span>
<span class="s2">            sed -re &#39;s/.*COORDINATES\):\s*([0-9]+)\s*.*/\1/&#39;&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">return</span> <span class="n">int_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span></div>

<div class="viewcode-block" id="CpmdSCFOutputFile.get_nstep_scf"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdSCFOutputFile.get_nstep_scf.html#pwtools.parse.CpmdSCFOutputFile.get_nstep_scf">[docs]</a>    <span class="k">def</span> <span class="nf">get_nstep_scf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting nstep_scf&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep -B2 &#39;RESTART INFORMATION WRITTEN&#39; </span><span class="si">%s</span><span class="s2"> | head -n1 </span><span class="se">\</span>
<span class="s2">              | </span><span class="si">%s</span><span class="s2"> &#39;{print $1}&#39;&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">AWK</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">int_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span></div>

<div class="viewcode-block" id="CpmdSCFOutputFile.get_scf_converged"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdSCFOutputFile.get_scf_converged.html#pwtools.parse.CpmdSCFOutputFile.get_scf_converged">[docs]</a>    <span class="k">def</span> <span class="nf">get_scf_converged</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting scf_converged&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;grep &#39;BUT NO CONVERGENCE&#39; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">if</span> <span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="CpmdMDOutputFile"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdMDOutputFile.html#pwtools.parse.CpmdMDOutputFile">[docs]</a><span class="k">class</span> <span class="nc">CpmdMDOutputFile</span><span class="p">(</span><span class="n">TrajectoryFileParser</span><span class="p">,</span> <span class="n">CpmdSCFOutputFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse CPMD MD output.</span>

<span class="sd">    Works with BO-MD and CP-MD, fixed and variable cell. Some attrs may be None</span>
<span class="sd">    or have different shapes (2d va 3d arrays) depending on what type of MD is</span>
<span class="sd">    parsed and what info/files are available.</span>

<span class="sd">    Notes for the comments below::</span>

<span class="sd">        {A,B,C} = A or B or C</span>
<span class="sd">        (A) = A is optional</span>
<span class="sd">        (A (B)) = A is optional, but only if present, B is optional</span>

<span class="sd">    Extra files which will be parsed and MUST be present::</span>

<span class="sd">        GEOMETRY.scale</span>
<span class="sd">        GEOMETRY</span>
<span class="sd">        TRAJECTORY</span>
<span class="sd">        ENERGIES</span>

<span class="sd">    Extra files which will be parsed and MAY be present depending on the type</span>
<span class="sd">    of MD::</span>

<span class="sd">        (FTRAJECTORY)</span>
<span class="sd">        (CELL)</span>
<span class="sd">        (STRESS)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The input should look like that::</span>

<span class="sd">        &amp;CPMD</span>
<span class="sd">            MOLECULAR DYNAMICS {BO,CP}</span>
<span class="sd">            (PARRINELLO-RAHMAN (NPT))</span>
<span class="sd">            PRINT ON FORCES COORDINATES</span>
<span class="sd">            TRAJECTORY XYZ FORCES</span>
<span class="sd">            STRESS TENSOR</span>
<span class="sd">                &lt;step&gt;</span>
<span class="sd">            ...</span>
<span class="sd">        &amp;END</span>

<span class="sd">        &amp;SYSTEM</span>
<span class="sd">            SCALE</span>
<span class="sd">            ...</span>
<span class="sd">        &amp;END</span>

<span class="sd">    Tested with CPMD 3.15.1, the following extra files are always written::</span>

<span class="sd">        GEOMETRY.scale</span>
<span class="sd">        GEOMETRY</span>
<span class="sd">        TRAJECTORY</span>
<span class="sd">        ENERGIES</span>

<span class="sd">    In the listing below, we show which extra files are written (+) or not (-)</span>
<span class="sd">    if the input follows the example above.</span>

<span class="sd">    Also, the order of columns in the ENERGIES file depends on what type of MD</span>
<span class="sd">    we are running. In case of BO-MD it depends on the kind of wavefunction</span>
<span class="sd">    optimizer, too! This is most unpleasant. Currently we rely on the fact that</span>
<span class="sd">    each tested case has a different number of columns, but this is very</span>
<span class="sd">    hackish b/c it is not guaranteed to be unique! Maybe, we should let the</span>
<span class="sd">    user set self.energies_order or a keywords mdtype={&#39;cp-npt&#39;, &#39;bo&#39;, etc}</span>
<span class="sd">    instead of subclassed for each case.</span>

<span class="sd">    This is what we tested so far (cpmd 3.15.1). For BO-MD + ODIIS, some</span>
<span class="sd">    columns are always 0.0, but all are there (e.g. EKINC is there but 0.0 b/c</span>
<span class="sd">    not defined for BO, only CP). For BO-MD, we list the wf optimizer (xxx for</span>
<span class="sd">    CP b/c there is none)::</span>

<span class="sd">        MOLECULAR DYNAMICS BO</span>
<span class="sd">            +FTRAJECTORY</span>
<span class="sd">            -CELL</span>
<span class="sd">            -STRESS         # why!?</span>
<span class="sd">          ODISS</span>
<span class="sd">            NFI EKINC TEMPP EKS ECLASSIC EHAM DIS TCPU</span>
<span class="sd">          LANCZOS DIAGONALIZATION</span>
<span class="sd">            NFI TEMPP EKS ECLASSIC DIS TCPU</span>

<span class="sd">        MOLECULAR DYNAMICS CP</span>
<span class="sd">            +FTRAJECTORY</span>
<span class="sd">            -CELL</span>
<span class="sd">            +STRESS</span>
<span class="sd">          xxx</span>
<span class="sd">            NFI EKINC TEMPP EKS ECLASSIC EHAM DIS TCPU</span>

<span class="sd">        MOLECULAR DYNAMICS BO</span>
<span class="sd">        PARRINELLO-RAHMAN</span>
<span class="sd">            not implemented !</span>

<span class="sd">        MOLECULAR DYNAMICS CP</span>
<span class="sd">        PARRINELLO-RAHMAN</span>
<span class="sd">            -FTRAJECTORY    # why!?</span>
<span class="sd">            +CELL</span>
<span class="sd">            +STRESS</span>
<span class="sd">          xxx</span>
<span class="sd">            NFI EKINC EKINH TEMPP EKS ECLASSIC EHAM DIS TCPU</span>

<span class="sd">        MOLECULAR DYNAMICS BO</span>
<span class="sd">        PARRINELLO-RAHMAN NPT</span>
<span class="sd">            -FTRAJECTORY    # why!?</span>
<span class="sd">            +CELL</span>
<span class="sd">            +STRESS</span>
<span class="sd">          ODIIS</span>
<span class="sd">            NFI EKINC EKINH TEMPP EKS ECLASSIC EHAM DIS TCPU</span>

<span class="sd">        MOLECULAR DYNAMICS CP</span>
<span class="sd">        PARRINELLO-RAHMAN NPT</span>
<span class="sd">            -FTRAJECTORY    # why!?</span>
<span class="sd">            +CELL</span>
<span class="sd">            +STRESS</span>
<span class="sd">          xxx</span>
<span class="sd">            NFI EKINC EKINH TEMPP EKS ECLASSIC EHAM DIS TCPU</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CpmdMDOutputFile.__init__"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdMDOutputFile.html#pwtools.parse.CpmdMDOutputFile.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : file to parse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_units</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>\
            <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">thart</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">fs</span><span class="p">,</span> <span class="c1"># thart -&gt; fs</span>
             <span class="s1">&#39;velocity&#39;</span><span class="p">:</span> <span class="n">Bohr</span> <span class="o">/</span> <span class="n">Ang</span> <span class="o">*</span> <span class="n">fs</span> <span class="o">/</span> <span class="n">thart</span><span class="p">,</span>    <span class="c1"># Bohr / thart -&gt; Ang / fs</span>
            <span class="p">})</span>
        <span class="n">TrajectoryFileParser</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_lst</span> <span class="o">=</span> <span class="p">[</span>\
            <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
            <span class="s1">&#39;coords&#39;</span><span class="p">,</span>
            <span class="s1">&#39;econst&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ekin&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ekin_cell&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ekin_elec&#39;</span><span class="p">,</span>
            <span class="s1">&#39;etot&#39;</span><span class="p">,</span>
            <span class="s1">&#39;forces&#39;</span><span class="p">,</span>
            <span class="s1">&#39;natoms&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stress&#39;</span><span class="p">,</span>
            <span class="s1">&#39;symbols&#39;</span><span class="p">,</span>
            <span class="s1">&#39;temperature&#39;</span><span class="p">,</span>
            <span class="s1">&#39;temperature_cell&#39;</span><span class="p">,</span>
            <span class="s1">&#39;timestep&#39;</span><span class="p">,</span>
            <span class="s1">&#39;velocity&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_attr_lst</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_energies_order</span> <span class="o">=</span> <span class="p">{</span>\
            <span class="mi">9</span><span class="p">:</span>\
                <span class="p">{</span><span class="s1">&#39;nfi&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="s1">&#39;ekinc&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="s1">&#39;ekinh&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                 <span class="s1">&#39;tempp&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                 <span class="s1">&#39;eks&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                 <span class="s1">&#39;eclassic&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                 <span class="s1">&#39;eham&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                 <span class="s1">&#39;dis&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
                 <span class="s1">&#39;tcpu&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span>
            <span class="mi">8</span><span class="p">:</span>\
                <span class="p">{</span><span class="s1">&#39;nfi&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="s1">&#39;ekinc&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="s1">&#39;tempp&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                 <span class="s1">&#39;eks&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                 <span class="s1">&#39;eclassic&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                 <span class="s1">&#39;eham&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                 <span class="s1">&#39;dis&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                 <span class="s1">&#39;tcpu&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">},</span>
            <span class="mi">6</span><span class="p">:</span>\
                <span class="p">{</span><span class="s1">&#39;nfi&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="s1">&#39;tempp&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="s1">&#39;eks&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                 <span class="s1">&#39;eclassic&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                 <span class="s1">&#39;dis&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                 <span class="s1">&#39;tcpu&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
            <span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">_get_energies_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting _energies_file&quot;</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;ENERGIES&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ncols</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_energies_order</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;only </span><span class="si">%s</span><span class="s2"> columns supported in &quot;</span>
                    <span class="s2">&quot;ENERGIES file&quot;</span> <span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_energies_order</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energies_order</span><span class="p">[</span><span class="n">ncols</span><span class="p">]</span>
            <span class="n">dct</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">arr</span>
            <span class="k">return</span> <span class="n">dct</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_coords_vel_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting _coords_vel_forces&quot;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Parse (F)TRAJECTORY file. Ignore lines which say</span>
<span class="sd">        &quot;&lt;&lt;&lt;&lt;&lt;&lt;  NEW DATA  &gt;&gt;&gt;&gt;&gt;&gt;&quot; from restarts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># cols (both files):</span>
        <span class="c1">#   0:   natoms x nfi (natoms x 1, natoms x 2, ...)</span>
        <span class="c1">#   1-3: x,y,z cartesian coords [Bohr]</span>
        <span class="c1">#   4-6: x,y,z cartesian velocites [Bohr / thart ]</span>
        <span class="c1">#        thart = Hartree time =  0.024189 fs</span>
        <span class="c1"># FTRAJECTORY extra:</span>
        <span class="c1">#   7-9: x,y,z cartesian forces [Ha / Bohr]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_set_attr</span><span class="p">(</span><span class="s1">&#39;natoms&#39;</span><span class="p">)</span>
        <span class="n">have_file</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">have_forces</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fn_tr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;TRAJECTORY&#39;</span><span class="p">)</span>
        <span class="n">fn_ftr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;FTRAJECTORY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_ftr</span><span class="p">):</span>
            <span class="n">have_forces</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">have_file</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">fn_ftr</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_tr</span><span class="p">):</span>
            <span class="n">have_forces</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">have_file</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">fn_tr</span>
        <span class="k">if</span> <span class="n">have_file</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;grep -c -v &#39;&lt;&lt;&lt;&lt;&#39; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">fn</span>
            <span class="n">nlines</span> <span class="o">=</span> <span class="n">int_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
            <span class="n">nstep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nlines</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">nstep</span> <span class="o">%</span> <span class="mf">1.0</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span> <span class="o">+</span> \
                <span class="s2">&quot;nlines is not a multiple of nstep in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">nstep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nstep</span><span class="p">)</span>
            <span class="c1"># Need to use the slower arrayio.readtxt() here instead of</span>
            <span class="c1"># traj_from_txt() which uses fast fromstring() b/c we have</span>
            <span class="c1"># comments=&#39;&lt;&lt;&lt;&lt;&#39;. The other way would be to  use</span>
            <span class="c1"># common.backtick(&quot;grep -v &#39;&lt;&lt;&lt;&lt;&#39; ...&quot;)) the text such that we have</span>
            <span class="c1"># only numbers in it and then pass that to traj_from_txt().</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">arrayio</span><span class="o">.</span><span class="n">readtxt</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeaxis</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span>
                             <span class="n">comments</span><span class="o">=</span><span class="s1">&#39;&lt;&lt;&lt;&lt;&#39;</span><span class="p">)</span>
            <span class="n">dct</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>
            <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;forces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">7</span><span class="p">:]</span> <span class="k">if</span> <span class="n">have_forces</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">dct</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="CpmdMDOutputFile.get_ekin"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdMDOutputFile.get_ekin.html#pwtools.parse.CpmdMDOutputFile.get_ekin">[docs]</a>    <span class="k">def</span> <span class="nf">get_ekin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_energies_file&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energies_file</span><span class="p">[</span><span class="s1">&#39;eclassic&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CpmdMDOutputFile.get_cell"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdMDOutputFile.get_cell.html#pwtools.parse.CpmdMDOutputFile.get_cell">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting cell&quot;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Parse CELL file [Bohr]. If CELL is not there, return 2d cell</span>
<span class="sd">        from GEOMETRY.scale (self.cell from CpmdSCFOutputFile).&quot;&quot;&quot;</span>
        <span class="c1"># So far tested CELL files have 6 cols:</span>
        <span class="c1"># 1-3: x,y,z cell vectors</span>
        <span class="c1"># 4-6: cell forces? ditch them for now ...</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;CELL&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;head -n2 </span><span class="si">%s</span><span class="s2"> | tail -n1 | wc | </span><span class="si">%s</span><span class="s2"> &#39;{print $2}&#39;&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">AWK</span><span class="p">)</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="n">int_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;grep -c &#39;CELL PARAMETERS&#39; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">fn</span>
            <span class="n">nstep</span> <span class="o">=</span> <span class="n">int_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;grep -A3 &#39;CELL PARAMETERS&#39; </span><span class="si">%s</span><span class="s2"> | grep -v &#39;CELL&#39;&quot;</span> <span class="o">%</span><span class="n">fn</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">traj_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
                                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nstep</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">ncols</span><span class="p">),</span>
                                <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeaxis</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">arr</span><span class="p">[</span><span class="o">...</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_cell_2d&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_2d</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CpmdMDOutputFile.get_coords"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdMDOutputFile.get_coords.html#pwtools.parse.CpmdMDOutputFile.get_coords">[docs]</a>    <span class="k">def</span> <span class="nf">get_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting coords&quot;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Cartesian coords [Bohr].&quot;&quot;&quot;</span>
        <span class="n">req</span> <span class="o">=</span> <span class="s1">&#39;_coords_vel_forces&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_set_attr</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords_vel_forces</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_set_attr</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> \
            <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CpmdMDOutputFile.get_econst"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdMDOutputFile.get_econst.html#pwtools.parse.CpmdMDOutputFile.get_econst">[docs]</a>    <span class="k">def</span> <span class="nf">get_econst</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[Ha]&quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting econst&quot;</span><span class="p">)</span>
        <span class="n">req</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_energies_file&#39;</span><span class="p">,</span> <span class="s1">&#39;etot&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_set_attr_lst</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_set_attr_lst</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;eham&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energies_file</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energies_file</span><span class="p">[</span><span class="s1">&#39;eham&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">etot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CpmdMDOutputFile.get_ekinc"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdMDOutputFile.get_ekinc.html#pwtools.parse.CpmdMDOutputFile.get_ekinc">[docs]</a>    <span class="k">def</span> <span class="nf">get_ekinc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting ekinc&quot;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Fictitious electron kinetic energy [Ha].&quot;&quot;&quot;</span>
        <span class="n">req</span> <span class="o">=</span> <span class="s1">&#39;_energies_file&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_set_attr</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_set_attr</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;ekinc&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energies_file</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energies_file</span><span class="p">[</span><span class="s1">&#39;ekinc&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CpmdMDOutputFile.get_etot"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdMDOutputFile.get_etot.html#pwtools.parse.CpmdMDOutputFile.get_etot">[docs]</a>    <span class="k">def</span> <span class="nf">get_etot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting etot&quot;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Totat energy = EKS = Kohn Sham energy? [Ha].&quot;&quot;&quot;</span>
        <span class="n">req</span> <span class="o">=</span> <span class="s1">&#39;_energies_file&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_set_attr</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energies_file</span><span class="p">[</span><span class="s1">&#39;eks&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_set_attr</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> \
            <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CpmdMDOutputFile.get_ekinh"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdMDOutputFile.get_ekinh.html#pwtools.parse.CpmdMDOutputFile.get_ekinh">[docs]</a>    <span class="k">def</span> <span class="nf">get_ekinh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting ekinh&quot;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Fictitious cell kinetic energy [Ha].</span>
<span class="sd">        From prcpmd.F:</span>
<span class="sd">            EKINH [J] = 9/2 * kb [J/K] * TEMPH [K]</span>
<span class="sd">            EKINH [Ha] = 9/2 * kb [J/K] * TEMPH [K] / Ha</span>
<span class="sd">        where TEMPH is the fictitious cell temperature.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">req</span> <span class="o">=</span> <span class="s1">&#39;_energies_file&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_set_attr</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_set_attr</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;ekinh&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energies_file</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energies_file</span><span class="p">[</span><span class="s1">&#39;ekinh&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1"># alias</span>
<div class="viewcode-block" id="CpmdMDOutputFile.get_ekin_cell"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdMDOutputFile.get_ekin_cell.html#pwtools.parse.CpmdMDOutputFile.get_ekin_cell">[docs]</a>    <span class="k">def</span> <span class="nf">get_ekin_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting ekin_cell&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ekinh</span><span class="p">()</span></div>

    <span class="c1"># alias</span>
<div class="viewcode-block" id="CpmdMDOutputFile.get_ekin_elec"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdMDOutputFile.get_ekin_elec.html#pwtools.parse.CpmdMDOutputFile.get_ekin_elec">[docs]</a>    <span class="k">def</span> <span class="nf">get_ekin_elec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting ekin_elec&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ekinc</span><span class="p">()</span></div>

<div class="viewcode-block" id="CpmdMDOutputFile.get_temperature_cell"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdMDOutputFile.get_temperature_cell.html#pwtools.parse.CpmdMDOutputFile.get_temperature_cell">[docs]</a>    <span class="k">def</span> <span class="nf">get_temperature_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[K]&quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting temperature_cell&quot;</span><span class="p">)</span>
        <span class="n">req</span> <span class="o">=</span> <span class="s1">&#39;ekin_cell&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_set_attr</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_set_attr</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ekin_cell</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">9.0</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">kb</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">Ha</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CpmdMDOutputFile.get_forces"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdMDOutputFile.get_forces.html#pwtools.parse.CpmdMDOutputFile.get_forces">[docs]</a>    <span class="k">def</span> <span class="nf">get_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cartesian forces [Ha/Bohr].&quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting forces&quot;</span><span class="p">)</span>
        <span class="n">req</span> <span class="o">=</span> <span class="s1">&#39;_coords_vel_forces&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_set_attr</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords_vel_forces</span><span class="p">[</span><span class="s1">&#39;forces&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_set_attr</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> \
            <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CpmdMDOutputFile.get_stress"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdMDOutputFile.get_stress.html#pwtools.parse.CpmdMDOutputFile.get_stress">[docs]</a>    <span class="k">def</span> <span class="nf">get_stress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stress tensor from STRESS file if available [kbar]&quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting stress&quot;</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;STRESS&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;grep -c &#39;TOTAL STRESS&#39; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">fn</span>
            <span class="n">nstep</span> <span class="o">=</span> <span class="n">int_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;grep -A3 &#39;TOTAL STRESS TENSOR&#39; </span><span class="si">%s</span><span class="s2"> | grep -v TOTAL&quot;</span> <span class="o">%</span><span class="n">fn</span>
            <span class="k">return</span> <span class="n">traj_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
                                 <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nstep</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                                 <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeaxis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CpmdMDOutputFile.get_temperature"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdMDOutputFile.get_temperature.html#pwtools.parse.CpmdMDOutputFile.get_temperature">[docs]</a>    <span class="k">def</span> <span class="nf">get_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[K]&quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting temperature&quot;</span><span class="p">)</span>
        <span class="n">req</span> <span class="o">=</span> <span class="s1">&#39;_energies_file&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">try_set_attr</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energies_file</span><span class="p">[</span><span class="s1">&#39;tempp&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_set_attr</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> \
            <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CpmdMDOutputFile.get_velocity"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdMDOutputFile.get_velocity.html#pwtools.parse.CpmdMDOutputFile.get_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">get_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;getting velocity&quot;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Cartesian velocity [Bohr / thart]. Not sure about the unit!&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_coords_vel_forces&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords_vel_forces</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CpmdMDOutputFile.get_timestep"><a class="viewcode-back" href="../../generated/api/pwtools.parse.CpmdMDOutputFile.get_timestep.html#pwtools.parse.CpmdMDOutputFile.get_timestep">[docs]</a>    <span class="k">def</span> <span class="nf">get_timestep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Timestep [thart].&quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep &#39;TIME STEP FOR IONS&#39; </span><span class="si">%s</span><span class="s2"> | </span><span class="se">\</span>
<span class="s2">            sed -re &#39;s/.*IONS:\s+(.*)$/\1/&#39;&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">return</span> <span class="n">float_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="Cp2kSCFOutputFile"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kSCFOutputFile.html#pwtools.parse.Cp2kSCFOutputFile">[docs]</a><span class="k">class</span> <span class="nc">Cp2kSCFOutputFile</span><span class="p">(</span><span class="n">StructureFileParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;CP2K SCF output parser (&quot;global/run_type energy_force,print_level low&quot;).</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    * Since we mainly use &quot;global/print_level low&quot;, we don&#39;t bother to</span>
<span class="sd">      special-case for &quot;global/print_level medium&quot;. Therefore, we don&#39;t extract</span>
<span class="sd">      cell and coords. SCF runs are only done for convergence tests, so forces,</span>
<span class="sd">      etot and stress are important.</span>
<span class="sd">    * It seems that with default &amp;print settings, SCF runs write the stress</span>
<span class="sd">      tensor in GPa, while for MD, the default is bar. Thank you very much!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_units</span> <span class="o">=</span> \
        <span class="p">{</span><span class="s1">&#39;energy&#39;</span><span class="p">:</span> <span class="n">Ha</span> <span class="o">/</span> <span class="n">eV</span><span class="p">,</span> <span class="c1"># Ha -&gt; eV</span>
         <span class="s1">&#39;forces&#39;</span><span class="p">:</span> <span class="n">Ha</span> <span class="o">/</span> <span class="n">eV</span> <span class="o">*</span> <span class="n">Angstrom</span> <span class="o">/</span> <span class="n">Bohr</span><span class="p">,</span> <span class="c1"># Ha / Bohr -&gt; eV / Angstrom</span>
        <span class="p">}</span>

<div class="viewcode-block" id="Cp2kSCFOutputFile.__init__"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kSCFOutputFile.html#pwtools.parse.Cp2kSCFOutputFile.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="n">StructureFileParser</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_lst</span> <span class="o">=</span> <span class="p">[</span>\
            <span class="s1">&#39;natoms&#39;</span><span class="p">,</span>
            <span class="s1">&#39;etot&#39;</span><span class="p">,</span>
            <span class="s1">&#39;forces&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stress&#39;</span><span class="p">,</span>
            <span class="s1">&#39;symbols&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_attr_lst</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_get_run_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep -m1 &#39;GLOBAL.*Run type&#39; </span><span class="si">{0}</span><span class="s2"> | sed </span><span class="se">\</span>
<span class="s2">            -re &#39;s/.*type\s+(.*)\s*/\1/&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_natoms_symbols_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;sed -nre &#39;1,/ATOMIC FORCES/d; &quot;</span> <span class="o">+</span> \
              <span class="sa">r</span><span class="s2">&quot;1,/Atom\s+Kind\s+Element/d; &quot;</span> <span class="o">+</span> \
              <span class="sa">r</span><span class="s2">&quot;/SUM OF ATOMIC FORCES/q;p&#39; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()])</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;natoms&#39;</span><span class="p">:</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="s1">&#39;forces&#39;</span><span class="p">:</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Cp2kSCFOutputFile.get_natoms"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kSCFOutputFile.get_natoms.html#pwtools.parse.Cp2kSCFOutputFile.get_natoms">[docs]</a>    <span class="k">def</span> <span class="nf">get_natoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_natoms_symbols_forces&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_natoms_symbols_forces</span><span class="p">[</span><span class="s1">&#39;natoms&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Cp2kSCFOutputFile.get_symbols"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kSCFOutputFile.get_symbols.html#pwtools.parse.Cp2kSCFOutputFile.get_symbols">[docs]</a>    <span class="k">def</span> <span class="nf">get_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_natoms_symbols_forces&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_natoms_symbols_forces</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Cp2kSCFOutputFile.get_forces"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kSCFOutputFile.get_forces.html#pwtools.parse.Cp2kSCFOutputFile.get_forces">[docs]</a>    <span class="k">def</span> <span class="nf">get_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[Ha/Bohr]&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_natoms_symbols_forces&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_natoms_symbols_forces</span><span class="p">[</span><span class="s1">&#39;forces&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Cp2kSCFOutputFile.get_etot"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kSCFOutputFile.get_etot.html#pwtools.parse.Cp2kSCFOutputFile.get_etot">[docs]</a>    <span class="k">def</span> <span class="nf">get_etot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[Ha]&quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;sed -nre &#39;s/.*ENERGY.*Total.*energy.*:(.*)/\1/p&#39; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">return</span> <span class="n">float_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span></div>


<div class="viewcode-block" id="Cp2kSCFOutputFile.get_stress"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kSCFOutputFile.get_stress.html#pwtools.parse.Cp2kSCFOutputFile.get_stress">[docs]</a>    <span class="k">def</span> <span class="nf">get_stress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[GPa]&quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep -A5 &#39;STRESS TENSOR.*GPa&#39; </span><span class="si">%s</span><span class="s2"> | egrep -v &#39;X[ ]+Y[ ]+Z&#39; | </span><span class="se">\</span>
<span class="s2">            egrep &#39;^[ ]+(X|Y|Z)&#39;&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()])</span>
        <span class="k">return</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Cp2kMDOutputFile"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kMDOutputFile.html#pwtools.parse.Cp2kMDOutputFile">[docs]</a><span class="k">class</span> <span class="nc">Cp2kMDOutputFile</span><span class="p">(</span><span class="n">TrajectoryFileParser</span><span class="p">,</span> <span class="n">Cp2kSCFOutputFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;CP2K MD output parser. Tested with cp2k v2.4, &quot;global/run_type</span>
<span class="sd">    md,print_level low&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Cp2kMDOutputFile.__init__"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kMDOutputFile.html#pwtools.parse.Cp2kMDOutputFile.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_units</span><span class="p">[</span><span class="s1">&#39;stress&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-4</span> <span class="c1"># bar -&gt; GPa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_units</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Bohr</span><span class="o">/</span><span class="n">thart</span> <span class="o">/</span> <span class="n">Ang</span><span class="o">*</span><span class="n">fs</span> <span class="c1"># Bohr/thart -&gt; Ang/fs</span>
        <span class="n">TrajectoryFileParser</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_lst</span> <span class="o">=</span> <span class="p">[</span>\
            <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
            <span class="s1">&#39;coords&#39;</span><span class="p">,</span>
            <span class="s1">&#39;econst&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ekin&#39;</span><span class="p">,</span>
            <span class="s1">&#39;etot&#39;</span><span class="p">,</span>
            <span class="s1">&#39;forces&#39;</span><span class="p">,</span>
            <span class="s1">&#39;natoms&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stress&#39;</span><span class="p">,</span>
            <span class="s1">&#39;symbols&#39;</span><span class="p">,</span>
            <span class="s1">&#39;temperature&#39;</span><span class="p">,</span>
            <span class="s1">&#39;timestep&#39;</span><span class="p">,</span>
            <span class="s1">&#39;velocity&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_attr_lst</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cell_file</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">pj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;PROJECT-1.cell&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ener_file</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">pj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;PROJECT-1.ener&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stress_file</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">pj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;PROJECT-1.stress&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos_file</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">pj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;PROJECT-pos-1.xyz&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frc_file</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">pj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;PROJECT-frc-1.xyz&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vel_file</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">pj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;PROJECT-vel-1.xyz&#39;</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_cp2k_repack_arr</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert arr, which is an unrolled (nstep,3,3) array, back.&quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[:,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[:,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[:,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">10</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_cp2k_xyz2arr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse cp2k style XYZ files and return the 3d array.&quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;grep -c &#39;i = .*E =&#39; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">fn</span>
        <span class="n">nstep</span> <span class="o">=</span> <span class="n">nstep_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="n">natoms</span> <span class="o">=</span> <span class="n">int_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="s2">&quot;head -n1 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">fn</span><span class="p">))</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &#39;!/i =.*E =|^[ ]+[0-9]+/ </span><span class="se">\</span>
<span class="s2">            {print $2</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">$3</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">$4}&#39; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">AWK</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeaxis</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nstep</span><span class="p">,</span><span class="n">natoms</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_cell_file_arr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cell_file</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cell_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_ener_file_arr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ener_file</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ener_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_stress_file_arr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stress_file</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stress_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Cp2kMDOutputFile.get_natoms"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kMDOutputFile.get_natoms.html#pwtools.parse.Cp2kMDOutputFile.get_natoms">[docs]</a>    <span class="k">def</span> <span class="nf">get_natoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep -m1 &#39;Number of atoms:&#39; </span><span class="si">%s</span><span class="s2"> | </span><span class="se">\</span>
<span class="s2">            sed -re &#39;s/.*:(.*)/\1/&#39;&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">return</span> <span class="n">int_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span></div>

<div class="viewcode-block" id="Cp2kMDOutputFile.get_timestep"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kMDOutputFile.get_timestep.html#pwtools.parse.Cp2kMDOutputFile.get_timestep">[docs]</a>    <span class="k">def</span> <span class="nf">get_timestep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[fs]&quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;egrep -m1 &#39;MD\| Time Step \[fs\]&#39; </span><span class="si">%s</span><span class="s2"> | </span><span class="se">\</span>
<span class="s2">            sed -re &#39;s/.*\](.*)/\1/&#39;&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">return</span> <span class="n">float_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span></div>

<div class="viewcode-block" id="Cp2kMDOutputFile.get_symbols"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kMDOutputFile.get_symbols.html#pwtools.parse.Cp2kMDOutputFile.get_symbols">[docs]</a>    <span class="k">def</span> <span class="nf">get_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frc_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vel_file</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;natoms&#39;</span><span class="p">):</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep -m1 -A</span><span class="si">%i</span><span class="s2"> &#39;i =&#39; </span><span class="si">%s</span><span class="s2"> | </span><span class="se">\</span>
<span class="s2">                    grep -v &#39;i =&#39;| </span><span class="si">%s</span><span class="s2"> &#39;{print $1}&#39;&quot;</span> \
                    <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">AWK</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">_get_forces_from_outfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;natoms&#39;</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep -c &#39;ATOMIC FORCES in&#39; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
            <span class="n">nstep</span> <span class="o">=</span> <span class="n">nstep_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;sed -re &#39;/^\s*$/d&#39; </span><span class="si">{fn}</span><span class="s2"> | grep -A</span><span class="si">{nlines}</span><span class="s2"> &#39;ATOMIC FORCES in&#39; </span><span class="se">\</span>
<span class="s2">                 | egrep -v -e &#39;ATOM|--|Kind&#39; </span><span class="se">\</span>
<span class="s2">                 | tr -s &#39; &#39; | cut -d &#39; &#39; -f5-&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                                                       <span class="n">nlines</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">traj_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
                                 <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nstep</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                                 <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeaxis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Cp2kMDOutputFile.get_coords"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kMDOutputFile.get_coords.html#pwtools.parse.Cp2kMDOutputFile.get_coords">[docs]</a>    <span class="k">def</span> <span class="nf">get_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cartesian [Ang]&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos_file</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cp2k_xyz2arr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Cp2kMDOutputFile.get_forces"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kMDOutputFile.get_forces.html#pwtools.parse.Cp2kMDOutputFile.get_forces">[docs]</a>    <span class="k">def</span> <span class="nf">get_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[Ha/Bohr]&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_frc_file</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cp2k_xyz2arr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_frc_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_forces_from_outfile</span><span class="p">()</span></div>

<div class="viewcode-block" id="Cp2kMDOutputFile.get_velocity"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kMDOutputFile.get_velocity.html#pwtools.parse.Cp2kMDOutputFile.get_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">get_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[Bohr/thart]&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vel_file</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cp2k_xyz2arr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vel_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Cp2kMDOutputFile.get_stress"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kMDOutputFile.get_stress.html#pwtools.parse.Cp2kMDOutputFile.get_stress">[docs]</a>    <span class="k">def</span> <span class="nf">get_stress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[bar]&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_stress_file_arr&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cp2k_repack_arr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stress_file_arr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Cp2kMDOutputFile.get_ekin"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kMDOutputFile.get_ekin.html#pwtools.parse.Cp2kMDOutputFile.get_ekin">[docs]</a>    <span class="k">def</span> <span class="nf">get_ekin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[Ha]&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_ener_file_arr&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ener_file_arr</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Cp2kMDOutputFile.get_temperature"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kMDOutputFile.get_temperature.html#pwtools.parse.Cp2kMDOutputFile.get_temperature">[docs]</a>    <span class="k">def</span> <span class="nf">get_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[K]&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_ener_file_arr&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ener_file_arr</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Cp2kMDOutputFile.get_etot"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kMDOutputFile.get_etot.html#pwtools.parse.Cp2kMDOutputFile.get_etot">[docs]</a>    <span class="k">def</span> <span class="nf">get_etot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[Ha]&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_ener_file_arr&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ener_file_arr</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Cp2kMDOutputFile.get_econst"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kMDOutputFile.get_econst.html#pwtools.parse.Cp2kMDOutputFile.get_econst">[docs]</a>    <span class="k">def</span> <span class="nf">get_econst</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[Ha]&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_ener_file_arr&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ener_file_arr</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Cp2kMDOutputFile.get_cell"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kMDOutputFile.get_cell.html#pwtools.parse.Cp2kMDOutputFile.get_cell">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[Ang]&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_cell_file_arr&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cp2k_repack_arr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cell_file_arr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Cp2kMDOutputFile.get_volume"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kMDOutputFile.get_volume.html#pwtools.parse.Cp2kMDOutputFile.get_volume">[docs]</a>    <span class="k">def</span> <span class="nf">get_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[Ang^3]&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_cell_file_arr&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_file_arr</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="Cp2kRelaxOutputFile"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kRelaxOutputFile.html#pwtools.parse.Cp2kRelaxOutputFile">[docs]</a><span class="k">class</span> <span class="nc">Cp2kRelaxOutputFile</span><span class="p">(</span><span class="n">Cp2kMDOutputFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse cp2k global/run_type cell_opt. geo_opt might also work, but not</span>
<span class="sd">    tested yet.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="Cp2kRelaxOutputFile.get_natoms"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kRelaxOutputFile.get_natoms.html#pwtools.parse.Cp2kRelaxOutputFile.get_natoms">[docs]</a>    <span class="k">def</span> <span class="nf">get_natoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos_file</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;head -n1 </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos_file</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">int_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Cp2kRelaxOutputFile.get_etot"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kRelaxOutputFile.get_etot.html#pwtools.parse.Cp2kRelaxOutputFile.get_etot">[docs]</a>    <span class="k">def</span> <span class="nf">get_etot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos_file</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &#39;/i =.*E/ {print $6}&#39; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">AWK</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos_file</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">arr1d_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Cp2kRelaxOutputFile.get_cell"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kRelaxOutputFile.get_cell.html#pwtools.parse.Cp2kRelaxOutputFile.get_cell">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># For cell_opt, cp2k does a final scf calc after the cell optimization.</span>
        <span class="c1"># That creates an additional time step in _pos_file, but NOT in</span>
        <span class="c1"># _cell_file. Then, coords[-1,...] and coords[-2,...] are the same b/c</span>
        <span class="c1"># the final geometry is simply scf&#39;ed again. Also etot is one step</span>
        <span class="c1"># longer. Handle that by appending cell[-1,...] to the end of the cell</span>
        <span class="c1"># array in order to have equal length. Need that to make get_traj()</span>
        <span class="c1"># happy.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_cell_file_arr&#39;</span><span class="p">):</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cp2k_repack_arr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cell_file_arr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assert_set_attr</span><span class="p">(</span><span class="s1">&#39;_run_type&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_type</span> <span class="o">==</span> <span class="s1">&#39;CELL_OPT&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;coords&#39;</span><span class="p">):</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cell</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">cell</span><span class="p">,</span> <span class="n">cell</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">...</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span><span class="o">...</span><span class="p">]),</span>
                                               <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;cell and coords have a timestep &quot;</span>
                            <span class="s2">&quot;offset != 1, dunno what to do &quot;</span>
                            <span class="s2">&quot;(offset=</span><span class="si">{0}</span><span class="s2">, coords: </span><span class="si">{1}</span><span class="s2">, cell: </span><span class="si">{2}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">cell</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="c1"># GEO_OPT not tested yet. Simply return cell for now unchanged, if</span>
            <span class="c1"># defined.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cell</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="DcdOutputFile"><a class="viewcode-back" href="../../generated/api/pwtools.parse.DcdOutputFile.html#pwtools.parse.DcdOutputFile">[docs]</a><span class="k">class</span> <span class="nc">DcdOutputFile</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class which implements dcd file reading. Used only for</span>
<span class="sd">    inheritance.&quot;&quot;&quot;</span>
    <span class="n">_dcd_convang</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_get_dcd_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dcdfilename</span><span class="p">):</span>
            <span class="n">cryst_const</span><span class="p">,</span> <span class="n">coords</span> <span class="o">=</span> <span class="n">dcd</span><span class="o">.</span><span class="n">read_dcd_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dcdfilename</span><span class="p">,</span> <span class="n">convang</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dcd_convang</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;cryst_const&#39;</span><span class="p">:</span> <span class="n">cryst_const</span><span class="p">,</span>
                    <span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="n">coords</span><span class="p">,</span>
                    <span class="s1">&#39;nstep&#39;</span><span class="p">:</span> <span class="n">cryst_const</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s1">&#39;natoms&#39;</span><span class="p">:</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s1">&#39;timestep&#39;</span><span class="p">:</span> <span class="n">dcd</span><span class="o">.</span><span class="n">read_dcd_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dcdfilename</span><span class="p">)[</span><span class="s1">&#39;timestep&#39;</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="DcdOutputFile.get_coords"><a class="viewcode-back" href="../../generated/api/pwtools.parse.DcdOutputFile.get_coords.html#pwtools.parse.DcdOutputFile.get_coords">[docs]</a>    <span class="k">def</span> <span class="nf">get_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_dcd_data&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcd_data</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DcdOutputFile.get_cryst_const"><a class="viewcode-back" href="../../generated/api/pwtools.parse.DcdOutputFile.get_cryst_const.html#pwtools.parse.DcdOutputFile.get_cryst_const">[docs]</a>    <span class="k">def</span> <span class="nf">get_cryst_const</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_dcd_data&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcd_data</span><span class="p">[</span><span class="s1">&#39;cryst_const&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DcdOutputFile.get_natoms"><a class="viewcode-back" href="../../generated/api/pwtools.parse.DcdOutputFile.get_natoms.html#pwtools.parse.DcdOutputFile.get_natoms">[docs]</a>    <span class="k">def</span> <span class="nf">get_natoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_dcd_data&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcd_data</span><span class="p">[</span><span class="s1">&#39;natoms&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DcdOutputFile.get_nstep"><a class="viewcode-back" href="../../generated/api/pwtools.parse.DcdOutputFile.get_nstep.html#pwtools.parse.DcdOutputFile.get_nstep">[docs]</a>    <span class="k">def</span> <span class="nf">get_nstep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_dcd_data&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcd_data</span><span class="p">[</span><span class="s1">&#39;nstep&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1"># Avoid reading PROJECT-1.cell (cp2k) or any other text output (lammps)</span>
    <span class="c1"># with cell info even if it exists. We need to make sure that we read the</span>
    <span class="c1"># unit cell from the dcd file. This is essential in cp2k when using</span>
    <span class="c1"># dcd_aligned_cell.</span>
<div class="viewcode-block" id="DcdOutputFile.get_cell"><a class="viewcode-back" href="../../generated/api/pwtools.parse.DcdOutputFile.get_cell.html#pwtools.parse.DcdOutputFile.get_cell">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DcdOutputFile.get_volume"><a class="viewcode-back" href="../../generated/api/pwtools.parse.DcdOutputFile.get_volume.html#pwtools.parse.DcdOutputFile.get_volume">[docs]</a>    <span class="k">def</span> <span class="nf">get_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="Cp2kDcdMDOutputFile"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kDcdMDOutputFile.html#pwtools.parse.Cp2kDcdMDOutputFile">[docs]</a><span class="k">class</span> <span class="nc">Cp2kDcdMDOutputFile</span><span class="p">(</span><span class="n">DcdOutputFile</span><span class="p">,</span> <span class="n">Cp2kMDOutputFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Same as :class:`Cp2kMDOutputFile` (all ``PROJECT*`` files are text),</span>
<span class="sd">    only that the coordinates file is a dcd format binary file</span>
<span class="sd">    ``PROJECT-pos-1.dcd``.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="Cp2kDcdMDOutputFile.__init__"><a class="viewcode-back" href="../../generated/api/pwtools.parse.Cp2kDcdMDOutputFile.html#pwtools.parse.Cp2kDcdMDOutputFile.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Cp2kDcdMDOutputFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dcdfilename</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">pj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;PROJECT-pos-1.dcd&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dcd_convang</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_lst</span> <span class="o">=</span> <span class="p">[</span>\
            <span class="s1">&#39;cryst_const&#39;</span><span class="p">,</span>
            <span class="s1">&#39;coords&#39;</span><span class="p">,</span>
            <span class="s1">&#39;econst&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ekin&#39;</span><span class="p">,</span>
            <span class="s1">&#39;etot&#39;</span><span class="p">,</span>
            <span class="s1">&#39;forces&#39;</span><span class="p">,</span>
            <span class="s1">&#39;natoms&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stress&#39;</span><span class="p">,</span>
            <span class="s1">&#39;symbols&#39;</span><span class="p">,</span>
            <span class="s1">&#39;temperature&#39;</span><span class="p">,</span>
            <span class="s1">&#39;timestep&#39;</span><span class="p">,</span>
            <span class="s1">&#39;velocity&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_attr_lst</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="LammpsTextMDOutputFile"><a class="viewcode-back" href="../../generated/api/pwtools.parse.LammpsTextMDOutputFile.html#pwtools.parse.LammpsTextMDOutputFile">[docs]</a><span class="k">class</span> <span class="nc">LammpsTextMDOutputFile</span><span class="p">(</span><span class="n">TrajectoryFileParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse LAMMPS text output.</span>

<span class="sd">    We parse the default ``log.lammps`` file (`filename`) with ``thermo``</span>
<span class="sd">    output and, if present, a custom dump file ``lmp.out.dump`` created by</span>
<span class="sd">    something like ``dump 2 all custom 1 lmp.out.dump ...`` Tested with MD and</span>
<span class="sd">    structure optimization (``minimize``).</span>

<span class="sd">    Currently hardcoded file names:</span>
<span class="sd">        | `dumpfilename` = ``basedir/lmp.out.dump``</span>
<span class="sd">        | `symbolsfilename` = ``basedir/lmp.struct.symbols``</span>
<span class="sd">    where `basedir` is the dir where `filename` (i.e. ``log.lammps``) lives.</span>

<span class="sd">    default_units are for lammps metal units.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Example lammps input::</span>

<span class="sd">        clear</span>
<span class="sd">        units metal</span>
<span class="sd">        boundary p p p</span>
<span class="sd">        atom_style atomic</span>

<span class="sd">        read_data lmp.struct</span>

<span class="sd">        ### interactions</span>
<span class="sd">        pair_style tersoff</span>
<span class="sd">        pair_coeff * * AlN.tersoff Al N</span>

<span class="sd">        ### IO</span>
<span class="sd">        dump dump_txt all custom 1 lmp.out.dump id type xsu ysu zsu xu yu zu fx fy fz vx vy vz</span>
<span class="sd">        dump dump_dcd all dcd 1 lmp.out.dcd</span>
<span class="sd">        ##dump dump_xyz all xyz 1 lmp.out.xyz</span>
<span class="sd">        ##dump_modify dump_xyz element Al N</span>
<span class="sd">        dump_modify dump_txt sort id</span>
<span class="sd">        dump_modify dump_dcd sort id unwrap yes</span>
<span class="sd">        thermo_style custom step temp vol cella cellb cellc cellalpha cellbeta cellgamma &amp;</span>
<span class="sd">                            ke pe etotal &amp;</span>
<span class="sd">                            press pxx pyy pzz pxy pxz pyz cpu</span>
<span class="sd">        thermo_modify flush yes</span>
<span class="sd">        thermo 1</span>

<span class="sd">        ### init</span>
<span class="sd">        velocity all create 300.0 123 rot yes dist gaussian</span>

<span class="sd">        ### run</span>
<span class="sd">        fix fix_npt all npt temp 1000 1000 0.01 tri 0 0 0.3 tchain 4 pchain 4 &amp;</span>
<span class="sd">            mtk yes scaleyz no scalexz no scalexy no flip no</span>
<span class="sd">        timestep 2.5e-3</span>
<span class="sd">        run 1000</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    * columns in `filename` and `dumpfilename`: We automagically extract</span>
<span class="sd">      the &quot;header&quot; (e.g. &quot;Step Temp Volume Cella ...&quot; in `filename` or</span>
<span class="sd">      &quot;ITEM: ATOMS id type xsu ysu zsu fx fy fz vx vy vz&quot; in</span>
<span class="sd">      `dumpfilename`) and map data to these symbols. See `_thermo_dct` and</span>
<span class="sd">      `_dump_dct`. Currently, &quot;xsu ysu zsu&quot; is parsed to get</span>
<span class="sd">      coords_frac. &quot;xu yu zu&quot; is parsed to get coords. Wrapped coordinates</span>
<span class="sd">      (e.g. &quot;xs ys zs&quot; and &quot;x y z&quot;) are ignored.</span>
<span class="sd">    * multiple runs from one input script (i.e. 2 or more ``run``</span>
<span class="sd">      commands): it seems that the last step of the preceeding run is</span>
<span class="sd">      printed again by the new run by ``thermo_style``, which results in</span>
<span class="sd">      more `nstep` in `filename` as there really are in `dumpfilename`. We</span>
<span class="sd">      parse all important stuff (coords, cell, velocity) from</span>
<span class="sd">      `dumpfilename`, but `temperature` and `stress` etc. is from</span>
<span class="sd">      `filename`. Watch out when plotting.</span>
<span class="sd">    * cell: We parse cell from &quot;ITEM: BOX BOUNDS&quot; in `dumpfilename` and the</span>
<span class="sd">      cell is always [[x,0,0],[xy,y,0],[xz,yz,z]], i.e. it is aligned in the</span>
<span class="sd">      same way in each timestep.</span>
<span class="sd">    * atom symbols: First we try to read `symbolsfilename`, which may have been</span>
<span class="sd">      written by :func:`pwtools.io.write_lammps`. If that is not found, we try</span>
<span class="sd">      to use the ``type`` column in `dumpfilename` together with a type number</span>
<span class="sd">      -&gt; atom symbol mapping either from the `order` input keyword or a</span>
<span class="sd">      ``dump_modify ... element`` line in `filename` if found.</span>
<span class="sd">      &quot;&quot;&quot;</span>
<div class="viewcode-block" id="LammpsTextMDOutputFile.__init__"><a class="viewcode-back" href="../../generated/api/pwtools.parse.LammpsTextMDOutputFile.html#pwtools.parse.LammpsTextMDOutputFile.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;log.lammps&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Text output file, where ``thermo_style [custom]``</span>
<span class="sd">            output is written to. The lammps default is ``log.lammps``.</span>
<span class="sd">        order : dict, optional</span>
<span class="sd">            See :meth:`pwtools.crys.Structure.get_order`. Mapping of atom</span>
<span class="sd">            symbols to ``type`` in lammps, i.e. {&#39;Al&#39;: 1, &#39;N&#39;: 2}. If None then</span>
<span class="sd">            we try to use ``dump_modify ... element`` if present in `filename`,</span>
<span class="sd">            where lammps echos the input script. `symbols` is build from the</span>
<span class="sd">            ``type`` column in `dumpfilename`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_units</span><span class="p">[</span><span class="s1">&#39;stress&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-4</span>     <span class="c1"># bar -&gt; GPa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_units</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs</span><span class="o">/</span><span class="n">ps</span>  <span class="c1"># Ang/ps -&gt; Ang/fs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_units</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ps</span><span class="o">/</span><span class="n">fs</span>      <span class="c1"># ps -&gt; fs</span>
        <span class="n">TrajectoryFileParser</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_lst</span> <span class="o">=</span> <span class="p">[</span>\
            <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
            <span class="s1">&#39;coords_frac&#39;</span><span class="p">,</span>
            <span class="s1">&#39;coords&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cryst_const&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ekin&#39;</span><span class="p">,</span>
            <span class="s1">&#39;etot&#39;</span><span class="p">,</span>
            <span class="s1">&#39;forces&#39;</span><span class="p">,</span>
            <span class="s1">&#39;natoms&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stress&#39;</span><span class="p">,</span>
            <span class="s1">&#39;symbols&#39;</span><span class="p">,</span>
            <span class="s1">&#39;temperature&#39;</span><span class="p">,</span>
            <span class="s1">&#39;timestep&#39;</span><span class="p">,</span>
            <span class="s1">&#39;velocity&#39;</span><span class="p">,</span>
            <span class="s1">&#39;volume&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_attr_lst</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>
        <span class="c1"># Text output file from ``dump &lt;ID&gt; all custom 1 ...``.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dumpfilename</span> <span class="o">=</span> <span class="n">pj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;lmp.out.dump&#39;</span><span class="p">)</span>
        <span class="c1"># written by io.write_lammps()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbolsfilename</span> <span class="o">=</span> <span class="n">pj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;lmp.struct.symbols&#39;</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_from_dct</span><span class="p">(</span><span class="n">dct</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dct</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_assert_shape_mod</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">a</span> <span class="o">%</span> <span class="n">b</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">: shape mismatch: a: </span><span class="si">{a}</span><span class="s2">, b: </span><span class="si">{b}</span><span class="s2">, &quot;</span>
               <span class="s2">&quot;</span><span class="si">{a}</span><span class="s2"> % </span><span class="si">{b}</span><span class="s2"> = </span><span class="si">{mod}</span><span class="s2">, &quot;</span>
               <span class="s2">&quot;should be 0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span><span class="n">mod</span><span class="o">=</span><span class="n">mod</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">_get_thermo_dct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse all text between &quot;Step ...&quot; and &quot;Loop ...&quot; in self.filename::</span>

<span class="sd">            Step Temp Volume Cella Cellb Cellc</span>
<span class="sd">                   0            0    37.412297            3            3          4.8</span>
<span class="sd">                   1            0     37.42182    3.0002318    3.0002318      4.80048</span>
<span class="sd">                   2            0    37.431339    3.0004633    3.0004633      4.80096</span>
<span class="sd">            ....</span>

<span class="sd">                1000            0    37.431339    3.0004633    3.0004633      4.80096</span>
<span class="sd">            Loop time of 0.115472 on 1 procs (1 MPI x 1 OpenMP) for 1043 steps with 4 atoms</span>

<span class="sd">        This is usually generated by::</span>

<span class="sd">            thermo_style custom step temp vol cella cellb cellc</span>
<span class="sd">            thermo 1</span>

<span class="sd">        in the input file. I think if no ``thermo_style`` command is used, it</span>
<span class="sd">        still prints a line starting with &quot;Step ...&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="s2">&quot;grep -m1 Step </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="c1"># Strip all text except for the data columns. Also works for</span>
            <span class="c1"># multiple ``run`` or ``minimize`` commands in one input file,</span>
            <span class="c1"># which cause wildly mixed text.</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;sed -nre &#39;/^Step/,/^Loop/p&#39; </span><span class="si">%s</span><span class="s2"> | </span><span class="se">\</span>
<span class="s2">                    egrep -v &#39;Step|Loop&#39;&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr2d_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">arr</span><span class="p">[:,</span><span class="n">ii</span><span class="p">])</span> <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">header</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_dump_dct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;natoms&#39;</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dumpfilename</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep -c &#39;ITEM: TIMESTEP&#39; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">dumpfilename</span>
            <span class="n">nstep</span> <span class="o">=</span> <span class="n">nstep_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="s2">&quot;grep -m1 &#39;ITEM: ATOMS&#39; </span><span class="si">%s</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                | sed -re &#39;s/.*TOMS //&#39;&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">dumpfilename</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep -A</span><span class="si">%i</span><span class="s2"> &#39;ITEM: ATOMS&#39; </span><span class="si">%s</span><span class="s2"> | </span><span class="se">\</span>
<span class="s2">                    egrep -ve &#39;--|ITEM&#39;&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumpfilename</span><span class="p">)</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
                                <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nstep</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assert_shape_mod</span><span class="p">(</span><span class="s1">&#39;dump&#39;</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">arr</span><span class="p">[:,</span><span class="n">ii</span><span class="p">])</span> <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">header</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_lmp_dump2arr3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dct</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;natoms&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dct</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="n">nstep</span> <span class="o">=</span> <span class="n">dct</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dct</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                            <span class="n">dct</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                            <span class="n">dct</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">2</span><span class="p">]]])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nstep</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">arr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="LammpsTextMDOutputFile.get_natoms"><a class="viewcode-back" href="../../generated/api/pwtools.parse.LammpsTextMDOutputFile.get_natoms.html#pwtools.parse.LammpsTextMDOutputFile.get_natoms">[docs]</a>    <span class="k">def</span> <span class="nf">get_natoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dumpfilename</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep -A1 -m1 &#39;ITEM: NUMBER OF ATOMS&#39; </span><span class="si">%s</span><span class="s2"> | tail -n1&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">dumpfilename</span>
            <span class="k">return</span> <span class="n">nstep_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LammpsTextMDOutputFile.get_stress"><a class="viewcode-back" href="../../generated/api/pwtools.parse.LammpsTextMDOutputFile.get_stress.html#pwtools.parse.LammpsTextMDOutputFile.get_stress">[docs]</a>    <span class="k">def</span> <span class="nf">get_stress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_thermo_dct&#39;</span><span class="p">):</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="s1">&#39;Pxx Pyy Pzz Pxy Pxz Pyz&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thermo_dct</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="n">voigt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_thermo_dct</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="o">+</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;xx&#39;</span><span class="p">,</span> <span class="s1">&#39;yy&#39;</span><span class="p">,</span>
                <span class="s1">&#39;zz&#39;</span><span class="p">,</span> <span class="s1">&#39;yz&#39;</span><span class="p">,</span> <span class="s1">&#39;xz&#39;</span><span class="p">,</span> <span class="s1">&#39;xy&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">return</span> <span class="n">crys</span><span class="o">.</span><span class="n">voigt2tensor3d</span><span class="p">(</span><span class="n">voigt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LammpsTextMDOutputFile.get_etot"><a class="viewcode-back" href="../../generated/api/pwtools.parse.LammpsTextMDOutputFile.get_etot.html#pwtools.parse.LammpsTextMDOutputFile.get_etot">[docs]</a>    <span class="k">def</span> <span class="nf">get_etot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Potetntial energy PotEng [eV]. etot+ekin here is</span>
<span class="sd">        TotEng=PotEng+KinEng in lammps. In DFT, the potential energy is usually</span>
<span class="sd">        called &quot;total energy&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_thermo_dct&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_from_dct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thermo_dct</span><span class="p">,</span> <span class="s1">&#39;PotEng&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LammpsTextMDOutputFile.get_ekin"><a class="viewcode-back" href="../../generated/api/pwtools.parse.LammpsTextMDOutputFile.get_ekin.html#pwtools.parse.LammpsTextMDOutputFile.get_ekin">[docs]</a>    <span class="k">def</span> <span class="nf">get_ekin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_thermo_dct&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_from_dct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thermo_dct</span><span class="p">,</span> <span class="s1">&#39;KinEng&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LammpsTextMDOutputFile.get_temperature"><a class="viewcode-back" href="../../generated/api/pwtools.parse.LammpsTextMDOutputFile.get_temperature.html#pwtools.parse.LammpsTextMDOutputFile.get_temperature">[docs]</a>    <span class="k">def</span> <span class="nf">get_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_thermo_dct&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_from_dct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thermo_dct</span><span class="p">,</span> <span class="s1">&#39;Temp&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LammpsTextMDOutputFile.get_volume"><a class="viewcode-back" href="../../generated/api/pwtools.parse.LammpsTextMDOutputFile.get_volume.html#pwtools.parse.LammpsTextMDOutputFile.get_volume">[docs]</a>    <span class="k">def</span> <span class="nf">get_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_thermo_dct&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_from_dct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thermo_dct</span><span class="p">,</span> <span class="s1">&#39;Volume&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LammpsTextMDOutputFile.get_cryst_const"><a class="viewcode-back" href="../../generated/api/pwtools.parse.LammpsTextMDOutputFile.get_cryst_const.html#pwtools.parse.LammpsTextMDOutputFile.get_cryst_const">[docs]</a>    <span class="k">def</span> <span class="nf">get_cryst_const</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_thermo_dct&#39;</span><span class="p">):</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="s1">&#39;Cella Cellb Cellc CellAlpha CellBeta CellGamma&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thermo_dct</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="n">nstep</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thermo_dct</span><span class="p">[</span><span class="s1">&#39;Cella&#39;</span><span class="p">])</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nstep</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
                <span class="n">ret</span><span class="p">[:,</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thermo_dct</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">ret</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LammpsTextMDOutputFile.get_coords_frac"><a class="viewcode-back" href="../../generated/api/pwtools.parse.LammpsTextMDOutputFile.get_coords_frac.html#pwtools.parse.LammpsTextMDOutputFile.get_coords_frac">[docs]</a>    <span class="k">def</span> <span class="nf">get_coords_frac</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_dump_dct&#39;</span><span class="p">):</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="s1">&#39;xsu ysu zsu&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lmp_dump2arr3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dump_dct</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LammpsTextMDOutputFile.get_coords"><a class="viewcode-back" href="../../generated/api/pwtools.parse.LammpsTextMDOutputFile.get_coords.html#pwtools.parse.LammpsTextMDOutputFile.get_coords">[docs]</a>    <span class="k">def</span> <span class="nf">get_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_dump_dct&#39;</span><span class="p">):</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="s1">&#39;xu yu zu&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lmp_dump2arr3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dump_dct</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LammpsTextMDOutputFile.get_forces"><a class="viewcode-back" href="../../generated/api/pwtools.parse.LammpsTextMDOutputFile.get_forces.html#pwtools.parse.LammpsTextMDOutputFile.get_forces">[docs]</a>    <span class="k">def</span> <span class="nf">get_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_dump_dct&#39;</span><span class="p">):</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="s1">&#39;fx fy fz&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lmp_dump2arr3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dump_dct</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LammpsTextMDOutputFile.get_velocity"><a class="viewcode-back" href="../../generated/api/pwtools.parse.LammpsTextMDOutputFile.get_velocity.html#pwtools.parse.LammpsTextMDOutputFile.get_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">get_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr</span><span class="p">(</span><span class="s1">&#39;_dump_dct&#39;</span><span class="p">):</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="s1">&#39;vx vy vz&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lmp_dump2arr3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dump_dct</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LammpsTextMDOutputFile.get_timestep"><a class="viewcode-back" href="../../generated/api/pwtools.parse.LammpsTextMDOutputFile.get_timestep.html#pwtools.parse.LammpsTextMDOutputFile.get_timestep">[docs]</a>    <span class="k">def</span> <span class="nf">get_timestep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep -m1 timestep </span><span class="si">%s</span><span class="s2"> | </span><span class="se">\</span>
<span class="s2">                    sed -re &#39;s/.*step (.*)/\1/&#39;&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
            <span class="k">return</span> <span class="n">float_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LammpsTextMDOutputFile.get_symbols"><a class="viewcode-back" href="../../generated/api/pwtools.parse.LammpsTextMDOutputFile.get_symbols.html#pwtools.parse.LammpsTextMDOutputFile.get_symbols">[docs]</a>    <span class="k">def</span> <span class="nf">get_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbolsfilename</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="n">file_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbolsfilename</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set_attr_lst</span><span class="p">([</span><span class="s1">&#39;_dump_dct&#39;</span><span class="p">,</span><span class="s1">&#39;natoms&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dump_dct</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                   <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep -m1 &#39;dump_modify.*element&#39; </span><span class="si">%s</span><span class="s2"> | sed -re </span><span class="se">\</span>
<span class="s2">                           &#39;s/.*ment (.*)/\1/&#39;&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
                   <span class="n">revorder</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">sy</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">sy</span> <span class="ow">in</span> \
                              <span class="nb">enumerate</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># {&#39;a&#39;:1,&#39;b&#39;:2} -&gt; {1:&#39;a&#39;,2:&#39;b&#39;}</span>
                    <span class="n">revorder</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">revorder</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ii</span><span class="p">)]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dump_dct</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">][:</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LammpsTextMDOutputFile.get_cell"><a class="viewcode-back" href="../../generated/api/pwtools.parse.LammpsTextMDOutputFile.get_cell.html#pwtools.parse.LammpsTextMDOutputFile.get_cell">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dumpfilename</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep -c &#39;ITEM: BOX BOUNDS&#39; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">dumpfilename</span>
            <span class="n">nstep</span> <span class="o">=</span> <span class="n">nstep_from_txt</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;grep -A3 &#39;ITEM: BOX BOUNDS&#39; </span><span class="si">%s</span><span class="s2"> | </span><span class="se">\</span>
<span class="s2">                    egrep -ve &#39;--|ITEM&#39;&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">dumpfilename</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">backtick</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nstep</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nstep</span><span class="p">):</span>
                <span class="n">xlo_bound</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">xhi_bound</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">ylo_bound</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">yhi_bound</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">zlo</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">zhi</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">xy</span> <span class="o">=</span>  <span class="n">arr</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">xz</span> <span class="o">=</span>  <span class="n">arr</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">yz</span> <span class="o">=</span>  <span class="n">arr</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">xlo</span> <span class="o">=</span> <span class="n">xlo_bound</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">xy</span><span class="p">,</span><span class="n">xz</span><span class="p">,</span><span class="n">xy</span><span class="o">+</span><span class="n">xz</span><span class="p">)</span>
                <span class="n">xhi</span> <span class="o">=</span> <span class="n">xhi_bound</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">xy</span><span class="p">,</span><span class="n">xz</span><span class="p">,</span><span class="n">xy</span><span class="o">+</span><span class="n">xz</span><span class="p">)</span>
                <span class="n">ylo</span> <span class="o">=</span> <span class="n">ylo_bound</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">yz</span><span class="p">)</span>
                <span class="n">yhi</span> <span class="o">=</span> <span class="n">yhi_bound</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">yz</span><span class="p">)</span>
                <span class="c1"># [[x,  0,  0],</span>
                <span class="c1">#  [xy, y,  0],</span>
                <span class="c1">#  [xz, yz, z]]</span>
                <span class="n">cell</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xhi</span><span class="o">-</span><span class="n">xlo</span>
                <span class="n">cell</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhi</span><span class="o">-</span><span class="n">ylo</span>
                <span class="n">cell</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">zhi</span><span class="o">-</span><span class="n">zlo</span>
                <span class="n">cell</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy</span>
                <span class="n">cell</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz</span>
                <span class="n">cell</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">yz</span>
            <span class="k">return</span> <span class="n">cell</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="LammpsDcdMDOutputFile"><a class="viewcode-back" href="../../generated/api/pwtools.parse.LammpsDcdMDOutputFile.html#pwtools.parse.LammpsDcdMDOutputFile">[docs]</a><span class="k">class</span> <span class="nc">LammpsDcdMDOutputFile</span><span class="p">(</span><span class="n">DcdOutputFile</span><span class="p">,</span> <span class="n">LammpsTextMDOutputFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse Lammps DCD binary output + ``log.lammps`` text output.</span>

<span class="sd">    Hardcodes files:</span>
<span class="sd">        | `dcdfilename` = ``basedir/lmp.out.dcd``</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    * cell: The DCD file format stores only cryst_const (see ``unitcell`` in</span>
<span class="sd">      dcd.f90). ``Trajectory.cell`` calculated from ``Trajectory.cryst_const``</span>
<span class="sd">      is aligned in the same way as ``LammpsTextMDOutputFile.cell``. That&#39;s why</span>
<span class="sd">      the cell and cryst_const obtained from</span>
<span class="sd">      :func:`~pwtools.io.read_lammps_md_dcd()` and</span>
<span class="sd">      :func:`~pwtools.io.read_lammps_md_txt()` must be identical up to</span>
<span class="sd">      numerical noise (about 1e-6 for default lammps text printing precision).</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="LammpsDcdMDOutputFile.__init__"><a class="viewcode-back" href="../../generated/api/pwtools.parse.LammpsDcdMDOutputFile.html#pwtools.parse.LammpsDcdMDOutputFile.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LammpsDcdMDOutputFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_lst</span> <span class="o">=</span> <span class="p">[</span>\
            <span class="s1">&#39;cryst_const&#39;</span><span class="p">,</span>
            <span class="s1">&#39;coords&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ekin&#39;</span><span class="p">,</span>
            <span class="s1">&#39;etot&#39;</span><span class="p">,</span>
            <span class="s1">&#39;natoms&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stress&#39;</span><span class="p">,</span>
            <span class="s1">&#39;symbols&#39;</span><span class="p">,</span>
            <span class="s1">&#39;temperature&#39;</span><span class="p">,</span>
            <span class="s1">&#39;timestep&#39;</span><span class="p">,</span>
            <span class="s1">&#39;volume&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_attr_lst</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dcd_convang</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dcdfilename</span> <span class="o">=</span> <span class="n">pj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;lmp.out.dcd&#39;</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2021, Steve Schmerler.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>